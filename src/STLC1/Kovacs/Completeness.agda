module STLC1.Kovacs.Completeness where

open import STLC1.Kovacs.Normalisation public
open import STLC1.Kovacs.Convertibility public


--------------------------------------------------------------------------------


-- (_â‰ˆ_)
infix 3 _â‰«_
_â‰«_ : âˆ€ {A Î“} â†’ Î“ âŠ¢ A â†’ Î“ âŠ© A â†’ Set

_â‰«_ {âµ}      {Î“} M N = M âˆ¼ embâ¿á¶  N

_â‰«_ {A â‡’ B} {Î“} M f = âˆ€ {Î“â€²} â†’ (Î· : Î“â€² âŠ‡ Î“) {N : Î“â€² âŠ¢ A} {a : Î“â€² âŠ© A}
                                 (p : N â‰« a)
                              â†’ ren Î· M âˆ™ N â‰« f Î· a

_â‰«_ {A â©• B}  {Î“} M s = Ï€â‚ M â‰« projâ‚ s Ã— Ï€â‚‚ M â‰« projâ‚‚ s

_â‰«_ {â«ª}     {Î“} M s = âŠ¤


-- (_â‰ˆá¶œ_)
infix 3 _â‰«â‹†_
data _â‰«â‹†_ : âˆ€ {Î“ Î} â†’ Î“ âŠ¢â‹† Î â†’ Î“ âŠ©â‹† Î â†’ Set
  where
    âˆ…   : âˆ€ {Î“} â†’ âˆ… {Î“ = Î“} â‰«â‹† âˆ…

    _,_ : âˆ€ {Î“ Î A} â†’ {Ïƒ : Î“ âŠ¢â‹† Î} {Ï : Î“ âŠ©â‹† Î} {M : Î“ âŠ¢ A} {a : Î“ âŠ© A}
                    â†’ (Ï‡ : Ïƒ â‰«â‹† Ï) (p : M â‰« a)
                    â†’ Ïƒ , M â‰«â‹† Ï , a


--------------------------------------------------------------------------------


-- (_âˆ¼â—¾â‰ˆ_)
coeâ‰« : âˆ€ {A Î“} â†’ {Mâ‚ Mâ‚‚ : Î“ âŠ¢ A} {a : Î“ âŠ© A}
               â†’ Mâ‚ âˆ¼ Mâ‚‚ â†’ Mâ‚ â‰« a
               â†’ Mâ‚‚ â‰« a
coeâ‰« {âµ}      p q = p â»Â¹ â¦™ q
coeâ‰« {A â‡’ B} p f = Î» Î· q â†’
                      coeâ‰« (renâˆ¼ Î· p âˆ™âˆ¼ reflâˆ¼)
                           (f Î· q)
coeâ‰« {A â©• B}  p q = coeâ‰« (Ï€â‚âˆ¼ p) (projâ‚ q) , coeâ‰« (Ï€â‚‚âˆ¼ p) (projâ‚‚ q)
coeâ‰« {â«ª}     p q = tt


--------------------------------------------------------------------------------


-- (â‰ˆâ‚‘)
accâ‰« : âˆ€ {A Î“ Î“â€²} â†’ (Î· : Î“â€² âŠ‡ Î“)
                  â†’ {M : Î“ âŠ¢ A} {a : Î“ âŠ© A}
                  â†’ M â‰« a
                  â†’ ren Î· M â‰« acc Î· a
accâ‰« {âµ}      Î· {M} {N} p = coe ((Î» Nâ€² â†’ ren Î· M âˆ¼ Nâ€²) & (natembâ¿á¶  Î· N â»Â¹))
                                (renâˆ¼ Î· p)
accâ‰« {A â‡’ B} Î· {M} {f} g Î·â€²
                          rewrite renâ—‹ Î·â€² Î· M â»Â¹
                          = g (Î· â—‹ Î·â€²)
accâ‰« {A â©• B}  Î· {M} {s} q = accâ‰« Î· (projâ‚ q) , accâ‰« Î· (projâ‚‚ q)
accâ‰« {â«ª}     Î· {M} {s} q = tt


-- (â‰ˆá¶œâ‚‘)
-- NOTE: _â¬–â‰«_ = âˆ‚accâ‰«â‹†
_â¬–â‰«_ : âˆ€ {Î“ Î“â€² Î} â†’ {Ïƒ : Î“ âŠ¢â‹† Î} {Ï : Î“ âŠ©â‹† Î}
                  â†’ (Ï‡ : Ïƒ â‰«â‹† Ï) (Î· : Î“â€² âŠ‡ Î“)
                  â†’ Ïƒ â— Î· â‰«â‹† Ï â¬– Î·
âˆ…       â¬–â‰« Î· = âˆ…
(Ï‡ , p) â¬–â‰« Î· = Ï‡ â¬–â‰« Î· , accâ‰« Î· p


--------------------------------------------------------------------------------


-- (âˆˆâ‰ˆ)
getâ‰« : âˆ€ {Î“ Î A} â†’ {Ïƒ : Î“ âŠ¢â‹† Î} {Ï : Î“ âŠ©â‹† Î}
                 â†’ Ïƒ â‰«â‹† Ï â†’ (i : Î âˆ‹ A)
                 â†’ getâ‚› Ïƒ i â‰« getáµ¥ Ï i
getâ‰« (Ï‡ , p) zero    = p
getâ‰« (Ï‡ , p) (suc i) = getâ‰« Ï‡ i


-- (Tmâ‰ˆ)
evalâ‰« : âˆ€ {Î“ Î A} â†’ {Ïƒ : Î“ âŠ¢â‹† Î} {Ï : Î“ âŠ©â‹† Î}
                  â†’ Ïƒ â‰«â‹† Ï â†’ (M : Î âŠ¢ A)
                  â†’ sub Ïƒ M â‰« eval Ï M

evalâ‰« Ï‡ (ğ“‹ i)
  = getâ‰« Ï‡ i

evalâ‰« {Ïƒ = Ïƒ} Ï‡ (Æ› M) Î· {N} q
  = coeâ‰« (coe (((Æ› (ren (liftâ‚‘ Î·) (sub (liftâ‚› Ïƒ) M)) âˆ™ N) âˆ¼_)
               & ( subâ—‘ (idâ‚› , N) (liftâ‚‘ Î·) (sub (liftâ‚› Ïƒ) M) â»Â¹
                 â¦™ subâ— (liftâ‚‘ Î· â—‘ (idâ‚› , N)) (liftâ‚› Ïƒ) M â»Â¹
                 â¦™ (Î» Ïƒâ€² â†’ sub (Ïƒâ€² , N) M)
                   & ( compâ—â—‘ (Î· â—‘ idâ‚› , N) (wkâ‚‘ idâ‚‘) Ïƒ
                     â¦™ (Ïƒ â—_) & lidâ—‘ (Î· â—‘ idâ‚›)
                     â¦™ compâ—â—‘ idâ‚› Î· Ïƒ â»Â¹
                     â¦™ ridâ— (Ïƒ â— Î·)
                     )
                 ))
              (redâ‡’ (ren (liftâ‚‘ Î·) (sub (liftâ‚› Ïƒ) M)) N) â»Â¹)
         (evalâ‰« (Ï‡ â¬–â‰« Î· , q) M)

evalâ‰« {Ïƒ = Ïƒ} Ï‡ (M âˆ™ N)
  rewrite idren (sub Ïƒ M) â»Â¹
  = evalâ‰« Ï‡ M idâ‚‘ (evalâ‰« Ï‡ N)

evalâ‰« {Ïƒ = Ïƒ} Ï‡ (M , N)
  = coeâ‰« (redâ©•â‚ (sub Ïƒ M) (sub Ïƒ N) â»Â¹) (evalâ‰« Ï‡ M)
  , coeâ‰« (redâ©•â‚‚ (sub Ïƒ M) (sub Ïƒ N) â»Â¹âˆ¼) (evalâ‰« Ï‡ N)

evalâ‰« {Ïƒ = Ïƒ} Ï‡ (Ï€â‚ M)
  = projâ‚ (evalâ‰« Ï‡ M)

evalâ‰« {Ïƒ = Ïƒ} Ï‡ (Ï€â‚‚ M)
  = projâ‚‚ (evalâ‰« Ï‡ M)

evalâ‰« {Ïƒ = Ïƒ} Ï‡ Ï„
  = tt


--------------------------------------------------------------------------------


mutual
  -- (qâ‰ˆ)
  reifyâ‰« : âˆ€ {A Î“} â†’ {M : Î“ âŠ¢ A} {a : Î“ âŠ© A}
                   â†’ (p : M â‰« a)
                   â†’ M âˆ¼ embâ¿á¶  (reify a)
  reifyâ‰« {âµ}      {M = M} p = p
  reifyâ‰« {A â‡’ B} {M = M} f = expâ‡’ M
                            â¦™ Æ›âˆ¼ (reifyâ‰« (f (wkâ‚‘ idâ‚‘) (reflectâ‰« 0)))
  reifyâ‰« {A â©• B}  {M = M} s = expâ©• M
                            â¦™ reifyâ‰« (projâ‚ s) ,âˆ¼ reifyâ‰« (projâ‚‚ s)
  reifyâ‰« {â«ª}     {M = M} s = expâ«ª M

  -- (uâ‰ˆ)
  reflectâ‰« : âˆ€ {A Î“} â†’ (M : Î“ âŠ¢â¿áµ‰ A)
                     â†’ embâ¿áµ‰ M â‰« reflect M
  reflectâ‰« {âµ}      M = reflâˆ¼
  reflectâ‰« {A â‡’ B} M Î· {N} {a} p
                      rewrite natembâ¿áµ‰ Î· M â»Â¹
                      = coeâ‰« (reflâˆ¼ âˆ™âˆ¼ reifyâ‰« p â»Â¹)
                             (reflectâ‰« (renâ¿áµ‰ Î· M âˆ™ reify a))
  reflectâ‰« {A â©• B}  M = reflectâ‰« (Ï€â‚ M) , reflectâ‰« (Ï€â‚‚ M)
  reflectâ‰« {â«ª}     M = tt


-- (uá¶œâ‰ˆ)
idâ‰«â‹† : âˆ€ {Î“} â†’ idâ‚› {Î“} â‰«â‹† idáµ¥
idâ‰«â‹† {âˆ…}     = âˆ…
idâ‰«â‹† {Î“ , A} = idâ‰«â‹† â¬–â‰« wkâ‚‘ idâ‚‘ , reflectâ‰« 0


complete : âˆ€ {Î“ A} â†’ (M : Î“ âŠ¢ A)
                   â†’ M âˆ¼ embâ¿á¶  (nf M)
complete M = coe ((_âˆ¼ embâ¿á¶  (reify (eval idáµ¥ M))) & idsub M)
                 (reifyâ‰« (evalâ‰« idâ‰«â‹† M))


--------------------------------------------------------------------------------
