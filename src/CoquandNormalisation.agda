{-# OPTIONS --no-positivity-check #-}

module CoquandNormalisation where

open import CoquandSubstitution public


record ğ” : Setâ‚ where
  field
    ğ’²      : Set

    ğ’¢      : ğ’² â†’ Set

    _âŠ’_    : ğ’² â†’ ğ’² â†’ Set

    idâ‚    : âˆ€ {w} â†’ w âŠ’ w

    _â–¡_    : âˆ€ {w wâ€² wâ€³} â†’ wâ€³ âŠ’ wâ€² â†’ wâ€² âŠ’ w â†’ wâ€³ âŠ’ w

    idâ‚â–¡   : âˆ€ {w wâ€²} â†’ (Î¾ : wâ€² âŠ’ w)
                      â†’ idâ‚ â–¡ Î¾ â‰¡ Î¾

    idâ‚‚â–¡   : âˆ€ {w wâ€²} â†’ (Î¾ : wâ€² âŠ’ w)
                      â†’ Î¾ â–¡ idâ‚ â‰¡ Î¾

    assocâ–¡ : âˆ€ {w wâ€² wâ€³ wâ€´} â†’ (Î¾â‚ : wâ€´ âŠ’ wâ€³) (Î¾â‚‚ : wâ€³ âŠ’ wâ€²) (Î¾â‚ƒ : wâ€² âŠ’ w)
                            â†’ Î¾â‚ â–¡ (Î¾â‚‚ â–¡ Î¾â‚ƒ) â‰¡ (Î¾â‚ â–¡ Î¾â‚‚) â–¡ Î¾â‚ƒ


--------------------------------------------------------------------------------


module _ {{ğ”ª : ğ”}} where
  open ğ” ğ”ª

  infix 3 _âŠ©_
  data _âŠ©_ : ğ’² â†’ ğ’¯ â†’ Set
    where
      âŸ¦GâŸ§ : âˆ€ {w} â†’ (h : âˆ€ {wâ€²} â†’ (Î¾ : wâ€² âŠ’ w)
                                 â†’ ğ’¢ wâ€²)
                  â†’ w âŠ© âµ

      âŸ¦Æ›âŸ§ : âˆ€ {A B w} â†’ (h : âˆ€ {wâ€²} â†’ (Î¾ : wâ€² âŠ’ w) (a : wâ€² âŠ© A)
                                     â†’ wâ€² âŠ© B)
                      â†’ w âŠ© A âŠƒ B

  âŸ¦gâŸ§âŸ¨_âŸ© : âˆ€ {w wâ€²} â†’ wâ€² âŠ’ w â†’ w âŠ© âµ â†’ ğ’¢ wâ€²
  âŸ¦gâŸ§âŸ¨ Î¾ âŸ© (âŸ¦GâŸ§ f) = f Î¾

  _â—âŸ¨_âŸ©_ : âˆ€ {A B w wâ€²} â†’ w âŠ© A âŠƒ B â†’ wâ€² âŠ’ w â†’ wâ€² âŠ© A â†’ wâ€² âŠ© B
  (âŸ¦Æ›âŸ§ f) â—âŸ¨ Î¾ âŸ© a = f Î¾ a

  -- âŸ¦putáµ£âŸ§ canâ€™t be stated here
  -- âŸ¦getáµ£âŸ§ canâ€™t be stated here
  -- âŸ¦wkáµ£âŸ§ canâ€™t be stated here
  -- âŸ¦liftáµ£âŸ§ canâ€™t be stated here
  -- idâ‚ = âŸ¦idáµ£âŸ§

  -- acc = âŸ¦renâŸ§
  acc : âˆ€ {A w wâ€²} â†’ wâ€² âŠ’ w â†’ w âŠ© A â†’ wâ€² âŠ© A
  acc {âµ}     Î¾ f = âŸ¦GâŸ§ (Î» Î¾â€²   â†’ âŸ¦gâŸ§âŸ¨ Î¾â€² â–¡ Î¾ âŸ© f)
  acc {A âŠƒ B} Î¾ f = âŸ¦Æ›âŸ§ (Î» Î¾â€² a â†’ f â—âŸ¨ Î¾â€² â–¡ Î¾ âŸ© a)

  -- âŸ¦wkâŸ§ canâ€™t be stated here
  -- _â–¡_ = _âŸ¦â—‹âŸ§_


--------------------------------------------------------------------------------


module _ {{ğ”ª : ğ”}} where
  open ğ” ğ”ª

  mutual
    data Eq : âˆ€ {A w} â†’ w âŠ© A â†’ w âŠ© A â†’ Set
      where
        eqâµ : âˆ€ {w} â†’ {f fâ€² : w âŠ© âµ}
                    â†’ (h : âˆ€ {wâ€²} â†’ (Î¾ : wâ€² âŠ’ w)
                                   â†’ âŸ¦gâŸ§âŸ¨ Î¾ âŸ© f â‰¡ âŸ¦gâŸ§âŸ¨ Î¾ âŸ© fâ€²)
                    â†’ Eq f fâ€²

        eqâŠƒ : âˆ€ {A B w} â†’ {f fâ€² : w âŠ© A âŠƒ B}
                        â†’ (h : âˆ€ {wâ€²} â†’ (Î¾ : wâ€² âŠ’ w) {a : wâ€² âŠ© A} (u : Un a)
                                       â†’ Eq (f â—âŸ¨ Î¾ âŸ© a) (fâ€² â—âŸ¨ Î¾ âŸ© a))
                        â†’ Eq f fâ€²

    data Un : âˆ€ {A w} â†’ w âŠ© A â†’ Set
      where
        unâµ : âˆ€ {w} â†’ {f : w âŠ© âµ}
                    â†’ Un f

        unâŠƒ : âˆ€ {A B w} â†’ {f : w âŠ© A âŠƒ B}
                        â†’ (hâ‚ : âˆ€ {wâ€²} â†’ (Î¾ : wâ€² âŠ’ w) {a : wâ€² âŠ© A} (u : Un a)
                                        â†’ Un (f â—âŸ¨ Î¾ âŸ© a))
                        â†’ (hâ‚‚ : âˆ€ {wâ€²} â†’ (Î¾ : wâ€² âŠ’ w) {a aâ€² : wâ€² âŠ© A} (e : Eq a aâ€²) (uâ‚ : Un a) (uâ‚‚ : Un aâ€²)
                                        â†’ Eq (f â—âŸ¨ Î¾ âŸ© a) (f â—âŸ¨ Î¾ âŸ© aâ€²))
                        â†’ (hâ‚ƒ : âˆ€ {wâ€² wâ€³} â†’ (Î¾â‚ : wâ€³ âŠ’ wâ€²) (Î¾â‚‚ : wâ€² âŠ’ w) {a : wâ€² âŠ© A} (u : Un a)
                                           â†’ Eq (acc Î¾â‚ (f â—âŸ¨ Î¾â‚‚ âŸ© a)) (f â—âŸ¨ Î¾â‚ â–¡ Î¾â‚‚ âŸ© (acc Î¾â‚ a)))
                        â†’ Un f

  reflEq : âˆ€ {A w} â†’ {a : w âŠ© A}
                   â†’ Un a
                   â†’ Eq a a
  reflEq unâµ            = eqâµ (Î» Î¾   â†’ refl)
  reflEq (unâŠƒ hâ‚ hâ‚‚ hâ‚ƒ) = eqâŠƒ (Î» Î¾ u â†’ reflEq (hâ‚ Î¾ u))

  symEq : âˆ€ {A w} â†’ {a aâ€² : w âŠ© A}
                  â†’ Eq a aâ€²
                  â†’ Eq aâ€² a
  symEq {âµ}     (eqâµ h) = eqâµ (Î» Î¾   â†’ sym (h Î¾))
  symEq {A âŠƒ B} (eqâŠƒ h) = eqâŠƒ (Î» Î¾ u â†’ symEq (h Î¾ u))

  transEq : âˆ€ {A w} â†’ {a aâ€² aâ€³ : w âŠ© A}
                    â†’ Eq a aâ€² â†’ Eq aâ€² aâ€³
                    â†’ Eq a aâ€³
  transEq {âµ}     (eqâµ hâ‚) (eqâµ hâ‚‚) = eqâµ (Î» Î¾   â†’ trans (hâ‚ Î¾) (hâ‚‚ Î¾))
  transEq {A âŠƒ B} (eqâŠƒ hâ‚) (eqâŠƒ hâ‚‚) = eqâŠƒ (Î» Î¾ u â†’ transEq (hâ‚ Î¾ u) (hâ‚‚ Î¾ u))


  â‰¡â†’Eq : âˆ€ {A w} â†’ {a aâ€² : w âŠ© A} â†’ a â‰¡ aâ€² â†’ Un a â†’ Eq a aâ€²
  â‰¡â†’Eq refl u = reflEq u

  module Eq-Reasoning where
    infix 1 begin_
    begin_ : âˆ€ {A w} â†’ {a aâ€² : w âŠ© A} â†’ Eq a aâ€² â†’ Eq a aâ€²
    begin e = e

    infixr 2 _EqâŸ¨âŸ©_
    _EqâŸ¨âŸ©_ : âˆ€ {A w} â†’ (a {aâ€²} : w âŠ© A) â†’ Eq a aâ€² â†’ Eq a aâ€²
    a EqâŸ¨âŸ© e = e

    infixr 2 _EqâŸ¨_âŸ©_
    _EqâŸ¨_âŸ©_ : âˆ€ {A w} â†’ (a {aâ€² aâ€³} : w âŠ© A) â†’ Eq a aâ€² â†’ Eq aâ€² aâ€³ â†’ Eq a aâ€³
    a EqâŸ¨ eâ‚ âŸ© eâ‚‚ = transEq eâ‚ eâ‚‚

    infixr 2 _â‰¡âŸ¨âŸ©_
    _â‰¡âŸ¨âŸ©_ : âˆ€ {A w} â†’ (a {aâ€²} : w âŠ© A) â†’ Eq a aâ€² â†’ Eq a aâ€²
    a â‰¡âŸ¨âŸ© e = e

    infixr 2 _â‰¡âŸ¨_âˆ£_âŸ©_
    _â‰¡âŸ¨_âˆ£_âŸ©_ : âˆ€ {A w} â†’ (a {aâ€² aâ€³} : w âŠ© A) â†’ a â‰¡ aâ€² â†’ Un a â†’ Eq aâ€² aâ€³ â†’ Eq a aâ€³
    a â‰¡âŸ¨ eâ‚ âˆ£ u âŸ© eâ‚‚ = transEq (â‰¡â†’Eq eâ‚ u) eâ‚‚

    infix 3 _âˆâŸ¨_âŸ©
    _âˆâŸ¨_âŸ© : âˆ€ {A w} â†’ (a : w âŠ© A) â†’ Un a â†’ Eq a a
    a âˆâŸ¨ u âŸ© = reflEq u


--------------------------------------------------------------------------------


module _ {{ğ”ª : ğ”}} where
  open ğ” ğ”ª

  -- (congâ—âŸ¨_âŸ©Eq)
  postulate
    congâ—Eq : âˆ€ {A B w wâ€²} â†’ {f fâ€² : w âŠ© A âŠƒ B} {a aâ€² : wâ€² âŠ© A}
                           â†’ (Î¾ : wâ€² âŠ’ w) â†’ Eq f fâ€² â†’ Un f â†’ Un fâ€² â†’ Eq a aâ€² â†’ Un a â†’ Un aâ€²
                           â†’ Eq (f â—âŸ¨ Î¾ âŸ© a)
                                 (fâ€² â—âŸ¨ Î¾ âŸ© aâ€²)

  congâ—Un : âˆ€ {A B w wâ€²} â†’ {f : w âŠ© A âŠƒ B} {a : wâ€² âŠ© A}
                         â†’ (Î¾ : wâ€² âŠ’ w) â†’ Un f â†’ Un a
                         â†’ Un (f â—âŸ¨ Î¾ âŸ© a)
  congâ—Un Î¾ (unâŠƒ hâ‚ hâ‚‚ hâ‚ƒ) u = hâ‚ Î¾ u

  -- (congâ†‘âŸ¨_âŸ©Eq)
  postulate
    congaccEq : âˆ€ {A w wâ€²} â†’ {a aâ€² : w âŠ© A}
                           â†’ (Î¾ : wâ€² âŠ’ w) â†’ Eq a aâ€²
                           â†’ Eq (acc Î¾ a) (acc Î¾ aâ€²)

  -- (congâ†‘âŸ¨_âŸ©ğ’°)
  postulate
    congaccUn : âˆ€ {A w wâ€²} â†’ {a : w âŠ© A}
                           â†’ (Î¾ : wâ€² âŠ’ w) â†’ Un a
                           â†’ Un (acc Î¾ a)

  -- (auxâ‚„â‚â‚)
  postulate
    idâ‚accEq : âˆ€ {A w} â†’ {a : w âŠ© A}
                       â†’ Un a
                       â†’ Eq (acc idâ‚ a) a

  -- (auxâ‚„â‚â‚‚)
  postulate
    accâ–¡Eq : âˆ€ {A w wâ€² wâ€³} â†’ {a : w âŠ© A}
                           â†’ (Î¾â‚ : wâ€³ âŠ’ wâ€²) (Î¾â‚‚ : wâ€² âŠ’ w) â†’ Un a
                           â†’ Eq (acc (Î¾â‚ â–¡ Î¾â‚‚) a)
                                 ((acc Î¾â‚ âˆ˜ acc Î¾â‚‚) a)

  -- (auxâ‚„â‚â‚ƒ)
  postulate
    accâ—idEq : âˆ€ {A B w wâ€²} â†’ {f : w âŠ© A âŠƒ B} {a : wâ€² âŠ© A}
                            â†’ (Î¾ : wâ€² âŠ’ w) â†’ Un f â†’ Un a
                            â†’ Eq (acc Î¾ f â—âŸ¨ idâ‚ âŸ© a)
                                  (f â—âŸ¨ Î¾ âŸ© a)

  accâ—Eq : âˆ€ {A B w wâ€² wâ€³} â†’ {f : w âŠ© A âŠƒ B} {a : wâ€² âŠ© A}
                           â†’ (Î¾â‚ : wâ€² âŠ’ w) (Î¾â‚‚ : wâ€³ âŠ’ wâ€²) â†’ Un f â†’ Un a
                           â†’ Eq (acc Î¾â‚ f â—âŸ¨ Î¾â‚‚ âŸ© acc Î¾â‚‚ a)
                                 (acc Î¾â‚‚ (f â—âŸ¨ Î¾â‚ âŸ© a))
  accâ—Eq Î¾â‚ Î¾â‚‚ (unâŠƒ hâ‚ hâ‚‚ hâ‚ƒ) u = symEq (hâ‚ƒ Î¾â‚‚ Î¾â‚ u)


--------------------------------------------------------------------------------


module _ {{ğ”ª : ğ”}} where
  open ğ” ğ”ª

  infix 3 _âŠ©â‹†_
  data _âŠ©â‹†_ : ğ’² â†’ ğ’ â†’ Set
    where
      []    : âˆ€ {w} â†’
                w âŠ©â‹† []

      [_,_] : âˆ€ {Î A w} â†’
                (Ï : w âŠ©â‹† Î) (a : w âŠ© A) â†’
                w âŠ©â‹† [ Î , A ]

  -- âŸ¦putâ‚›âŸ§ canâ€™t be stated here

  -- (âŸ¦getâ‚›âŸ§ / lookup)
  getâ‚‘ : âˆ€ {Î A w} â†’ w âŠ©â‹† Î â†’ Î âˆ‹ A
                   â†’ w âŠ© A
  getâ‚‘ [ Ï , a ] zero    = a
  getâ‚‘ [ Ï , a ] (suc i) = getâ‚‘ Ï i

  -- (âŸ¦unwkâ‚›âŸ§)
  unwkâ‚‘ : âˆ€ {Î A w} â†’ w âŠ©â‹† [ Î , A ]
                    â†’ w âŠ©â‹† Î
  unwkâ‚‘ [ Ï , a ] = Ï

  -- âŸ¦wkâ‚›âŸ§ canâ€™t be stated here
  -- âŸ¦liftâ‚›âŸ§ canâ€™t be stated here
  -- âŸ¦idâ‚›âŸ§ canâ€™t be stated here
  -- âŸ¦subâŸ§ canâ€™t be stated here
  -- âŸ¦cutâŸ§ canâ€™t be stated here
  -- _â– _ canâ€™t be stated here


--------------------------------------------------------------------------------


module _ {{ğ”ª : ğ”}} where
  open ğ” ğ”ª

  -- (âŸ¦_â—‘_âŸ§ / â†‘âŸ¨_âŸ©âŠ©â‹†)
  _â—¨_ : âˆ€ {Î w wâ€²} â†’ wâ€² âŠ’ w â†’ w âŠ©â‹† Î â†’ wâ€² âŠ©â‹† Î
  Î¾ â—¨ []        = []
  Î¾ â—¨ [ Ï , a ] = [ Î¾ â—¨ Ï , acc Î¾ a ]

  -- (âŸ¦_â—_âŸ§ / â†“âŸ¨_âŸ©âŠ©â‹†)
  _â—§_ : âˆ€ {Î Îâ€² w} â†’ w âŠ©â‹† Îâ€² â†’ Îâ€² âˆ‹â‹† Î â†’ w âŠ©â‹† Î
  Ï â—§ []        = []
  Ï â—§ [ Î· , i ] = [ Ï â—§ Î· , getâ‚‘ Ï i ]


--------------------------------------------------------------------------------


module _ {{ğ”ª : ğ”}} where
  open ğ” ğ”ª

  zapâ—§ : âˆ€ {Î Îâ€² A w} â†’ (Ï : w âŠ©â‹† Îâ€²) (Î· : Îâ€² âˆ‹â‹† Î) (a : w âŠ© A)
                      â†’ [ Ï , a ] â—§ wkáµ£ Î· â‰¡ Ï â—§ Î·
  zapâ—§ Ï []        a = refl
  zapâ—§ Ï [ Î· , i ] a = congÂ² [_,_] (zapâ—§ Ï Î· a) refl

  idâ‚‚â—§ : âˆ€ {Î w} â†’ (Ï : w âŠ©â‹† Î)
                 â†’ Ï â—§ idáµ£ â‰¡ Ï
  idâ‚‚â—§ []        = refl
  idâ‚‚â—§ [ Ï , a ] = begin
    [ [ Ï , a ] â—§ wkáµ£ idáµ£ , a ] â‰¡âŸ¨ congÂ² [_,_] (zapâ—§ Ï idáµ£ a) refl âŸ©
    [ Ï â—§ idáµ£ , a ]             â‰¡âŸ¨ congÂ² [_,_] (idâ‚‚â—§ Ï) refl âŸ©
    [ Ï , a ] âˆ
    where open â‰¡-Reasoning


--------------------------------------------------------------------------------


module _ {{ğ”ª : ğ”}} where
  open ğ” ğ”ª

  getâ—§ : âˆ€ {Î Îâ€² A w} â†’ (Ï : w âŠ©â‹† Îâ€²) (Î· : Îâ€² âˆ‹â‹† Î) (i : Î âˆ‹ A)
                      â†’ getâ‚‘ (Ï â—§ Î·) i â‰¡ (getâ‚‘ Ï âˆ˜ getáµ£ Î·) i
  getâ—§ Ï [ Î· , j ] zero    = refl
  getâ—§ Ï [ Î· , j ] (suc i) = getâ—§ Ï Î· i

  compâ—§â—‹ : âˆ€ {Î Îâ€² Îâ€³ w} â†’ (Ï : w âŠ©â‹† Îâ€³) (Î·â‚ : Îâ€³ âˆ‹â‹† Îâ€²) (Î·â‚‚ : Îâ€² âˆ‹â‹† Î)
                         â†’ Ï â—§ (Î·â‚ â—‹ Î·â‚‚) â‰¡ (Ï â—§ Î·â‚) â—§ Î·â‚‚
  compâ—§â—‹ Ïƒ Î·â‚ []         = refl
  compâ—§â—‹ Ïƒ Î·â‚ [ Î·â‚‚ , z ] = congÂ² [_,_] (compâ—§â—‹ Ïƒ Î·â‚ Î·â‚‚) (sym (getâ—§ Ïƒ Î·â‚ z))

  -- wkâ—§ canâ€™t be stated here
  -- liftâ—§ canâ€™t be stated here
  -- wkidâ‚‚â—§ canâ€™t be stated here
  -- liftwkidâ‚‚â—§ canâ€™t be stated here
  -- subâ—§ canâ€™t be stated here
  -- subwkâ—§ canâ€™t be stated here
  -- subliftâ—§ canâ€™t be stated here
  -- subliftwkâ—§ canâ€™t be stated here


--------------------------------------------------------------------------------


module _ {{ğ”ª : ğ”}} where
  open ğ” ğ”ª

  data Eqâ‹† : âˆ€ {Î w} â†’ w âŠ©â‹† Î â†’ w âŠ©â‹† Î â†’ Set
    where
      []    : âˆ€ {w} â†’ Eqâ‹† ([] {w}) []

      [_,_] : âˆ€ {Î A w} â†’ {Ï Ïâ€² : w âŠ©â‹† Î} {a aâ€² : w âŠ© A}
                        â†’ (Îµ : Eqâ‹† Ï Ïâ€²) (e : Eq a aâ€²)
                        â†’ Eqâ‹† [ Ï , a ] [ Ïâ€² , aâ€² ]

  data Unâ‹† : âˆ€ {Î w} â†’ w âŠ©â‹† Î â†’ Set
    where
      []    : âˆ€ {w} â†’ Unâ‹† ([] {w})

      [_,_] : âˆ€ {Î A w} â†’ {Ï : w âŠ©â‹† Î} {a : w âŠ© A}
                        â†’ (Ï… : Unâ‹† Ï) (u : Un a)
                        â†’ Unâ‹† [ Ï , a ]

  reflEqâ‹† : âˆ€ {Î w} â†’ {Ï : w âŠ©â‹† Î}
                    â†’ Unâ‹† Ï
                    â†’ Eqâ‹† Ï Ï
  reflEqâ‹† []        = []
  reflEqâ‹† [ Ï… , u ] = [ reflEqâ‹† Ï… , reflEq u ]

  symEqâ‹† : âˆ€ {Î w} â†’ {Ï Ïâ€² : w âŠ©â‹† Î}
                   â†’ Eqâ‹† Ï Ïâ€²
                   â†’ Eqâ‹† Ïâ€² Ï
  symEqâ‹† []        = []
  symEqâ‹† [ Îµ , e ] = [ symEqâ‹† Îµ , symEq e ]

  transEqâ‹† : âˆ€ {Î w} â†’ {Ï Ïâ€² Ïâ€³ : w âŠ©â‹† Î}
                     â†’ Eqâ‹† Ï Ïâ€² â†’ Eqâ‹† Ïâ€² Ïâ€³
                     â†’ Eqâ‹† Ï Ïâ€³
  transEqâ‹† []          []          = []
  transEqâ‹† [ Îµâ‚ , eâ‚ ] [ Îµâ‚‚ , eâ‚‚ ] = [ transEqâ‹† Îµâ‚ Îµâ‚‚ , transEq eâ‚ eâ‚‚ ]

  â‰¡â†’Eqâ‹† : âˆ€ {Î w} â†’ {Ï Ïâ€² : w âŠ©â‹† Î} â†’ Ï â‰¡ Ïâ€² â†’ Unâ‹† Ï â†’ Eqâ‹† Ï Ïâ€²
  â‰¡â†’Eqâ‹† refl Ï… = reflEqâ‹† Ï…

  module Eqâ‹†-Reasoning where
    infix 1 begin_
    begin_ : âˆ€ {Î w} â†’ {Ï Ïâ€² : w âŠ©â‹† Î} â†’ Eqâ‹† Ï Ïâ€² â†’ Eqâ‹† Ï Ïâ€²
    begin Îµ = Îµ

    infixr 2 _Eqâ‹†âŸ¨âŸ©_
    _Eqâ‹†âŸ¨âŸ©_ : âˆ€ {Î w} â†’ (Ï {Ïâ€²} : w âŠ©â‹† Î) â†’ Eqâ‹† Ï Ïâ€² â†’ Eqâ‹† Ï Ïâ€²
    Ï Eqâ‹†âŸ¨âŸ© Îµ = Îµ

    infixr 2 _Eqâ‹†âŸ¨_âŸ©_
    _Eqâ‹†âŸ¨_âŸ©_ : âˆ€ {Î w} â†’ (Ï {Ïâ€² Ïâ€³} : w âŠ©â‹† Î) â†’ Eqâ‹† Ï Ïâ€² â†’ Eqâ‹† Ïâ€² Ïâ€³ â†’ Eqâ‹† Ï Ïâ€³
    Ï Eqâ‹†âŸ¨ Îµâ‚ âŸ© Îµâ‚‚ = transEqâ‹† Îµâ‚ Îµâ‚‚

    infixr 2 _â‰¡âŸ¨âŸ©_
    _â‰¡âŸ¨âŸ©_ : âˆ€ {Î w} â†’ (Ï {Ïâ€²} : w âŠ©â‹† Î) â†’ Eqâ‹† Ï Ïâ€² â†’ Eqâ‹† Ï Ïâ€²
    Ï â‰¡âŸ¨âŸ© Îµ = Îµ

    infixr 2 _â‰¡âŸ¨_âˆ£_âŸ©_
    _â‰¡âŸ¨_âˆ£_âŸ©_ : âˆ€ {Î w} â†’ (Ï {Ïâ€² Ïâ€³} : w âŠ©â‹† Î) â†’ Ï â‰¡ Ïâ€² â†’ Unâ‹† Ï â†’ Eqâ‹† Ïâ€² Ïâ€³ â†’ Eqâ‹† Ï Ïâ€³
    Ï â‰¡âŸ¨ Îµâ‚ âˆ£ Ï… âŸ© Îµâ‚‚ = transEqâ‹† (â‰¡â†’Eqâ‹† Îµâ‚ Ï…) Îµâ‚‚

    infix 3 _âˆâŸ¨_âŸ©
    _âˆâŸ¨_âŸ© : âˆ€ {Î w} â†’ (Ï : w âŠ©â‹† Î) â†’ Unâ‹† Ï â†’ Eqâ‹† Ï Ï
    Ï âˆâŸ¨ Ï… âŸ© = reflEqâ‹† Ï…


--------------------------------------------------------------------------------


module _ {{ğ”ª : ğ”}} where
  open ğ” ğ”ª

  -- (conglookupEq)
  postulate
    conggetEq : âˆ€ {Î A w} â†’ {Ï Ïâ€² : w âŠ©â‹† Î}
                          â†’ (i : Î âˆ‹ A) â†’ Eqâ‹† Ï Ïâ€²
                          â†’ Eq (getâ‚‘ Ï i) (getâ‚‘ Ïâ€² i)

  -- (congâ†‘âŸ¨_âŸ©Eqâ‹†)
  postulate
    congâ—¨Eqâ‹† : âˆ€ {Î w wâ€²} â†’ {Ï Ïâ€² : w âŠ©â‹† Î}
                          â†’ (Î¾ : wâ€² âŠ’ w) â†’ Eqâ‹† Ï Ïâ€²
                          â†’ Eqâ‹† (Î¾ â—¨ Ï) (Î¾ â—¨ Ïâ€²)

  -- (congâ†“âŸ¨_âŸ©Eqâ‹†)
  postulate
    congâ—§Eqâ‹† : âˆ€ {Î Îâ€² w} â†’ {Ï Ïâ€² : w âŠ©â‹† Îâ€²}
                          â†’ (Î· : Îâ€² âˆ‹â‹† Î) â†’ Eqâ‹† Ï Ïâ€²
                          â†’ Eqâ‹† (Ï â—§ Î·) (Ïâ€² â—§ Î·)

  -- (conglookupğ’°)
  postulate
    conggetUn : âˆ€ {Î A w} â†’ {Ï : w âŠ©â‹† Î}
                          â†’ (i : Î âˆ‹ A) â†’ Unâ‹† Ï
                          â†’ Un (getâ‚‘ Ï i)

  -- (congâ†‘âŸ¨_âŸ©ğ’°â‹†)
  postulate
    congâ—¨Unâ‹† : âˆ€ {Î w wâ€²} â†’ {Ï : w âŠ©â‹† Î}
                          â†’ (Î¾ : wâ€² âŠ’ w) â†’ Unâ‹† Ï
                          â†’ Unâ‹† (Î¾ â—¨ Ï)

  -- (congâ†“âŸ¨_âŸ©ğ’°â‹†)
  postulate
    congâ—§Unâ‹† : âˆ€ {Î Îâ€² w} â†’ {Ï : w âŠ©â‹† Îâ€²}
                          â†’ (Î· : Îâ€² âˆ‹â‹† Î) â†’ Unâ‹† Ï
                          â†’ Unâ‹† (Ï â—§ Î·)


--------------------------------------------------------------------------------


module _ {{ğ”ª : ğ”}} where
  open ğ” ğ”ª

  -- (auxâ‚„â‚‚â‚)
  postulate
    getâ—§Eq : âˆ€ {Î Îâ€² A w} â†’ {Ï : w âŠ©â‹† Îâ€²}
                          â†’ (Î· : Îâ€² âˆ‹â‹† Î) (i : Îâ€² âˆ‹ A) (j : Î âˆ‹ A) â†’ Unâ‹† Ï
                          â†’ Eq (getâ‚‘ (Ï â—§ Î·) j)
                                (getâ‚‘ Ï i)

  -- (conglookupâ†‘âŸ¨_âŸ©Eq)
  postulate
    getâ—¨Eq : âˆ€ {Î A w wâ€²} â†’ {Ï : w âŠ©â‹† Î}
                          â†’ (Î¾ : wâ€² âŠ’ w) (i : Î âˆ‹ A) â†’ Unâ‹† Ï
                          â†’ Eq (getâ‚‘ (Î¾ â—¨ Ï) i)
                                (acc Î¾ (getâ‚‘ Ï i))

  -- (auxâ‚„â‚‚â‚ƒ)
  postulate
    zapâ—§Eqâ‹† : âˆ€ {Î Îâ€² A w} â†’ {Ï : w âŠ©â‹† Îâ€²} {a : w âŠ© A}
                           â†’ (Î·â‚ : [ Îâ€² , A ] âˆ‹â‹† Î) (Î·â‚‚ : Îâ€² âˆ‹â‹† Î) â†’ Unâ‹† Ï
                           â†’ Eqâ‹† ([ Ï , a ] â—§ Î·â‚)
                                  (Ï â—§ Î·â‚‚)

  -- (auxâ‚„â‚‚â‚„)
  postulate
    idâ‚‚â—§Eqâ‹† : âˆ€ {Î w} â†’ {Ï : w âŠ©â‹† Î}
                      â†’ Unâ‹† Ï
                      â†’ Eqâ‹† (Ï â—§ idáµ£) Ï

  -- (auxâ‚„â‚‚â‚…)
  postulate
    idâ‚â—¨Eqâ‹† : âˆ€ {Î w} â†’ {Ï : w âŠ©â‹† Î}
                      â†’ Unâ‹† Ï
                      â†’ Eqâ‹† (idâ‚ â—¨ Ï) Ï

  -- (auxâ‚„â‚‚â‚†)
  postulate
    compâ—§â—‹Eqâ‹† : âˆ€ {Î Îâ€² Îâ€³ w} â†’ {Ï : w âŠ©â‹† Îâ€³}
                              â†’ (Î·â‚ : Îâ€³ âˆ‹â‹† Îâ€²) (Î·â‚‚ : Îâ€² âˆ‹â‹† Î) â†’ Unâ‹† Ï
                              â†’ Eqâ‹† (Ï â—§ (Î·â‚ â—‹ Î·â‚‚))
                                     ((Ï â—§ Î·â‚) â—§ Î·â‚‚)

  -- (auxâ‚„â‚‚â‚‡)
  postulate
    compâ—¨â–¡Eqâ‹† : âˆ€ {Î w wâ€² wâ€³} â†’ {Ï : w âŠ©â‹† Î}
                              â†’ (Î¾â‚ : wâ€³ âŠ’ wâ€²) (Î¾â‚‚ : wâ€² âŠ’ w) â†’ Unâ‹† Ï
                              â†’ Eqâ‹† (Î¾â‚ â—¨ (Î¾â‚‚ â—¨ Ï))
                                     ((Î¾â‚ â–¡ Î¾â‚‚) â—¨ Ï)

  -- (auxâ‚„â‚‚â‚ˆ)
  postulate
    compâ—¨â—§Eqâ‹† : âˆ€ {Î Îâ€² w wâ€²} â†’ {Ï : w âŠ©â‹† Îâ€²}
                              â†’ (Î¾ : wâ€² âŠ’ w) (Î· : Îâ€² âˆ‹â‹† Î) â†’ Unâ‹† Ï
                              â†’ Eqâ‹† (Î¾ â—¨ (Ï â—§ Î·))
                                     ((Î¾ â—¨ Ï) â—§ Î·)


--------------------------------------------------------------------------------


module _ {{ğ”ª : ğ”}} where
  open ğ” ğ”ª

  âŸ¦_âŸ§ : âˆ€ {Î A w} â†’ Î âŠ¢ A â†’ w âŠ©â‹† Î â†’ w âŠ© A
  âŸ¦ ` i âŸ§   Ï = getâ‚‘ Ï i
  âŸ¦ Æ› M âŸ§   Ï = âŸ¦Æ›âŸ§ (Î» Î¾ a â†’ âŸ¦ M âŸ§ [ Î¾ â—¨ Ï , a ])
  âŸ¦ M âˆ™ N âŸ§ Ï = âŸ¦ M âŸ§ Ï â—âŸ¨ idâ‚ âŸ© âŸ¦ N âŸ§ Ï

  âŸ¦_âŸ§â‹† : âˆ€ {Î Î¦ w} â†’ Î âŠ¢â‹† Î¦ â†’ w âŠ©â‹† Î â†’ w âŠ©â‹† Î¦
  âŸ¦ [] âŸ§â‹†        Ï = []
  âŸ¦ [ Ïƒ , M ] âŸ§â‹† Ï = [ âŸ¦ Ïƒ âŸ§â‹† Ï , âŸ¦ M âŸ§ Ï ]


--------------------------------------------------------------------------------


instance
  canon : ğ”
  canon = record
    { ğ’²      = ğ’
    ; ğ’¢      = _âŠ¢ âµ
    ; _âŠ’_    = _âˆ‹â‹†_
    ; idâ‚    = idáµ£
    ; _â–¡_    = _â—‹_
    ; idâ‚â–¡   = idâ‚â—‹
    ; idâ‚‚â–¡   = idâ‚‚â—‹
    ; assocâ–¡ = assocâ—‹
    }


--------------------------------------------------------------------------------


mutual
  reify : âˆ€ {A Î“} â†’ Î“ âŠ© A â†’ Î“ âŠ¢ A
  reify {âµ}     f = âŸ¦gâŸ§âŸ¨ idáµ£ âŸ© f
  reify {A âŠƒ B} f = Æ› (reify (f â—âŸ¨ wkáµ£ idáµ£ âŸ© âŸª` zero âŸ«))

  âŸª_âŸ« : âˆ€ {A Î“} â†’ (âˆ€ {Î“â€²} â†’ Î“â€² âˆ‹â‹† Î“ â†’ Î“â€² âŠ¢ A) â†’ Î“ âŠ© A
  âŸª_âŸ« {âµ}     f = âŸ¦GâŸ§ (Î» Î·   â†’ f Î·)
  âŸª_âŸ« {A âŠƒ B} f = âŸ¦Æ›âŸ§ (Î» Î· a â†’ âŸª (Î» Î·â€² â†’ f (Î·â€² â—‹ Î·) âˆ™ reify (acc Î·â€² a)) âŸ«)

  âŸª`_âŸ« : âˆ€ {Î“ A} â†’ Î“ âˆ‹ A â†’ Î“ âŠ© A
  âŸª` i âŸ« = âŸª (Î» Î· â†’ ren Î· (` i)) âŸ«

postulate
  auxâ‚„â‚„â‚ : âˆ€ {A Î“} â†’ (f fâ€² : âˆ€ {Î“â€²} â†’ Î“â€² âˆ‹â‹† Î“ â†’ Î“â€² âŠ¢ A)
                   â†’ (âˆ€ {Î“â€²} â†’ (Î· : Î“â€² âˆ‹â‹† Î“) â†’ f Î· â‰¡ fâ€² Î·)
                   â†’ Eq (âŸª f âŸ«) (âŸª fâ€² âŸ«)

postulate
  auxâ‚„â‚„â‚‚ : âˆ€ {A Î“ Î“â€²} â†’ (Î· : Î“â€² âˆ‹â‹† Î“) (f : (âˆ€ {Î“â€²} â†’ Î“â€² âˆ‹â‹† Î“ â†’ Î“â€² âŠ¢ A))
                      â†’ Eq (acc Î· âŸª f âŸ«) (âŸª (Î» Î·â€² â†’ f (Î·â€² â—‹ Î·)) âŸ«)


--------------------------------------------------------------------------------


-- Theorem 1.
mutual
  postulate
    thmâ‚ : âˆ€ {Î“ A} â†’ {a aâ€² : Î“ âŠ© A}
                   â†’ Eq a aâ€²
                   â†’ reify a â‰¡ reify aâ€²

  postulate
    âŸª`_âŸ«áµ¤ : âˆ€ {Î“ A} â†’ (i : Î“ âˆ‹ A)
                    â†’ Un (âŸª` i âŸ«)

  postulate
    auxâ‚„â‚„â‚ƒ : âˆ€ {A Î“} â†’ (f : âˆ€ {Î“â€²} â†’ Î“â€² âˆ‹â‹† Î“ â†’ Î“â€² âŠ¢ A)
                     â†’ Un (âŸª f âŸ«)


--------------------------------------------------------------------------------


âŒŠ_âŒ‹â‚‘ : âˆ€ {Î“ Î“â€²} â†’ Î“â€² âˆ‹â‹† Î“
                â†’ Î“â€² âŠ©â‹† Î“
âŒŠ [] âŒ‹â‚‘        = []
âŒŠ [ Î· , i ] âŒ‹â‚‘ = [ âŒŠ Î· âŒ‹â‚‘ , âŸª` i âŸ« ]

idâ‚‘ : âˆ€ {Î“} â†’ Î“ âŠ©â‹† Î“
idâ‚‘ = âŒŠ idáµ£ âŒ‹â‚‘


nf : âˆ€ {Î“ A} â†’ Î“ âŠ¢ A
             â†’ Î“ âŠ¢ A
nf M = reify (âŸ¦ M âŸ§ idâ‚‘)


-- Corollary 1.
postulate
  corâ‚ : âˆ€ {Î“ A} â†’ (M Mâ€² : Î“ âŠ¢ A) â†’ Eq (âŸ¦ M âŸ§ idâ‚‘) (âŸ¦ Mâ€² âŸ§ idâ‚‘)
                 â†’ nf M â‰¡ nf Mâ€²
