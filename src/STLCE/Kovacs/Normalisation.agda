module STLCE.Kovacs.Normalisation where

open import STLCE.Kovacs.NormalForm public


--------------------------------------------------------------------------------


-- (Tyá´º)
mutual
  infix 3 _âŠ©_
  _âŠ©_ : ğ’ â†’ ğ’¯ â†’ Set

  Î“ âŠ© âµ      = Î“ âŠ¢â¿á¶  âµ

  Î“ âŠ© A â‡’ B = âˆ€ {Î“â€²} â†’ (Î· : Î“â€² âŠ‡ Î“) (a : Î“â€² âˆ‚âŠ© A)
                       â†’ Î“â€² âˆ‚âŠ© B

  Î“ âŠ© A â©• B  = Î“ âˆ‚âŠ© A Ã— Î“ âˆ‚âŠ© B

  Î“ âŠ© â«ª     = âŠ¤

  Î“ âŠ© â««     = âŠ¥

  Î“ âŠ© A â©– B  = Î“ âˆ‚âŠ© A âŠ Î“ âˆ‚âŠ© B


  infix 3 _âˆ‚âŠ©_
  _âˆ‚âŠ©_ : ğ’ â†’ ğ’¯ â†’ Set
  Î“ âˆ‚âŠ© A = âˆ€ {Î“â€² C} â†’ (Î· : Î“â€² âŠ‡ Î“) (f : âˆ€ {Î“â€³} â†’ Î“â€³ âŠ‡ Î“â€² â†’ Î“â€³ âŠ© A â†’ Î“â€³ âŠ¢â¿á¶  C)
                     â†’ Î“â€² âŠ¢â¿á¶  C


-- (Tyá´ºâ‚‘)
mutual
  acc : âˆ€ {A Î“ Î“â€²} â†’ Î“â€² âŠ‡ Î“ â†’ Î“ âŠ© A â†’ Î“â€² âŠ© A
  acc {âµ}      Î· M        = renâ¿á¶  Î· M
  acc {A â‡’ B} Î· f        = Î» Î·â€² a â†’ f (Î· â—‹ Î·â€²) a
  acc {A â©• B}  Î· s        = âˆ‚acc Î· (projâ‚ s) , âˆ‚acc Î· (projâ‚‚ s)
  acc {â«ª}     Î· s        = tt
  acc {â««}     Î· s        = elimâŠ¥ s
  acc {A â©– B}  Î· (injâ‚ a) = injâ‚ (âˆ‚acc Î· a)
  acc {A â©– B}  Î· (injâ‚‚ b) = injâ‚‚ (âˆ‚acc Î· b)
-- TODO: Report Agda bug
-- acc {A â©– B}  Î· s = elimâŠ s (Î» a â†’ injâ‚ (acc Î· a))
--                            (Î» b â†’ injâ‚‚ (acc Î· b))

  âˆ‚acc : âˆ€ {A Î“ Î“â€²} â†’ Î“â€² âŠ‡ Î“ â†’ Î“ âˆ‚âŠ© A â†’ Î“â€² âˆ‚âŠ© A
  âˆ‚acc Î· Îº = Î» Î·â€² f â†’
               Îº (Î· â—‹ Î·â€²) f


return : âˆ€ {A Î“} â†’ Î“ âŠ© A â†’ Î“ âˆ‚âŠ© A
return {A} a = Î» Î· f â†’
                 f idâ‚‘ (acc {A} Î· a)

bind : âˆ€ {A C Î“} â†’ Î“ âˆ‚âŠ© A â†’ (âˆ€ {Î“â€²} â†’ Î“â€² âŠ‡ Î“ â†’ Î“â€² âŠ© A â†’ Î“â€² âˆ‚âŠ© C)
                 â†’ Î“ âˆ‚âŠ© C
bind Îº f = Î» Î· fâ€² â†’
             Îº Î· (Î» Î·â€² a â†’
               f (Î· â—‹ Î·â€²) a idâ‚‘ (Î» Î·â€³ b â†’
                 fâ€² (Î·â€² â—‹ Î·â€³) b))


--------------------------------------------------------------------------------


-- (Coná´º ; âˆ™ ; _,_)
infix 3 _âˆ‚âŠ©â‹†_
data _âˆ‚âŠ©â‹†_ : ğ’ â†’ ğ’ â†’ Set
  where
    âˆ…   : âˆ€ {Î“} â†’ Î“ âˆ‚âŠ©â‹† âˆ…

    _,_ : âˆ€ {Î“ Î A} â†’ (Ï : Î“ âˆ‚âŠ©â‹† Î) (a : Î“ âˆ‚âŠ© A)
                    â†’ Î“ âˆ‚âŠ©â‹† Î , A


-- (Coná´ºâ‚‘)
-- NOTE: _â¬–_ = âˆ‚accâ‹†
_â¬–_ : âˆ€ {Î“ Î“â€² Î} â†’ Î“ âˆ‚âŠ©â‹† Î â†’ Î“â€² âŠ‡ Î“ â†’ Î“â€² âˆ‚âŠ©â‹† Î
âˆ…       â¬– Î· = âˆ…
(Ï , a) â¬– Î· = Ï â¬– Î· , âˆ‚acc Î· a


-- (âˆˆá´º)
getáµ¥ : âˆ€ {Î“ Î A} â†’ Î“ âˆ‚âŠ©â‹† Î â†’ Î âˆ‹ A â†’ Î“ âˆ‚âŠ© A
getáµ¥ (Ï , a) zero    = a
getáµ¥ (Ï , a) (suc i) = getáµ¥ Ï i

-- (Tmá´º)
eval : âˆ€ {Î“ Î A} â†’ Î“ âˆ‚âŠ©â‹† Î â†’ Î âŠ¢ A â†’ Î“ âˆ‚âŠ© A
eval Ï (` i)          = getáµ¥ Ï i
eval Ï (Æ› {A = A} M)  = return {A â‡’ _} (Î» Î· a â†’ eval (Ï â¬– Î· , a) M)
eval Ï (M âˆ™ N)        = bind (eval Ï M) (Î» Î· f â†’
                          f idâ‚‘ (eval (Ï â¬– Î·) N))
eval Ï (M , N)        = return (eval Ï M , eval Ï N)
eval Ï (Ï€â‚ M)         = bind (eval Ï M) (Î» Î· s â†’
                          projâ‚ s)
eval Ï (Ï€â‚‚ M)         = bind (eval Ï M) (Î» Î· s â†’
                          projâ‚‚ s)
eval Ï Ï„              = return tt
eval Ï (Ï† M)          = bind (eval Ï M) (Î» Î· s â†’
                          elimâŠ¥ s)
eval Ï (Î¹â‚ {B = B} M) = return {_ â©– B} (injâ‚ (eval Ï M))
eval Ï (Î¹â‚‚ {A = A} M) = return {A â©– _} (injâ‚‚ (eval Ï M))
eval Ï (M â‡ Nâ‚ âˆ¥ Nâ‚‚)  = bind (eval Ï M) (Î» Î· s â†’
                          elimâŠ s (Î» a â†’ eval (Ï â¬– Î· , a) Nâ‚)
                                  (Î» b â†’ eval (Ï â¬– Î· , b) Nâ‚‚))


mutual
  -- (qá´º)
  reify : âˆ€ {A Î“} â†’ Î“ âˆ‚âŠ© A â†’ Î“ âŠ¢â¿á¶  A
  reify {âµ}      Îº = Îº idâ‚‘ (Î» Î· M â†’ M)
  reify {A â‡’ B} Îº = Îº idâ‚‘ (Î» Î· f â†’ Æ› (reify (f (wkâ‚‘ idâ‚‘) (reflect 0))))
  reify {A â©• B}  Îº = Îº idâ‚‘ (Î» Î· s â†’ reify (projâ‚ s) , reify (projâ‚‚ s))
  reify {â«ª}     Îº = Îº idâ‚‘ (Î» Î· s â†’ Ï„)
  reify {â««}     Îº = Îº idâ‚‘ (Î» Î· s â†’ elimâŠ¥ s)
  reify {A â©– B}  Îº = Îº idâ‚‘ (Î» Î· s â†’ elimâŠ s (Î» a â†’ Î¹â‚ (reify a))
                                             (Î» b â†’ Î¹â‚‚ (reify b)))

  -- (uá´º)
  reflect : âˆ€ {A Î“} â†’ Î“ âŠ¢â¿áµ‰ A â†’ Î“ âˆ‚âŠ© A
  reflect {âµ}      M = return (ne M)
  reflect {A â‡’ B} M = return {A â‡’ _} (Î» Î· a â†’ reflect (renâ¿áµ‰ Î· M âˆ™ reify a))
  reflect {A â©• B}  M = return (reflect (Ï€â‚ M) , reflect (Ï€â‚‚ M))
  reflect {â«ª}     M = return tt
  reflect {â««}     M = Î» Î· f â†’
                         ne (Ï† (renâ¿áµ‰ Î· M))
  reflect {A â©– B}  M = Î» Î· f â†’
                         ne (renâ¿áµ‰ Î· M â‡ f (wkâ‚‘ idâ‚‘) (injâ‚ (reflect 0))
                                       âˆ¥ f (wkâ‚‘ idâ‚‘) (injâ‚‚ (reflect 0)))

-- (uá¶œá´º)
idáµ¥ : âˆ€ {Î“} â†’ Î“ âˆ‚âŠ©â‹† Î“
idáµ¥ {âˆ…}     = âˆ…
idáµ¥ {Î“ , A} = idáµ¥ â¬– wkâ‚‘ idâ‚‘ , reflect 0


-- (nf)
nf : âˆ€ {Î“ A} â†’ Î“ âŠ¢ A â†’ Î“ âŠ¢â¿á¶  A
nf M = reify (eval idáµ¥ M)


--------------------------------------------------------------------------------
