module KovacsNormalisation where

open import KovacsNormalForm public


-- (Tyá´º)
infix 3 _âŠ©_
_âŠ©_ : ğ’ â†’ ğ’¯ â†’ Set

Î“ âŠ© âµ     = Î“ âŠ¢â¿á¶  âµ

Î“ âŠ© A âŠƒ B = âˆ€ {Î“â€²} â†’ (Î· : Î“â€² âŠ‡ Î“) (a : Î“â€² âŠ© A)
                    â†’ Î“â€² âŠ© B


-- (Tyá´ºâ‚‘)
acc : âˆ€ {A Î“ Î“â€²} â†’ Î“â€² âŠ‡ Î“ â†’ Î“ âŠ© A â†’ Î“â€² âŠ© A
acc {âµ}     Î· M = renâ¿á¶  Î· M
acc {A âŠƒ B} Î· f = Î» Î·â€² a â†’ f (Î· â—‹ Î·â€²) a


-- (Coná´º ; âˆ™ ; _,_)
data _âŠ©â‹†_ : ğ’ â†’ ğ’ â†’ Set
  where
    []    : âˆ€ {Î“} â†’ Î“ âŠ©â‹† []

    [_,_] : âˆ€ {Î“ Î A} â†’ (Ï : Î“ âŠ©â‹† Î) (a : Î“ âŠ© A)
                      â†’ Î“ âŠ©â‹† [ Î , A ]


-- (Coná´ºâ‚‘)
_â—áµ¥_ : âˆ€ {Î“ Î“â€² Î} â†’ Î“ âŠ©â‹† Î â†’ Î“â€² âŠ‡ Î“ â†’ Î“â€² âŠ©â‹† Î
[]        â—áµ¥ Î· = []
[ Ï , a ] â—áµ¥ Î· = [ Ï â—áµ¥ Î· , acc Î· a ]


-- (âˆˆá´º)
getáµ¥ : âˆ€ {Î“ Î A} â†’ Î“ âŠ©â‹† Î â†’ Î âˆ‹ A â†’ Î“ âŠ© A
getáµ¥ [ Ï , a ] zero    = a
getáµ¥ [ Ï , a ] (suc i) = getáµ¥ Ï i

-- (Tmá´º)
eval : âˆ€ {Î“ Î A} â†’ Î“ âŠ©â‹† Î â†’ Î âŠ¢ A â†’ Î“ âŠ© A
eval Ï (` i)   = getáµ¥ Ï i
eval Ï (Æ› M)   = Î» Î· a â†’ eval [ Ï â—áµ¥ Î· , a ] M
eval Ï (M âˆ™ N) = eval Ï M idâ‚‘ (eval Ï N)

mutual
  -- (qá´º)
  reify : âˆ€ {A Î“} â†’ Î“ âŠ© A â†’ Î“ âŠ¢â¿á¶  A
  reify {âµ}     a = a
  reify {A âŠƒ B} f = Æ› (reify (f (wkâ‚‘ idâ‚‘) (reflect (` zero))))

  -- (uá´º)
  reflect : âˆ€ {A Î“} â†’ Î“ âŠ¢â¿áµ‰ A â†’ Î“ âŠ© A
  reflect {âµ}     M = ne M
  reflect {A âŠƒ B} M = Î» Î· a â†’ reflect (renâ¿áµ‰ Î· M âˆ™ reify a)

-- (uá¶œá´º)
idáµ¥ : âˆ€ {Î“} â†’ Î“ âŠ©â‹† Î“
idáµ¥ {[]}        = []
idáµ¥ {[ Î“ , A ]} = [ idáµ¥ â—áµ¥ wkâ‚‘ idâ‚‘ , reflect (` zero) ]


-- (nf)
nf : âˆ€ {Î“ A} â†’ Î“ âŠ¢ A â†’ Î“ âŠ¢â¿á¶  A
nf M = reify (eval idáµ¥ M)
