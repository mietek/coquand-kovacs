module KovacsSoundness where

open import KovacsConvertibility public
open import KovacsPresheafRefinement public


--------------------------------------------------------------------------------


infix 3 _â‰ˆ_
_â‰ˆ_ : âˆ€ {A Î“} â†’ Î“ âŠ© A â†’ Î“ âŠ© A â†’ Set

_â‰ˆ_ {âµ}     {Î“} Mâ‚ Mâ‚‚ = Mâ‚ â‰¡ Mâ‚‚

_â‰ˆ_ {A âŠƒ B} {Î“} fâ‚ fâ‚‚ = âˆ€ {Î“â€²} â†’ (Î· : Î“â€² âŠ‡ Î“) {aâ‚ aâ‚‚ : Î“â€² âŠ© A}
                               â†’ (p : aâ‚ â‰ˆ aâ‚‚) (uâ‚ : ğ’° aâ‚) (uâ‚‚ : ğ’° aâ‚‚)
                               â†’ fâ‚ Î· aâ‚ â‰ˆ fâ‚‚ Î· aâ‚‚


-- (â‰ˆá¶œ ; âˆ™ ; _,_)
infix 3 _â‰ˆâ‹†_
data _â‰ˆâ‹†_ : âˆ€ {Î“ Î} â†’ Î“ âŠ©â‹† Î â†’ Î“ âŠ©â‹† Î â†’ Set
  where
    âˆ…   : âˆ€ {Î“} â†’ (âˆ… {Î“}) â‰ˆâ‹† âˆ…

    _,_ : âˆ€ {Î“ Î A} â†’ {Ïâ‚ Ïâ‚‚ : Î“ âŠ©â‹† Î} {Mâ‚ Mâ‚‚ : Î“ âŠ© A}
                    â†’ (Ï‡ : Ïâ‚ â‰ˆâ‹† Ïâ‚‚) (p : Mâ‚ â‰ˆ Mâ‚‚)
                    â†’ Ïâ‚ , Mâ‚ â‰ˆâ‹† Ïâ‚‚ , Mâ‚‚


-- (_â‰ˆâ»Â¹)
_â»Â¹â‰ˆ : âˆ€ {A Î“} â†’ {aâ‚ aâ‚‚ : Î“ âŠ© A}
               â†’ aâ‚ â‰ˆ aâ‚‚
               â†’ aâ‚‚ â‰ˆ aâ‚
_â»Â¹â‰ˆ {âµ}     p = p â»Â¹
_â»Â¹â‰ˆ {A âŠƒ B} F = Î» Î· p uâ‚ uâ‚‚ â†’
                   F Î· (p â»Â¹â‰ˆ) uâ‚‚ uâ‚ â»Â¹â‰ˆ

-- (_â‰ˆá¶œâ»Â¹)
_â»Â¹â‰ˆâ‹† : âˆ€ {Î“ Î} â†’ {Ïâ‚ Ïâ‚‚ : Î“ âŠ©â‹† Î}
                â†’ Ïâ‚ â‰ˆâ‹† Ïâ‚‚
                â†’ Ïâ‚‚ â‰ˆâ‹† Ïâ‚
âˆ…       â»Â¹â‰ˆâ‹† = âˆ…
(Ï‡ , p) â»Â¹â‰ˆâ‹† = Ï‡ â»Â¹â‰ˆâ‹† , p â»Â¹â‰ˆ


-- (_â‰ˆâ—¾_)
_â¦™â‰ˆ_ : âˆ€ {A Î“} â†’ {aâ‚ aâ‚‚ aâ‚ƒ : Î“ âŠ© A}
               â†’ aâ‚ â‰ˆ aâ‚‚ â†’ aâ‚‚ â‰ˆ aâ‚ƒ
               â†’ aâ‚ â‰ˆ aâ‚ƒ
_â¦™â‰ˆ_ {âµ}     p q = p â¦™ q
_â¦™â‰ˆ_ {A âŠƒ B} F G = Î» Î· p uâ‚ uâ‚‚ â†’
                      F Î· (p â¦™â‰ˆ (p â»Â¹â‰ˆ)) uâ‚ uâ‚
                   â¦™â‰ˆ G Î· p uâ‚ uâ‚‚

-- (_â‰ˆá¶œâ—¾_)
_â¦™â‰ˆâ‹†_ : âˆ€ {Î“ Î} â†’ {Ïâ‚ Ïâ‚‚ Ïâ‚ƒ : Î“ âŠ©â‹† Î}
                â†’ Ïâ‚ â‰ˆâ‹† Ïâ‚‚ â†’ Ïâ‚‚ â‰ˆâ‹† Ïâ‚ƒ
                â†’ Ïâ‚ â‰ˆâ‹† Ïâ‚ƒ
âˆ…        â¦™â‰ˆâ‹† âˆ…        = âˆ…
(Ï‡â‚ , p) â¦™â‰ˆâ‹† (Ï‡â‚‚ , q) = Ï‡â‚ â¦™â‰ˆâ‹† Ï‡â‚‚ , p â¦™â‰ˆ q


instance
  perâ‰ˆ : âˆ€ {Î“ A} â†’ PER (Î“ âŠ© A) _â‰ˆ_
  perâ‰ˆ =
    record
      { _â»Â¹ = _â»Â¹â‰ˆ
      ; _â¦™_ = _â¦™â‰ˆ_
      }

instance
  perâ‰ˆâ‹† : âˆ€ {Î“ Î} â†’ PER (Î“ âŠ©â‹† Î) _â‰ˆâ‹†_
  perâ‰ˆâ‹† =
    record
      { _â»Â¹ = _â»Â¹â‰ˆâ‹†
      ; _â¦™_ = _â¦™â‰ˆâ‹†_
      }


--------------------------------------------------------------------------------


-- (â‰ˆâ‚‘)
accâ‰ˆ : âˆ€ {A Î“ Î“â€²} â†’ {aâ‚ aâ‚‚ : Î“ âŠ© A}
                  â†’ (Î· : Î“â€² âŠ‡ Î“) â†’ aâ‚ â‰ˆ aâ‚‚
                  â†’ acc Î· aâ‚ â‰ˆ acc Î· aâ‚‚
accâ‰ˆ {âµ}     Î· p = renâ¿á¶  Î· & p
accâ‰ˆ {A âŠƒ B} Î· F = Î» Î·â€² â†’ F (Î· â—‹ Î·â€²)

-- (â‰ˆá¶œâ‚‘)
_â¬–â‰ˆ_ : âˆ€ {Î“ Î“â€² Î} â†’ {Ïâ‚ Ïâ‚‚ : Î“ âŠ©â‹† Î}
                  â†’ Ïâ‚ â‰ˆâ‹† Ïâ‚‚ â†’ (Î· : Î“â€² âŠ‡ Î“)
                  â†’ Ïâ‚ â¬– Î· â‰ˆâ‹† Ïâ‚‚ â¬– Î·
âˆ…       â¬–â‰ˆ Î· = âˆ…
(Ï‡ , p) â¬–â‰ˆ Î· = Ï‡ â¬–â‰ˆ Î· , accâ‰ˆ Î· p


-- (âˆˆâ‰ˆ)
getâ‰ˆ : âˆ€ {Î“ Î A} â†’ {Ïâ‚ Ïâ‚‚ : Î“ âŠ©â‹† Î}
                 â†’ Ïâ‚ â‰ˆâ‹† Ïâ‚‚ â†’ (i : Î âˆ‹ A)
                 â†’ getáµ¥ Ïâ‚ i â‰ˆ getáµ¥ Ïâ‚‚ i
getâ‰ˆ (Ï‡ , p) zero    = p
getâ‰ˆ (Ï‡ , p) (suc i) = getâ‰ˆ Ï‡ i

-- (Tmâ‰ˆ)
evalâ‰ˆ : âˆ€ {Î“ Î A} â†’ {Ïâ‚ Ïâ‚‚ : Î“ âŠ©â‹† Î}
                  â†’ Ïâ‚ â‰ˆâ‹† Ïâ‚‚ â†’ ğ’°â‹† Ïâ‚ â†’ ğ’°â‹† Ïâ‚‚ â†’ (M : Î âŠ¢ A)
                  â†’ eval Ïâ‚ M â‰ˆ eval Ïâ‚‚ M
evalâ‰ˆ Ï‡ Ï…â‚ Ï…â‚‚ (` i)   = getâ‰ˆ Ï‡ i
evalâ‰ˆ Ï‡ Ï…â‚ Ï…â‚‚ (Æ› M)   = Î» Î· p uâ‚ uâ‚‚ â†’
                          evalâ‰ˆ (Ï‡ â¬–â‰ˆ Î· , p)
                                (Ï…â‚ â¬–ğ’° Î· , uâ‚)
                                (Ï…â‚‚ â¬–ğ’° Î· , uâ‚‚)
                                M
evalâ‰ˆ Ï‡ Ï…â‚ Ï…â‚‚ (M âˆ™ N) = evalâ‰ˆ Ï‡ Ï…â‚ Ï…â‚‚ M idâ‚‘
                              (evalâ‰ˆ Ï‡ Ï…â‚ Ï…â‚‚ N)
                              (evalğ’° Ï…â‚ N)
                              (evalğ’° Ï…â‚‚ N)


--------------------------------------------------------------------------------


-- (Subá´ºá´¾)
-- NOTE: _â—†ğ’°_ = evalğ’°â‹†
_â—†ğ’°_ : âˆ€ {Î“ Î Î¦} â†’ {Ï : Î“ âŠ©â‹† Î}
                 â†’ (Ïƒ : Î âŠ¢â‹† Î¦) â†’ ğ’°â‹† Ï
                 â†’ ğ’°â‹† (Ïƒ â—† Ï)
âˆ…       â—†ğ’° Ï… = âˆ…
(Ïƒ , M) â—†ğ’° Ï… = Ïƒ â—†ğ’° Ï… , evalğ’° Ï… M

-- (Subá´ºâ‰ˆá¶œ)
-- NOTE: _â—†â‰ˆ_ = evalâ‰ˆâ‹†
_â—†â‰ˆ_ : âˆ€ {Î“ Î Î¦} â†’ {Ïâ‚ Ïâ‚‚ : Î“ âŠ©â‹† Î}
                 â†’ (Ïƒ : Î âŠ¢â‹† Î¦) â†’ Ïâ‚ â‰ˆâ‹† Ïâ‚‚ â†’ ğ’°â‹† Ïâ‚ â†’ ğ’°â‹† Ïâ‚‚
                 â†’ Ïƒ â—† Ïâ‚ â‰ˆâ‹† Ïƒ â—† Ïâ‚‚
(âˆ… â—†â‰ˆ Ï‡)       Ï…â‚ Ï…â‚‚ = âˆ…
((Ïƒ , M) â—†â‰ˆ Ï‡) Ï…â‚ Ï…â‚‚ = (Ïƒ â—†â‰ˆ Ï‡) Ï…â‚ Ï…â‚‚ , evalâ‰ˆ Ï‡ Ï…â‚ Ï…â‚‚ M


--------------------------------------------------------------------------------


-- (Tmâ‚›á´º)
evalâ—† : âˆ€ {Î“ Î Î¦ A} â†’ {Ï : Î“ âŠ©â‹† Î}
                    â†’ Ï â‰ˆâ‹† Ï â†’ ğ’°â‹† Ï â†’ (Ïƒ : Î âŠ¢â‹† Î¦) (M : Î¦ âŠ¢ A)
                    â†’ eval Ï (sub Ïƒ M) â‰ˆ eval (Ïƒ â—† Ï) M

evalâ—† {Ï = Ï} Ï‡ Ï… Ïƒ (` i)
  rewrite getâ—† Ï Ïƒ i
  = evalâ‰ˆ Ï‡ Ï… Ï… (getâ‚› Ïƒ i)

evalâ—† {Ï = Ï} Ï‡ Ï… Ïƒ (Æ› M) Î· {aâ‚} {aâ‚‚} p uâ‚ uâ‚‚
  rewrite compâ—†â¬– Î· Ï… Ïƒ
  = let
      Ï…â€² = Ï… â¬–ğ’° Î·
    in
        evalâ—† {Ï = Ï â¬– Î· , aâ‚}
              ((Ï‡ â¬–â‰ˆ Î·) , (p â¦™ p â»Â¹))
              (Ï… â¬–ğ’° Î· , uâ‚)
              (liftâ‚› Ïƒ)
              M
      â¦™ cast
          evalâ‰ˆ ((Ïƒ â—†â‰ˆ (Ï‡ â¬–â‰ˆ Î·)) Ï…â€² Ï…â€² , p)
                (Ïƒ â—†ğ’° Ï…â€² , uâ‚)
                (Ïƒ â—†ğ’° Ï…â€² , uâ‚‚)
                M
        via
          ((Î» Ïâ€² â†’ eval (Ïâ€² , aâ‚) M â‰ˆ _)
           & ( compâ—†â¬— (Ï â¬– Î· , aâ‚) (wkâ‚‘ idâ‚‘) Ïƒ
             â¦™ (Ïƒ â—†_) & lidâ¬— (Ï â¬– Î·)
             ) â»Â¹)

evalâ—† {Ï = Ï} Ï‡ Ï… Ïƒ (M âˆ™ N)
  = evalâ—† Ï‡ Ï… Ïƒ M
          idâ‚‘
          (evalâ—† Ï‡ Ï… Ïƒ N)
          (evalğ’° Ï… (sub Ïƒ N))
          (evalğ’° (Ïƒ â—†ğ’° Ï…) N)


--------------------------------------------------------------------------------


-- (~â‰ˆ)
evalâˆ¼ : âˆ€ {Î“ Î A} â†’ {Ïâ‚ Ïâ‚‚ : Î“ âŠ©â‹† Î} {Mâ‚ Mâ‚‚ : Î âŠ¢ A}
                  â†’ Ïâ‚ â‰ˆâ‹† Ïâ‚‚ â†’ ğ’°â‹† Ïâ‚ â†’ ğ’°â‹† Ïâ‚‚ â†’ Mâ‚ âˆ¼ Mâ‚‚
                  â†’ eval Ïâ‚ Mâ‚ â‰ˆ eval Ïâ‚‚ Mâ‚‚

evalâˆ¼ {Mâ‚ = Mâ‚} Ï‡ Ï…â‚ Ï…â‚‚ reflâˆ¼
  = evalâ‰ˆ Ï‡ Ï…â‚ Ï…â‚‚ Mâ‚

evalâˆ¼ Ï‡ Ï…â‚ Ï…â‚‚ (p â»Â¹âˆ¼)
  = evalâˆ¼ (Ï‡ â»Â¹) Ï…â‚‚ Ï…â‚ p â»Â¹

evalâˆ¼ Ï‡ Ï…â‚ Ï…â‚‚ (p â¦™âˆ¼ q)
  = evalâˆ¼ (Ï‡ â¦™ Ï‡ â»Â¹) Ï…â‚ Ï…â‚ p
  â¦™ evalâˆ¼ Ï‡ Ï…â‚ Ï…â‚‚ q

evalâˆ¼ Ï‡ Ï…â‚ Ï…â‚‚ (Æ›âˆ¼ p)
  = Î» Î· q uâ‚ uâ‚‚ â†’
      evalâˆ¼ (Ï‡ â¬–â‰ˆ Î· , q)
            (Ï…â‚ â¬–ğ’° Î· , uâ‚)
            (Ï…â‚‚ â¬–ğ’° Î· , uâ‚‚)
            p

evalâˆ¼ Ï‡ Ï…â‚ Ï…â‚‚ (_âˆ™âˆ¼_ {Nâ‚ = Nâ‚} {Nâ‚‚} p q)
  = evalâˆ¼ Ï‡ Ï…â‚ Ï…â‚‚ p
          idâ‚‘
          (evalâˆ¼ Ï‡ Ï…â‚ Ï…â‚‚ q)
          (evalğ’° Ï…â‚ Nâ‚)
          (evalğ’° Ï…â‚‚ Nâ‚‚)

evalâˆ¼ {Ïâ‚ = Ïâ‚} {Ïâ‚‚} Ï‡ Ï…â‚ Ï…â‚‚ (Î²redâˆ¼ M N)
  = cast
      evalâ‰ˆ (Ï‡ , evalâ‰ˆ Ï‡ Ï…â‚ Ï…â‚‚ N)
            (Ï…â‚ , evalğ’° Ï…â‚ N)
            (Ï…â‚‚ , evalğ’° Ï…â‚‚ N)
            M
    via
      ((Î» Ïâ‚â€² Ïâ‚‚â€² â†’ eval (Ïâ‚â€² , eval Ïâ‚ N) M â‰ˆ eval (Ïâ‚‚â€² , eval Ïâ‚‚ N) M)
      & (lidâ¬– Ïâ‚ â»Â¹)
      âŠ— (lidâ—† Ïâ‚‚ â»Â¹))
  â¦™ evalâ—† (Ï‡ â»Â¹ â¦™ Ï‡) Ï…â‚‚ (idâ‚› , N) M â»Â¹

evalâˆ¼ {Ïâ‚‚ = Ïâ‚‚} Ï‡ Ï…â‚ Ï…â‚‚ (Î·expâˆ¼ M) Î· {aâ‚‚ = aâ‚‚} p uâ‚ uâ‚‚
  rewrite evalâ¬— (Ïâ‚‚ â¬– Î· , aâ‚‚) (wkâ‚‘ idâ‚‘) M â»Â¹
        | lidâ¬— (Ïâ‚‚ â¬– Î·)
        | evalâ¬– Î· Ï…â‚‚ M
        | ridâ—‹ Î·
  = evalâ‰ˆ Ï‡ Ï…â‚ Ï…â‚‚ M Î· p uâ‚ uâ‚‚


--------------------------------------------------------------------------------


mutual
  -- (qâ‰ˆ)
  reifyâ‰ˆ : âˆ€ {A Î“} â†’ {aâ‚ aâ‚‚ : Î“ âŠ© A}
                   â†’ aâ‚ â‰ˆ aâ‚‚
                   â†’ reify aâ‚ â‰¡ reify aâ‚‚
  reifyâ‰ˆ {âµ}     p = p
  reifyâ‰ˆ {A âŠƒ B} F = Æ› & reifyâ‰ˆ (F (wkâ‚‘ {A = A} idâ‚‘)
                                   (reflectâ‰ˆ refl)
                                   (reflectğ’° (` zero))
                                   (reflectğ’° (` zero)))

  -- (uâ‰ˆ)
  reflectâ‰ˆ : âˆ€ {A Î“} â†’ {Mâ‚ Mâ‚‚ : Î“ âŠ¢â¿áµ‰ A}
                     â†’ Mâ‚ â‰¡ Mâ‚‚
                     â†’ reflect Mâ‚ â‰ˆ reflect Mâ‚‚
  reflectâ‰ˆ {âµ}     p = ne & p
  reflectâ‰ˆ {A âŠƒ B} p = Î» Î· q uâ‚ uâ‚‚ â†’
                         reflectâ‰ˆ (_âˆ™_ & (renâ¿áµ‰ Î· & p)
                                       âŠ— reifyâ‰ˆ q)


-- (uá¶œâ‰ˆ)
idâ‰ˆ : âˆ€ {Î“} â†’ idáµ¥ {Î“} â‰ˆâ‹† idáµ¥
idâ‰ˆ {âˆ…}     = âˆ…
idâ‰ˆ {Î“ , A} = idâ‰ˆ â¬–â‰ˆ wkâ‚‘ idâ‚‘ , reflectâ‰ˆ refl


sound : âˆ€ {Î“ A} â†’ {Mâ‚ Mâ‚‚ : Î“ âŠ¢ A}
                â†’ Mâ‚ âˆ¼ Mâ‚‚
                â†’ nf Mâ‚ â‰¡ nf Mâ‚‚
sound p = reifyâ‰ˆ (evalâˆ¼ idâ‰ˆ idğ’° idğ’° p)


--------------------------------------------------------------------------------
