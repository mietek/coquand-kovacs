module STLC2.Kovacs.Completeness where

open import STLC2.Kovacs.Normalisation public
open import STLC2.Kovacs.Convertibility public


-- TODO: Remove this
postulate
  â–ˆ : âˆ€ {â„“} â†’ {X : Set â„“} â†’ X


--------------------------------------------------------------------------------


-- (_â‰ˆ_)
mutual
  infix 3 _â‰«_
  _â‰«_ : âˆ€ {A Î“} â†’ Î“ âŠ¢ A â†’ Î“ âŠ© A â†’ Set

  _â‰«_ {âµ}      {Î“} M N = M âˆ¼ embâ¿á¶  N

  _â‰«_ {A â‡’ B} {Î“} M f = âˆ€ {Î“â€²} â†’ (Î· : Î“â€² âŠ‡ Î“)
                                â†’ {N : Î“â€² âŠ¢ A} {âˆ‚a : Î“â€² âˆ‚âŠ© A}
                                â†’ N âˆ‚â‰« âˆ‚a
                                â†’ ren Î· M âˆ™ N âˆ‚â‰« f Î· âˆ‚a

  _â‰«_ {A â©• B}  {Î“} M s = Ï€â‚ M âˆ‚â‰« projâ‚ s Ã— Ï€â‚‚ M âˆ‚â‰« projâ‚‚ s

  _â‰«_ {â«ª}     {Î“} M s = âŠ¤

  _â‰«_ {â««}     {Î“} M s = âŠ¥

  _â‰«_ {A â©– B}  {Î“} M s = elimâŠ s (Î» âˆ‚a â†’ Î£ (Î“ âŠ¢ A) (Î» Mâ‚ â†’ Mâ‚ âˆ‚â‰« âˆ‚a))
                                 (Î» âˆ‚b â†’ Î£ (Î“ âŠ¢ B) (Î» Mâ‚‚ â†’ Mâ‚‚ âˆ‚â‰« âˆ‚b))


  infix 3 _âˆ‚â‰«_
  _âˆ‚â‰«_ : âˆ€ {Î“ A} â†’ Î“ âŠ¢ A â†’ Î“ âˆ‚âŠ© A â†’ Set

  _âˆ‚â‰«_ {Î“} {A} M âˆ‚a
    = âˆ€ {Î“â€² C} â†’ (Î· : Î“â€² âŠ‡ Î“)
               â†’ {N : Î“â€² âŠ¢ C}
               â†’ {Nâ¿á¶  : Î“â€² âŠ¢â¿á¶  C}
               â†’ (f : âˆ€ {Î“â€³} â†’ (Î·â€² : Î“â€³ âŠ‡ Î“â€²)
                              â†’ {a : Î“â€³ âŠ© A}
                              â†’ ren (Î· â—‹ Î·â€²) M â‰« a
                              â†’ ren Î·â€² N âˆ¼ embâ¿á¶  (renâ¿á¶  Î·â€² Nâ¿á¶ ))
               â†’ N âˆ¼ embâ¿á¶  Nâ¿á¶ 


-- (_â‰ˆá¶œ_)
infix 3 _âˆ‚â‰«â‹†_
data _âˆ‚â‰«â‹†_ : âˆ€ {Î“ Î} â†’ Î“ âŠ¢â‹† Î â†’ Î“ âˆ‚âŠ©â‹† Î â†’ Set
  where
    âˆ…   : âˆ€ {Î“} â†’ âˆ… {Î“} âˆ‚â‰«â‹† âˆ…

    _,_ : âˆ€ {Î“ Î A} â†’ {Ïƒ : Î“ âŠ¢â‹† Î} {Ï : Î“ âˆ‚âŠ©â‹† Î}
                    â†’ (Ï‡ : Ïƒ âˆ‚â‰«â‹† Ï)
                    â†’ {M : Î“ âŠ¢ A} {âˆ‚a : Î“ âˆ‚âŠ© A}
                    â†’ (âˆ‚q : M âˆ‚â‰« âˆ‚a)
                    â†’ Ïƒ , M âˆ‚â‰«â‹† Ï , âˆ‚a


--------------------------------------------------------------------------------


-- (_âˆ¼â—¾â‰ˆ_)
mutual
  coeâ‰« : âˆ€ {A Î“} â†’ {Mâ‚ Mâ‚‚ : Î“ âŠ¢ A}
                 â†’ Mâ‚ âˆ¼ Mâ‚‚ â†’ {a : Î“ âŠ© A} â†’ Mâ‚ â‰« a
                 â†’ Mâ‚‚ â‰« a
  coeâ‰« {âµ}      p {N}      q = p â»Â¹ â¦™ q
  coeâ‰« {A â‡’ B} p {f}      g = Î» Î· {N} {âˆ‚a} âˆ‚q â†’
                                 âˆ‚coeâ‰« {âˆ‚a = Î» Î·â€² fâ€² â†’ f Î· âˆ‚a Î·â€² fâ€²}
                                       (renâˆ¼ Î· p âˆ™âˆ¼ (reflâˆ¼ {M = N}))
                                       (g Î· {N} {âˆ‚a} âˆ‚q)
  coeâ‰« {A â©• B}  p {s}      q = âˆ‚coeâ‰« {âˆ‚a = projâ‚ s} (Ï€â‚âˆ¼ p) (projâ‚ q) ,
                               âˆ‚coeâ‰« {âˆ‚a = projâ‚‚ s} (Ï€â‚‚âˆ¼ p) (projâ‚‚ q)
  coeâ‰« {â«ª}     p {s}      q = tt
  coeâ‰« {â««}     p {s}      q = elimâŠ¥ s
  coeâ‰« {A â©– B}  p {injâ‚ a} q = q
  coeâ‰« {A â©– B}  p {injâ‚‚ b} q = q


  âˆ‚coeâ‰« : âˆ€ {A Î“} â†’ {Mâ‚ Mâ‚‚ : Î“ âŠ¢ A} {âˆ‚a : Î“ âˆ‚âŠ© A}
                  â†’ Mâ‚ âˆ¼ Mâ‚‚ â†’ Mâ‚ âˆ‚â‰« âˆ‚a
                  â†’ Mâ‚‚ âˆ‚â‰« âˆ‚a

  âˆ‚coeâ‰« p âˆ‚q
    = Î» Î· {N} {Nâ¿á¶ } f â†’
        âˆ‚q Î· {N} {Nâ¿á¶ } (Î» Î·â€² {a} q â†’
          f Î·â€² (coeâ‰« (renâˆ¼ (Î· â—‹ Î·â€²) p)
                     q))


--------------------------------------------------------------------------------


-- (â‰ˆâ‚‘)
mutual
  accâ‰« : âˆ€ {A Î“ Î“â€²} â†’ (Î· : Î“â€² âŠ‡ Î“)
                    â†’ {M : Î“ âŠ¢ A} {a : Î“ âŠ© A}
                    â†’ M â‰« a
                    â†’ ren Î· M â‰« acc Î· a
  accâ‰« {âµ}      Î· {M} {N}      p         = coe ((Î» Nâ€² â†’ ren Î· M âˆ¼ Nâ€²)
                                                & natembâ¿á¶  Î· N â»Â¹)
                                               (renâˆ¼ Î· p)
  accâ‰« {A â‡’ B} Î· {M} {f}      g         Î·â€² {N} {âˆ‚a}
                                         rewrite renâ—‹ Î·â€² Î· M â»Â¹
                                         = g (Î· â—‹ Î·â€²) {N} {âˆ‚a}
  accâ‰« {A â©• B}  Î· {M} {s}      q         = âˆ‚accâ‰« Î· {Ï€â‚ M} {projâ‚ s} (projâ‚ q)
                                         , âˆ‚accâ‰« Î· {Ï€â‚‚ M} {projâ‚‚ s} (projâ‚‚ q)
  accâ‰« {â«ª}     Î· {M} {s}      q         = tt
  accâ‰« {â««}     Î· {M} {s}      q         = elimâŠ¥ s
  accâ‰« {A â©– B}  Î· {M} {injâ‚ a} (Mâ‚ , âˆ‚a) = ren Î· Mâ‚ , âˆ‚accâ‰« Î· {Mâ‚} {a} âˆ‚a
  accâ‰« {A â©– B}  Î· {M} {injâ‚‚ b} (Mâ‚‚ , âˆ‚b) = ren Î· Mâ‚‚ , âˆ‚accâ‰« Î· {Mâ‚‚} {b} âˆ‚b


  âˆ‚accâ‰« : âˆ€ {A Î“ Î“â€²} â†’ (Î· : Î“â€² âŠ‡ Î“)
                     â†’ {M : Î“ âŠ¢ A} {âˆ‚a : Î“ âˆ‚âŠ© A}
                     â†’ M âˆ‚â‰« âˆ‚a
                     â†’ ren Î· M âˆ‚â‰« âˆ‚acc Î· âˆ‚a

  âˆ‚accâ‰« Î· {M} âˆ‚q
    = Î» Î·â€² {N} {Nâ¿á¶ } f â†’
        âˆ‚q (Î· â—‹ Î·â€²) {N} {Nâ¿á¶ } (Î» Î·â€³ q â†’
          f Î·â€³ (coeâ‰« (coe (_âˆ¼_ & ((Î» Î·â€´ â†’ ren Î·â€´ M) & assocâ—‹ Î·â€³ Î·â€² Î· â»Â¹)
                               âŠ— renâ—‹ (Î·â€² â—‹ Î·â€³) Î· M)
                          reflâˆ¼)
                     q))


-- (â‰ˆá¶œâ‚‘)
-- NOTE: _â¬–â‰«_ = âˆ‚accâ‰«â‹†
_â¬–â‰«_ : âˆ€ {Î“ Î“â€² Î} â†’ {Ïƒ : Î“ âŠ¢â‹† Î} {Ï : Î“ âˆ‚âŠ©â‹† Î}
                  â†’ (Ï‡ : Ïƒ âˆ‚â‰«â‹† Ï) (Î· : Î“â€² âŠ‡ Î“)
                  â†’ Ïƒ â— Î· âˆ‚â‰«â‹† Ï â¬– Î·
âˆ…                 â¬–â‰« Î· = âˆ…
_,_ Ï‡ {M} {âˆ‚a} âˆ‚q â¬–â‰« Î· = Ï‡ â¬–â‰« Î· , âˆ‚accâ‰« Î· {M} {âˆ‚a} âˆ‚q


--------------------------------------------------------------------------------


returnâ‰« : âˆ€ {A Î“} â†’ {M : Î“ âŠ¢ A} {a : Î“ âŠ© A}
                  â†’ M â‰« a â†’ M âˆ‚â‰« return a

returnâ‰« {M = M} {a} q
  = Î» Î· {N} {Nâ¿á¶ } f â†’
      coe (_âˆ¼_ & idren N
               âŠ— embâ¿á¶  & idrenâ¿á¶  Nâ¿á¶ )
          (f idâ‚‘ {acc Î· a}
                 (coeâ‰« (coe ((Î» Î·â€² â†’ ren Î· M âˆ¼ ren Î·â€² M)
                             & (ridâ—‹ Î· â»Â¹))
                            reflâˆ¼)
                       (accâ‰« Î· {M} {a} q)))


bindâ‰« : âˆ€ {A C Î“} â†’ {M : Î“ âŠ¢ A} {âˆ‚a : Î“ âˆ‚âŠ© A}
                     {N : Î“ âŠ¢ C} {âˆ‚c : Î“ âˆ‚âŠ© C}
                  â†’ M âˆ‚â‰« âˆ‚a â†’ (âˆ€ {Î“â€²} â†’ (Î· : Î“â€² âŠ‡ Î“)
                                        â†’ {a : Î“â€² âŠ© A}
                                        â†’ ren Î· M â‰« a
                                        â†’ ren Î· N âˆ‚â‰« âˆ‚acc Î· âˆ‚c)
                  â†’ N âˆ‚â‰« âˆ‚c

bindâ‰« {M = M} {âˆ‚a} {N} {âˆ‚c} âˆ‚q f
  = Î» Î· {Nâ€²} {Nâ¿á¶ â€²} fâ€² â†’
      âˆ‚q Î· {Nâ€²} {Nâ¿á¶ â€²} (Î» Î·â€² {a} q â†’
        f (Î· â—‹ Î·â€²) {a} q idâ‚‘ {ren Î·â€² Nâ€²} {renâ¿á¶  Î·â€² Nâ¿á¶ â€²} (Î» Î·â€³ {c} qâ€² â†’
          coe (_âˆ¼_ & renâ—‹ Î·â€³ Î·â€² Nâ€²
                   âŠ— embâ¿á¶  & renâ¿á¶ â—‹ Î·â€³ Î·â€² Nâ¿á¶ â€²)
              (fâ€² (Î·â€² â—‹ Î·â€³) (coeâ‰« (coe (_âˆ¼_ & renâ—‹ (idâ‚‘ â—‹ Î·â€³) (Î· â—‹ Î·â€²) N
                                            âŠ— (Î» Î·â€´ â†’ ren Î·â€´ N)
                                              & ( (Î» Î·â€´ â†’ (Î· â—‹ Î·â€²) â—‹ Î·â€´)
                                                  & lidâ—‹ Î·â€³
                                                â¦™ assocâ—‹ Î·â€³ Î·â€² Î·
                                                ))
                                       reflâˆ¼)
                                  qâ€²))))


--------------------------------------------------------------------------------


-- (âˆˆâ‰ˆ)
getâ‰« : âˆ€ {Î“ Î A} â†’ {Ïƒ : Î“ âŠ¢â‹† Î} {Ï : Î“ âˆ‚âŠ©â‹† Î}
                 â†’ Ïƒ âˆ‚â‰«â‹† Ï â†’ (i : Î âˆ‹ A)
                 â†’ getâ‚› Ïƒ i âˆ‚â‰« getáµ¥ Ï i
getâ‰« (Ï‡ , p) zero    = p
getâ‰« (Ï‡ , p) (suc i) = getâ‰« Ï‡ i


-- (Tmâ‰ˆ)
evalâ‰« : âˆ€ {Î“ Î A} â†’ {Ïƒ : Î“ âŠ¢â‹† Î} {Ï : Î“ âˆ‚âŠ©â‹† Î}
                 â†’ Ïƒ âˆ‚â‰«â‹† Ï â†’ (M : Î âŠ¢ A)
                 â†’ sub Ïƒ M âˆ‚â‰« eval Ï M

evalâ‰« {Ïƒ = Ïƒ} {Ï} Ï‡ (ğ“‹ i)
  = getâ‰« Ï‡ i

evalâ‰« {Ïƒ = Ïƒ} {Ï} Ï‡ (Æ› M)
  = returnâ‰« {M = Æ› (sub (liftâ‚› Ïƒ) M)}
            {a = Î» {Î“â€²} Î· âˆ‚a â†’ eval (Ï â¬– Î· , âˆ‚a) M}
            (Î» {Î“â€²} Î· {N} {âˆ‚a} âˆ‚q â†’
              âˆ‚coeâ‰« {âˆ‚a = eval (Ï â¬– Î· , âˆ‚a) M}
                    (coe (((Æ› (ren (liftâ‚‘ Î·) (sub (liftâ‚› Ïƒ) M)) âˆ™ N) âˆ¼_)
                          & ( subâ—‘ (idâ‚› , N) (liftâ‚‘ Î·) (sub (liftâ‚› Ïƒ) M) â»Â¹
                            â¦™ subâ— (liftâ‚‘ Î· â—‘ (idâ‚› , N)) (liftâ‚› Ïƒ) M â»Â¹
                            â¦™ (Î» Ïƒâ€² â†’ sub (Ïƒâ€² , N) M)
                              & ( compâ—â—‘ (Î· â—‘ idâ‚› , N) (wkâ‚‘ idâ‚‘) Ïƒ
                                â¦™ (Ïƒ â—_) & lidâ—‘ (Î· â—‘ idâ‚›)
                                â¦™ compâ—â—‘ idâ‚› Î· Ïƒ â»Â¹
                                â¦™ ridâ— (Ïƒ â— Î·)
                                )
                            ))
                         (redâ‡’ (ren (liftâ‚‘ Î·) (sub (liftâ‚› Ïƒ) M)) N) â»Â¹)
                    (evalâ‰« (_,_ (Ï‡ â¬–â‰« Î·) {âˆ‚a = âˆ‚a} (âˆ‚q)) M))

evalâ‰« {Ïƒ = Ïƒ} {Ï} Ï‡ (M âˆ™ N)
  = bindâ‰« {M  = sub Ïƒ M}
          {âˆ‚a = eval Ï M}
          {N  = sub Ïƒ M âˆ™ sub Ïƒ N}
          {âˆ‚c = eval Ï M âˆ‚!âˆ™ eval Ï N}
          (evalâ‰« Ï‡ M)
          (Î» Î· {f} g â†’
            âˆ‚coeâ‰« {âˆ‚a = eval (Ï â¬– Î·) M âˆ‚!âˆ™ eval (Ï â¬– Î·) N}
                  (coe (_âˆ¼_ & ((Î» Mâ€² â†’ Mâ€² âˆ™ ren Î· (sub Ïƒ N))
                               & ( (Î» Î·â€² â†’ ren Î·â€² (sub Ïƒ M))
                                   & (ridâ—‹ Î· â»Â¹)
                                 â¦™ renâ—‹ idâ‚‘ Î· (sub Ïƒ M)
                                 ))
                            âŠ— refl)
                       reflâˆ¼)
                  (g idâ‚‘ {âˆ‚a = âˆ‚acc Î· (eval Ï N)}
                         (âˆ‚coeâ‰« {âˆ‚a = eval (Ï â¬– Î·) N}
                                (â‰¡â†’âˆ¼ (subâ— Î· Ïƒ N))
                                (evalâ‰« (Ï‡ â¬–â‰« Î·) N))))

evalâ‰« {Ïƒ = Ïƒ} {Ï} Ï‡ (M , N)
  = returnâ‰« {M = sub Ïƒ M , sub Ïƒ N}
            {a = eval Ï M , eval Ï N}
            ( âˆ‚coeâ‰« {âˆ‚a = eval Ï M}
                    (redâ©•â‚ (sub Ïƒ M) (sub Ïƒ N) â»Â¹)
                    (evalâ‰« Ï‡ M)
            , âˆ‚coeâ‰« {âˆ‚a = eval Ï N}
                    (redâ©•â‚‚ (sub Ïƒ M) (sub Ïƒ N) â»Â¹)
                    (evalâ‰« Ï‡ N)
            )

evalâ‰« {Ïƒ = Ïƒ} {Ï} Ï‡ (Ï€â‚ M)
  = bindâ‰« {M  = sub Ïƒ M}
          {âˆ‚a = eval Ï M}
          {N  = Ï€â‚ (sub Ïƒ M)}
          {âˆ‚c = âˆ‚!Ï€â‚ (eval Ï M)}
          (evalâ‰« Ï‡ M)
          (Î» Î· q â†’ projâ‚ q)

evalâ‰« {Ïƒ = Ïƒ} {Ï} Ï‡ (Ï€â‚‚ M)
  = bindâ‰« {M  = sub Ïƒ M}
          {âˆ‚a = eval Ï M}
          {N  = Ï€â‚‚ (sub Ïƒ M)}
          {âˆ‚c = âˆ‚!Ï€â‚‚ (eval Ï M)}
          (evalâ‰« Ï‡ M)
          (Î» Î· q â†’ projâ‚‚ q)

evalâ‰« {Ïƒ = Ïƒ} {Ï} Ï‡ Ï„
  = returnâ‰« {M = Ï„} tt

evalâ‰« {Ïƒ = Ïƒ} {Ï} Ï‡ (Ï† M)
  = bindâ‰« {M  = sub Ïƒ M}
          {âˆ‚a = eval Ï M}
          {N  = Ï† (sub Ïƒ M)}
          {âˆ‚c = âˆ‚!Ï† (eval Ï M)}
          (evalâ‰« Ï‡ M)
          (Î» Î· q â†’ elimâŠ¥ q)

evalâ‰« {Ïƒ = Ïƒ} {Ï} Ï‡ (Î¹â‚ M)
  = returnâ‰« {M = Î¹â‚ (sub Ïƒ M)}
            {a = injâ‚ (eval Ï M)}
            (sub Ïƒ M , evalâ‰« Ï‡ M)

evalâ‰« {Ïƒ = Ïƒ} {Ï} Ï‡ (Î¹â‚‚ M)
  = returnâ‰« {M = Î¹â‚‚ (sub Ïƒ M)}
            {a = injâ‚‚ (eval Ï M)}
            (sub Ïƒ M , evalâ‰« Ï‡ M)

evalâ‰« {Ïƒ = Ïƒ} {Ï} Ï‡ (M â‡ Nâ‚ âˆ¥ Nâ‚‚)
  = bindâ‰« {M  = sub Ïƒ M}
          {âˆ‚a = eval Ï M}
          {N  = sub Ïƒ M â‡ sub (liftâ‚› Ïƒ) Nâ‚
                        âˆ¥ sub (liftâ‚› Ïƒ) Nâ‚‚}
          {âˆ‚c = eval Ï M âˆ‚!â‡ (Î» Î· âˆ‚a â†’ eval (Ï â¬– Î· , âˆ‚a) Nâ‚)
                         âˆ‚!âˆ¥ (Î» Î· âˆ‚b â†’ eval (Ï â¬– Î· , âˆ‚b) Nâ‚‚)}
          (evalâ‰« Ï‡ M)
          (Î» { Î· {injâ‚ âˆ‚a} (Mâ‚ , âˆ‚q) â†’
                 Î» Î·â€² {N} {Nâ¿á¶ } f â†’
                   âˆ‚q Î·â€² {N} {Nâ¿á¶ } (Î» Î·â€³ {a} q â†’
                     â–ˆ)
             ; Î· {injâ‚‚ âˆ‚b} (Mâ‚‚ , âˆ‚q) â†’
                 Î» Î·â€² {N} {Nâ¿á¶ } f â†’
                   âˆ‚q Î·â€² {N} {Nâ¿á¶ } (Î» Î·â€³ {a} q â†’
                     â–ˆ)
             })


--------------------------------------------------------------------------------


mutual
  -- (qâ‰ˆ)
  reifyâ‰« : âˆ€ {A Î“} â†’ {M : Î“ âŠ¢ A} {a : Î“ âˆ‚âŠ© A}
                   â†’ (âˆ‚q : M âˆ‚â‰« a)
                   â†’ M âˆ¼ embâ¿á¶  (reify a)

  reifyâ‰« {âµ} {M = M} {âˆ‚a} âˆ‚q
    = âˆ‚q idâ‚‘ {M} {reify âˆ‚a} (Î» Î· {N} p â†’
        â–ˆ)

  reifyâ‰« {A â‡’ B} {M = M} {âˆ‚a} âˆ‚q
    = âˆ‚q idâ‚‘ {M} {reify âˆ‚a} (Î» Î· {f} g â†’
        â–ˆ)

  reifyâ‰« {A â©• B} {M = M} {âˆ‚a} âˆ‚q
    = âˆ‚q idâ‚‘ {M} {reify âˆ‚a} (Î» Î· {s} q â†’
        â–ˆ)

  reifyâ‰« {â«ª} {M = M} {âˆ‚a} âˆ‚q
    = âˆ‚q idâ‚‘ {M} {reify âˆ‚a} (Î» Î· {s} q â†’
        coe ((Î» Mâ€² â†’ ren Î· M âˆ¼ Mâ€²)
             & natembâ¿á¶  Î· (âˆ‚a idâ‚‘ (Î» Î·â€² sâ€² â†’ Ï„)) â»Â¹)
            (renâˆ¼ {Mâ‚ = M}
                  {Mâ‚‚ = embâ¿á¶  (âˆ‚a idâ‚‘ (Î» Î·â€² sâ€² â†’ Ï„))}
                  Î·
                  â–ˆ))

  reifyâ‰« {â««} {M = M} {âˆ‚a} âˆ‚q
    = âˆ‚q idâ‚‘ {M} {reify âˆ‚a} (Î» Î· {s} q â†’
        â–ˆ)

  reifyâ‰« {A â©– B} {M = M} {âˆ‚a} âˆ‚q
    = âˆ‚q idâ‚‘ {M} {reify âˆ‚a} (Î» Î· {s} q â†’
        â–ˆ)


  -- (uâ‰ˆ)
  reflectâ‰« : âˆ€ {A Î“} â†’ (M : Î“ âŠ¢â¿áµ‰ A)
                     â†’ embâ¿áµ‰ M âˆ‚â‰« reflect M

  reflectâ‰« {âµ} M
    = returnâ‰« {M = embâ¿áµ‰ M}
              {a = ne M}
              reflâˆ¼

  reflectâ‰« {A â‡’ B} M
    = returnâ‰« {M = embâ¿áµ‰ M}
              {a = Î» Î· âˆ‚a â†’ reflect (renâ¿áµ‰ Î· M âˆ™ reify âˆ‚a)}
              (Î» Î· {N} {âˆ‚a} âˆ‚q â†’
                âˆ‚coeâ‰« {âˆ‚a = âˆ‚acc Î· (reflect M) âˆ‚!âˆ™ âˆ‚a}
                      (â‰¡â†’âˆ¼ (natembâ¿áµ‰ Î· M â»Â¹) âˆ™âˆ¼ reifyâ‰« âˆ‚q â»Â¹)
                      (reflectâ‰« (renâ¿áµ‰ Î· M âˆ™ reify âˆ‚a)))

  reflectâ‰« {A â©• B} M
    = returnâ‰« {M = embâ¿áµ‰ M}
              {a = reflect (Ï€â‚ M) , reflect (Ï€â‚‚ M)}
              (reflectâ‰« (Ï€â‚ M) , reflectâ‰« (Ï€â‚‚ M))

  reflectâ‰« {â«ª} M
    = returnâ‰« {M = embâ¿áµ‰ M}
              {a = tt}
              tt

  reflectâ‰« {â««} M
    = Î» Î· {N} {Nâ¿á¶ } f â†’
        coe (_âˆ¼_ & idren N
                 âŠ— embâ¿á¶  & idrenâ¿á¶  Nâ¿á¶ )
            (f idâ‚‘ {â–ˆ} â–ˆ)

  reflectâ‰« {A â©– B} M
    = Î» Î· {N} {Nâ¿á¶ } f â†’
        coe (_âˆ¼_ & idren N
                 âŠ— embâ¿á¶  & idrenâ¿á¶  Nâ¿á¶ )
            (f idâ‚‘ {â–ˆ} â–ˆ)


--------------------------------------------------------------------------------


-- (uá¶œâ‰ˆ)
idâ‰«â‹† : âˆ€ {Î“} â†’ idâ‚› {Î“} âˆ‚â‰«â‹† idáµ¥
idâ‰«â‹† {âˆ…}     = âˆ…
idâ‰«â‹† {Î“ , A} = idâ‰«â‹† â¬–â‰« wkâ‚‘ idâ‚‘ , reflectâ‰« 0


complete : âˆ€ {Î“ A} â†’ (M : Î“ âŠ¢ A)
                   â†’ M âˆ¼ embâ¿á¶  (nf M)
complete M = coe ((_âˆ¼ embâ¿á¶  (reify (eval idáµ¥ M))) & idsub M)
                 (reifyâ‰« (evalâ‰« idâ‰«â‹† M))


--------------------------------------------------------------------------------
