module STLC2.Kovacs.Normalisation where

open import STLC2.Kovacs.NormalForm public


--------------------------------------------------------------------------------


-- (Tyá´º)
mutual
  infix 3 _âŠ©_
  _âŠ©_ : ğ’ â†’ ğ’¯ â†’ Set

  Î“ âŠ© âµ      = Î“ âŠ¢â¿á¶  âµ

  Î“ âŠ© A â‡’ B = âˆ€ {Î“â€²} â†’ (Î· : Î“â€² âŠ‡ Î“) (âˆ‚a : Î“â€² âˆ‚âŠ© A)
                       â†’ Î“â€² âˆ‚âŠ© B

  Î“ âŠ© A â©• B  = Î“ âˆ‚âŠ© A Ã— Î“ âˆ‚âŠ© B

  Î“ âŠ© â«ª     = âŠ¤

  Î“ âŠ© â««     = âŠ¥

  Î“ âŠ© A â©– B  = Î“ âˆ‚âŠ© A âŠ Î“ âˆ‚âŠ© B


  infix 3 _âˆ‚âŠ©_
  _âˆ‚âŠ©_ : ğ’ â†’ ğ’¯ â†’ Set
  Î“ âˆ‚âŠ© A = âˆ€ {Î“â€² C} â†’ (Î· : Î“â€² âŠ‡ Î“)
                     â†’ (f : âˆ€ {Î“â€³} â†’ Î“â€³ âŠ‡ Î“â€² â†’ Î“â€³ âŠ© A â†’ Î“â€³ âŠ¢â¿á¶  C)
                     â†’ Î“â€² âŠ¢â¿á¶  C


-- (Coná´º ; âˆ™ ; _,_)
infix 3 _âˆ‚âŠ©â‹†_
data _âˆ‚âŠ©â‹†_ : ğ’ â†’ ğ’ â†’ Set
  where
    âˆ…   : âˆ€ {Î“} â†’ Î“ âˆ‚âŠ©â‹† âˆ…

    _,_ : âˆ€ {Î“ Î A} â†’ (Ï : Î“ âˆ‚âŠ©â‹† Î) (âˆ‚a : Î“ âˆ‚âŠ© A)
                    â†’ Î“ âˆ‚âŠ©â‹† Î , A


--------------------------------------------------------------------------------


-- (Tyá´ºâ‚‘)
mutual
  acc : âˆ€ {A Î“ Î“â€²} â†’ Î“â€² âŠ‡ Î“ â†’ Î“ âŠ© A â†’ Î“â€² âŠ© A
  acc {âµ}      Î· M        = renâ¿á¶  Î· M
  acc {A â‡’ B} Î· f        = Î» Î·â€² a â†’ f (Î· â—‹ Î·â€²) a
  acc {A â©• B}  Î· s        = âˆ‚acc Î· (projâ‚ s) , âˆ‚acc Î· (projâ‚‚ s)
  acc {â«ª}     Î· s        = tt
  acc {â««}     Î· s        = elimâŠ¥ s
  acc {A â©– B}  Î· (injâ‚ a) = injâ‚ (âˆ‚acc Î· a)
  acc {A â©– B}  Î· (injâ‚‚ b) = injâ‚‚ (âˆ‚acc Î· b)
  -- TODO: Why doesnâ€™t this work?
  -- acc {A â©– B}  Î· s = caseâŠ s (Î» a â†’ âˆ‚acc Î· a)
  --                            (Î» b â†’ âˆ‚acc Î· b)

  âˆ‚acc : âˆ€ {A Î“ Î“â€²} â†’ Î“â€² âŠ‡ Î“ â†’ Î“ âˆ‚âŠ© A â†’ Î“â€² âˆ‚âŠ© A
  âˆ‚acc Î· âˆ‚a = Î» Î·â€² f â†’ âˆ‚a (Î· â—‹ Î·â€²) f


-- (Coná´ºâ‚‘)
-- NOTE: _â¬–_ = âˆ‚accâ‹†
_â¬–_ : âˆ€ {Î“ Î“â€² Î} â†’ Î“ âˆ‚âŠ©â‹† Î â†’ Î“â€² âŠ‡ Î“ â†’ Î“â€² âˆ‚âŠ©â‹† Î
âˆ…        â¬– Î· = âˆ…
(Ï , âˆ‚a) â¬– Î· = Ï â¬– Î· , âˆ‚acc Î· âˆ‚a


--------------------------------------------------------------------------------


!Æ› : âˆ€ {Î“ A B} â†’ (âˆ€ {Î“â€²} â†’ Î“â€² âŠ‡ Î“ â†’ Î“â€² âˆ‚âŠ© A â†’ Î“â€² âˆ‚âŠ© B)
               â†’ Î“ âŠ© A â‡’ B
!Æ› f = Î» Î· âˆ‚a â†’ f Î· âˆ‚a

_!âˆ™_ : âˆ€ {Î“ A B} â†’ Î“ âŠ© A â‡’ B â†’ Î“ âˆ‚âŠ© A
                 â†’ Î“ âˆ‚âŠ© B
f !âˆ™ âˆ‚a = f idâ‚‘ âˆ‚a

_!,_ : âˆ€ {Î“ A B} â†’ Î“ âˆ‚âŠ© A â†’ Î“ âˆ‚âŠ© B
                 â†’ Î“ âŠ© A â©• B
âˆ‚a !, âˆ‚b = âˆ‚a , âˆ‚b

!Ï€â‚ : âˆ€ {Î“ A B} â†’ Î“ âŠ© A â©• B
                â†’ Î“ âˆ‚âŠ© A
!Ï€â‚ s = projâ‚ s

!Ï€â‚‚ : âˆ€ {Î“ A B} â†’ Î“ âŠ© A â©• B
                â†’ Î“ âˆ‚âŠ© B
!Ï€â‚‚ s = projâ‚‚ s

!Ï„ : âˆ€ {Î“} â†’ Î“ âŠ© â«ª
!Ï„ = tt

!Ï† : âˆ€ {Î“ C} â†’ Î“ âŠ© â««
             â†’ Î“ âˆ‚âŠ© C
!Ï† s = elimâŠ¥ s

!Î¹â‚ : âˆ€ {Î“ A B} â†’ Î“ âˆ‚âŠ© A
                â†’ Î“ âŠ© A â©– B
!Î¹â‚ âˆ‚a = injâ‚ âˆ‚a

!Î¹â‚‚ : âˆ€ {Î“ A B} â†’ Î“ âˆ‚âŠ© B
                â†’ Î“ âŠ© A â©– B
!Î¹â‚‚ âˆ‚b = injâ‚‚ âˆ‚b

_!â‡_!âˆ¥_ : âˆ€ {Î“ A B C} â†’ Î“ âŠ© A â©– B
                      â†’ (âˆ€ {Î“â€²} â†’ Î“â€² âŠ‡ Î“ â†’ Î“â€² âˆ‚âŠ© A â†’ Î“â€² âˆ‚âŠ© C)
                      â†’ (âˆ€ {Î“â€²} â†’ Î“â€² âŠ‡ Î“ â†’ Î“â€² âˆ‚âŠ© B â†’ Î“â€² âˆ‚âŠ© C)
                      â†’ Î“ âˆ‚âŠ© C
s !â‡ f !âˆ¥ g = elimâŠ s (Î» âˆ‚a â†’ f idâ‚‘ âˆ‚a)
                      (Î» âˆ‚b â†’ g idâ‚‘ âˆ‚b)


--------------------------------------------------------------------------------


return : âˆ€ {A Î“} â†’ Î“ âŠ© A â†’ Î“ âˆ‚âŠ© A
return {A} a = Î» Î· f â†’
                 f idâ‚‘ (acc {A} Î· a)

bind : âˆ€ {A C Î“} â†’ Î“ âˆ‚âŠ© A â†’ (âˆ€ {Î“â€²} â†’ Î“â€² âŠ‡ Î“ â†’ Î“â€² âŠ© A â†’ Î“â€² âˆ‚âŠ© C)
                 â†’ Î“ âˆ‚âŠ© C
bind âˆ‚a f = Î» Î· fâ€² â†’
              âˆ‚a Î· (Î» Î·â€² a â†’
                f (Î· â—‹ Î·â€²) a idâ‚‘ (Î» Î·â€³ b â†’
                  fâ€² (Î·â€² â—‹ Î·â€³) b))


--------------------------------------------------------------------------------


âˆ‚!Î» : âˆ€ {Î“ A B} â†’ (âˆ€ {Î“â€²} â†’ Î“â€² âŠ‡ Î“ â†’ Î“â€² âˆ‚âŠ© A â†’ Î“â€² âˆ‚âŠ© B)
                â†’ Î“ âˆ‚âŠ© A â‡’ B
âˆ‚!Î» {A = A} f = return {A â‡’ _}
                       (!Æ› f)

_âˆ‚!âˆ™_ : âˆ€ {Î“ A B} â†’ Î“ âˆ‚âŠ© A â‡’ B â†’ Î“ âˆ‚âŠ© A
                  â†’ Î“ âˆ‚âŠ© B
âˆ‚f âˆ‚!âˆ™ âˆ‚a = bind âˆ‚f (Î» Î· f â†’ f !âˆ™ âˆ‚acc Î· âˆ‚a)

_âˆ‚!,_ : âˆ€ {Î“ A B} â†’ Î“ âˆ‚âŠ© A â†’ Î“ âˆ‚âŠ© B
                  â†’ Î“ âˆ‚âŠ© A â©• B
âˆ‚a âˆ‚!, âˆ‚b = return (âˆ‚a !, âˆ‚b)

âˆ‚!Ï€â‚ : âˆ€ {Î“ A B} â†’ Î“ âˆ‚âŠ© A â©• B
                 â†’ Î“ âˆ‚âŠ© A
âˆ‚!Ï€â‚ âˆ‚s = bind âˆ‚s (Î» Î· s â†’ !Ï€â‚ s)

âˆ‚!Ï€â‚‚ : âˆ€ {Î“ A B} â†’ Î“ âˆ‚âŠ© A â©• B
                 â†’ Î“ âˆ‚âŠ© B
âˆ‚!Ï€â‚‚ âˆ‚s = bind âˆ‚s (Î» Î· s â†’ !Ï€â‚‚ s)

âˆ‚!Ï„ : âˆ€ {Î“} â†’ Î“ âˆ‚âŠ© â«ª
âˆ‚!Ï„ {Î“} = return (!Ï„ {Î“})

âˆ‚!Ï† : âˆ€ {Î“ C} â†’ Î“ âˆ‚âŠ© â««
              â†’ Î“ âˆ‚âŠ© C
âˆ‚!Ï† âˆ‚s = bind âˆ‚s (Î» Î· s â†’ !Ï† s)

âˆ‚!Î¹â‚ : âˆ€ {Î“ A B} â†’ Î“ âˆ‚âŠ© A
                 â†’ Î“ âˆ‚âŠ© A â©– B
âˆ‚!Î¹â‚ {B = B} âˆ‚a = return {_ â©– B}
                         (!Î¹â‚ âˆ‚a)

âˆ‚!Î¹â‚‚ : âˆ€ {Î“ A B} â†’ Î“ âˆ‚âŠ© B
                 â†’ Î“ âˆ‚âŠ© A â©– B
âˆ‚!Î¹â‚‚ {A = A} âˆ‚b = return {A â©– _}
                         (!Î¹â‚‚ âˆ‚b)

_âˆ‚!â‡_âˆ‚!âˆ¥_ : âˆ€ {Î“ A B C} â†’ Î“ âˆ‚âŠ© A â©– B
                        â†’ (âˆ€ {Î“â€²} â†’ Î“â€² âŠ‡ Î“ â†’ Î“â€² âˆ‚âŠ© A â†’ Î“â€² âˆ‚âŠ© C)
                        â†’ (âˆ€ {Î“â€²} â†’ Î“â€² âŠ‡ Î“ â†’ Î“â€² âˆ‚âŠ© B â†’ Î“â€² âˆ‚âŠ© C)
                        â†’ Î“ âˆ‚âŠ© C
âˆ‚s âˆ‚!â‡ f âˆ‚!âˆ¥ g = bind âˆ‚s (Î» Î· s â†’ s !â‡ (Î» Î·â€² â†’ f (Î· â—‹ Î·â€²))
                                     !âˆ¥ (Î» Î·â€² â†’ g (Î· â—‹ Î·â€²)))


--------------------------------------------------------------------------------


-- (âˆˆá´º)
getáµ¥ : âˆ€ {Î“ Î A} â†’ Î“ âˆ‚âŠ©â‹† Î â†’ Î âˆ‹ A â†’ Î“ âˆ‚âŠ© A
getáµ¥ (Ï , âˆ‚a) zero    = âˆ‚a
getáµ¥ (Ï , âˆ‚a) (suc i) = getáµ¥ Ï i

-- (Tmá´º)
eval : âˆ€ {Î“ Î A} â†’ Î“ âˆ‚âŠ©â‹† Î â†’ Î âŠ¢ A â†’ Î“ âˆ‚âŠ© A
eval Ï (ğ“‹ i)         = getáµ¥ Ï i
eval Ï (Æ› M)         = âˆ‚!Î» (Î» Î· âˆ‚a â†’ eval (Ï â¬– Î· , âˆ‚a) M)
eval Ï (M âˆ™ N)       = eval Ï M âˆ‚!âˆ™ eval Ï N
eval Ï (M , N)       = eval Ï M âˆ‚!, eval Ï N
eval Ï (Ï€â‚ M)        = âˆ‚!Ï€â‚ (eval Ï M)
eval Ï (Ï€â‚‚ M)        = âˆ‚!Ï€â‚‚ (eval Ï M)
eval Ï Ï„             = âˆ‚!Ï„
eval Ï (Ï† M)         = âˆ‚!Ï† (eval Ï M)
eval Ï (Î¹â‚ M)        = âˆ‚!Î¹â‚ (eval Ï M)
eval Ï (Î¹â‚‚ M)        = âˆ‚!Î¹â‚‚ (eval Ï M)
eval Ï (M â‡ Nâ‚ âˆ¥ Nâ‚‚) = eval Ï M âˆ‚!â‡ (Î» Î· âˆ‚a â†’ eval (Ï â¬– Î· , âˆ‚a) Nâ‚)
                                âˆ‚!âˆ¥ (Î» Î· âˆ‚b â†’ eval (Ï â¬– Î· , âˆ‚b) Nâ‚‚)


--------------------------------------------------------------------------------


mutual
  -- (qá´º)
  reify : âˆ€ {A Î“} â†’ Î“ âˆ‚âŠ© A â†’ Î“ âŠ¢â¿á¶  A
  reify {âµ}      âˆ‚a = âˆ‚a idâ‚‘ (Î» Î· M â†’ M)
  reify {A â‡’ B} âˆ‚a = âˆ‚a idâ‚‘ (Î» Î· f â†’ Æ› (reify (f (wkâ‚‘ idâ‚‘) (reflect 0))))
  reify {A â©• B}  âˆ‚a = âˆ‚a idâ‚‘ (Î» Î· s â†’ reify (projâ‚ s) , reify (projâ‚‚ s))
  reify {â«ª}     âˆ‚a = âˆ‚a idâ‚‘ (Î» Î· s â†’ Ï„)
  reify {â««}     âˆ‚a = âˆ‚a idâ‚‘ (Î» Î· s â†’ elimâŠ¥ s)
  reify {A â©– B}  âˆ‚a = âˆ‚a idâ‚‘ (Î» Î· s â†’ elimâŠ s (Î» a â†’ Î¹â‚ (reify a))
                                              (Î» b â†’ Î¹â‚‚ (reify b)))

  -- (uá´º)
  reflect : âˆ€ {A Î“} â†’ Î“ âŠ¢â¿áµ‰ A â†’ Î“ âˆ‚âŠ© A
  reflect {âµ}      M = return (ne M)
  reflect {A â‡’ B} M = return {A â‡’ _}
                              (Î» Î· âˆ‚a â†’ reflect (renâ¿áµ‰ Î· M âˆ™ reify âˆ‚a))
  reflect {A â©• B}  M = return (reflect (Ï€â‚ M) , reflect (Ï€â‚‚ M))
  reflect {â«ª}     M = return tt
  reflect {â««}     M = Î» Î· f â†’
                         ne (Ï† (renâ¿áµ‰ Î· M))
  reflect {A â©– B}  M = Î» Î· f â†’
                         ne (renâ¿áµ‰ Î· M â‡ f (wkâ‚‘ idâ‚‘) (injâ‚ (reflect 0))
                                       âˆ¥ f (wkâ‚‘ idâ‚‘) (injâ‚‚ (reflect 0)))


--------------------------------------------------------------------------------


-- (uá¶œá´º)
idáµ¥ : âˆ€ {Î“} â†’ Î“ âˆ‚âŠ©â‹† Î“
idáµ¥ {âˆ…}     = âˆ…
idáµ¥ {Î“ , A} = idáµ¥ â¬– wkâ‚‘ idâ‚‘ , reflect 0


-- (nf)
nf : âˆ€ {Î“ A} â†’ Î“ âŠ¢ A â†’ Î“ âŠ¢â¿á¶  A
nf M = reify (eval idáµ¥ M)


--------------------------------------------------------------------------------
