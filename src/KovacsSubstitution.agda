module KovacsSubstitution where

open import KovacsEmbedding public


-- Substitutions (Sub ; âˆ™ ; _,_)
data _âŠ¢â‹†_ : ğ’ â†’ ğ’ â†’ Set where
  []    : âˆ€ {Î“} â†’ Î“ âŠ¢â‹† []

  [_,_] : âˆ€ {Î“ Î A} â†’ (Ïƒ : Î“ âŠ¢â‹† Î) (M : Î“ âŠ¢ A)
                    â†’ Î“ âŠ¢â‹† [ Î , A ]


-- (_â‚›âˆ˜â‚‘_)
_â—_ : âˆ€ {Î“ Î“â€² Î} â†’ Î“ âŠ¢â‹† Î â†’ Î“â€² âŠ‡ Î“ â†’ Î“â€² âŠ¢â‹† Î
[]        â— Î· = []
[ Ïƒ , M ] â— Î· = [ Ïƒ â— Î· , ren Î· M ]

-- (_â‚‘âˆ˜â‚›_)
_â—‘_ : âˆ€ {Î“ Î Îâ€²} â†’ Îâ€² âŠ‡ Î â†’ Î“ âŠ¢â‹† Îâ€² â†’ Î“ âŠ¢â‹† Î
done    â—‘ Ïƒ         = Ïƒ
wkâ‚‘ Î·   â—‘ [ Ïƒ , M ] = Î· â—‘ Ïƒ
liftâ‚‘ Î· â—‘ [ Ïƒ , M ] = [ Î· â—‘ Ïƒ , M ]


--------------------------------------------------------------------------------


-- (dropâ‚›)
wkâ‚› : âˆ€ {Î“ Î A} â†’ Î“ âŠ¢â‹† Î â†’ [ Î“ , A ] âŠ¢â‹† Î
wkâ‚› Ïƒ = Ïƒ â— wkâ‚‘ idâ‚‘

-- (keepâ‚›)
liftâ‚› : âˆ€ {Î“ Î A} â†’ Î“ âŠ¢â‹† Î â†’ [ Î“ , A ] âŠ¢â‹† [ Î , A ]
liftâ‚› Ïƒ = [ wkâ‚› Ïƒ , ` zero ]

-- (âŒœ_âŒáµ’áµ–áµ‰)
âŒŠ_âŒ‹ : âˆ€ {Î“ Î“â€²} â†’ Î“â€² âŠ‡ Î“ â†’ Î“â€² âŠ¢â‹† Î“
âŒŠ done âŒ‹    = []
âŒŠ wkâ‚‘ Î· âŒ‹   = wkâ‚› âŒŠ Î· âŒ‹
âŒŠ liftâ‚‘ Î· âŒ‹ = liftâ‚› âŒŠ Î· âŒ‹

-- (âˆˆâ‚›)
getâ‚› : âˆ€ {Î“ Î A} â†’ Î“ âŠ¢â‹† Î â†’ Î âˆ‹ A â†’ Î“ âŠ¢ A
getâ‚› [ Ïƒ , M ] zero    = M
getâ‚› [ Ïƒ , M ] (suc i) = getâ‚› Ïƒ i

-- (Tmâ‚›)
sub : âˆ€ {Î“ Î A} â†’ Î“ âŠ¢â‹† Î â†’ Î âŠ¢ A â†’ Î“ âŠ¢ A
sub Ïƒ (` i)   = getâ‚› Ïƒ i
sub Ïƒ (Æ› M)   = Æ› (sub (liftâ‚› Ïƒ) M)
sub Ïƒ (M âˆ™ N) = sub Ïƒ M âˆ™ sub Ïƒ N

-- (idâ‚›)
idâ‚› : âˆ€ {Î“} â†’ Î“ âŠ¢â‹† Î“
idâ‚› {[]}        = []
idâ‚› {[ Î“ , A ]} = liftâ‚› idâ‚›

-- (_âˆ˜â‚›_)
_â—_ : âˆ€ {Î“ Î Î¦} â†’ Î âŠ¢â‹† Î¦ â†’ Î“ âŠ¢â‹† Î â†’ Î“ âŠ¢â‹† Î¦
[]         â— Ïƒâ‚ = []
[ Ïƒâ‚‚ , M ] â— Ïƒâ‚ = [ Ïƒâ‚‚ â— Ïƒâ‚ , sub Ïƒâ‚ M ]


--------------------------------------------------------------------------------


-- (assâ‚›â‚‘â‚‘)
compâ—â—‹ : âˆ€ {Î“ Î“â€² Î“â€³ Î} â†’ (Î·â‚ : Î“â€³ âŠ‡ Î“â€²) (Î·â‚‚ : Î“â€² âŠ‡ Î“) (Ïƒ : Î“ âŠ¢â‹† Î)
                       â†’ (Ïƒ â— Î·â‚‚) â— Î·â‚ â‰¡ Ïƒ â— (Î·â‚‚ â—‹ Î·â‚)
compâ—â—‹ Î·â‚ Î·â‚‚ []        = refl
compâ—â—‹ Î·â‚ Î·â‚‚ [ Ïƒ , M ] = [_,_] & compâ—â—‹ Î·â‚ Î·â‚‚ Ïƒ âŠ— (renâ—‹ Î·â‚ Î·â‚‚ M â»Â¹)

-- (assâ‚‘â‚›â‚‘)
compâ—‘â— : âˆ€ {Î“ Î“â€² Î Îâ€²} â†’ (Î·â‚ : Î“â€² âŠ‡ Î“) (Ïƒ : Î“ âŠ¢â‹† Îâ€²) (Î·â‚‚ : Îâ€² âŠ‡ Î)
                       â†’ (Î·â‚‚ â—‘ Ïƒ) â— Î·â‚ â‰¡ Î·â‚‚ â—‘ (Ïƒ â— Î·â‚)
compâ—‘â— Î·â‚ []        done       = refl
compâ—‘â— Î·â‚ [ Ïƒ , M ] (wkâ‚‘ Î·â‚‚)   = compâ—‘â— Î·â‚ Ïƒ Î·â‚‚
compâ—‘â— Î·â‚ [ Ïƒ , M ] (liftâ‚‘ Î·â‚‚) = [_, ren Î·â‚ M ] & compâ—‘â— Î·â‚ Ïƒ Î·â‚‚


--------------------------------------------------------------------------------


-- (idlâ‚‘â‚›)
idâ‚â—‘ : âˆ€ {Î“ Î} â†’ (Ïƒ : Î“ âŠ¢â‹† Î)
               â†’ idâ‚‘ â—‘ Ïƒ â‰¡ Ïƒ
idâ‚â—‘ []        = refl
idâ‚â—‘ [ Ïƒ , M ] = [_, M ] & idâ‚â—‘ Ïƒ

-- (idlâ‚›â‚‘)
idâ‚â— : âˆ€ {Î“ Î“â€²} â†’ (Î· : Î“â€² âŠ‡ Î“)
                â†’ idâ‚› â— Î· â‰¡ âŒŠ Î· âŒ‹
idâ‚â— done      = refl
idâ‚â— (wkâ‚‘ Î·)   = ((idâ‚› â—_) âˆ˜ wkâ‚‘) & idâ‚‚â—‹ Î· â»Â¹
               â¦™ compâ—â—‹ (wkâ‚‘ idâ‚‘) Î· idâ‚› â»Â¹
               â¦™ wkâ‚› & idâ‚â— Î·
idâ‚â— (liftâ‚‘ Î·) = [_, ` zero ] & ( compâ—â—‹ (liftâ‚‘ Î·) (wkâ‚‘ idâ‚‘) idâ‚›
                                â¦™ ((idâ‚› â—_) âˆ˜ wkâ‚‘) & (idâ‚â—‹ Î· â¦™ idâ‚‚â—‹ Î· â»Â¹)
                                â¦™ compâ—â—‹ (wkâ‚‘ idâ‚‘) Î· idâ‚› â»Â¹
                                â¦™ (_â— wkâ‚‘ idâ‚‘) & idâ‚â— Î·
                                )

-- (idrâ‚‘â‚›)
idâ‚‚â—‘ : âˆ€ {Î“ Î“â€²} â†’ (Î· : Î“â€² âŠ‡ Î“)
                â†’ Î· â—‘ idâ‚› â‰¡ âŒŠ Î· âŒ‹
idâ‚‚â—‘ done      = refl
idâ‚‚â—‘ (wkâ‚‘ Î·)   = compâ—‘â— (wkâ‚‘ idâ‚‘) idâ‚› Î· â»Â¹
               â¦™ wkâ‚› & idâ‚‚â—‘ Î·
idâ‚‚â—‘ (liftâ‚‘ Î·) = [_, ` zero ] & ( compâ—‘â— (wkâ‚‘ idâ‚‘) idâ‚› Î· â»Â¹
                                â¦™ (_â— wkâ‚‘ idâ‚‘) & idâ‚‚â—‘ Î·
                                )


--------------------------------------------------------------------------------


-- (âˆˆ-â‚‘âˆ˜â‚›)
getâ—‘ : âˆ€ {Î“ Î Îâ€² A} â†’ (Ïƒ : Î“ âŠ¢â‹† Îâ€²) (Î· : Îâ€² âŠ‡ Î) (i : Î âˆ‹ A)
                    â†’ getâ‚› (Î· â—‘ Ïƒ) i â‰¡ (getâ‚› Ïƒ âˆ˜ getâ‚‘ Î·) i
getâ—‘ Ïƒ         done      i       = refl
getâ—‘ [ Ïƒ , M ] (wkâ‚‘ Î·)   i       = getâ—‘ Ïƒ Î· i
getâ—‘ [ Ïƒ , M ] (liftâ‚‘ Î·) zero    = refl
getâ—‘ [ Ïƒ , M ] (liftâ‚‘ Î·) (suc i) = getâ—‘ Ïƒ Î· i

-- (Tm-â‚‘âˆ˜â‚›)
subâ—‘ : âˆ€ {Î“ Î Îâ€² A} â†’ (Ïƒ : Î“ âŠ¢â‹† Îâ€²) (Î· : Îâ€² âŠ‡ Î) (M : Î âŠ¢ A)
                    â†’ sub (Î· â—‘ Ïƒ) M â‰¡ (sub Ïƒ âˆ˜ ren Î·) M
subâ—‘ Ïƒ Î· (` i)   = getâ—‘ Ïƒ Î· i
subâ—‘ Ïƒ Î· (Æ› M)   = Æ› & ((Î» Ïƒâ€² â†’ sub [ Ïƒâ€² , ` zero ] M)
                        & compâ—‘â— (wkâ‚‘ idâ‚‘) Ïƒ Î·
                        â¦™ subâ—‘ (liftâ‚› Ïƒ) (liftâ‚‘ Î·) M)
subâ—‘ Ïƒ Î· (M âˆ™ N) = _âˆ™_ & subâ—‘ Ïƒ Î· M âŠ— subâ—‘ Ïƒ Î· N


--------------------------------------------------------------------------------


-- (âˆˆ-â‚›âˆ˜â‚‘)
getâ— : âˆ€ {Î“ Î“â€² Î A} â†’ (Î· : Î“â€² âŠ‡ Î“) (Ïƒ : Î“ âŠ¢â‹† Î) (i : Î âˆ‹ A)
                    â†’ getâ‚› (Ïƒ â— Î·) i â‰¡ (ren Î· âˆ˜ getâ‚› Ïƒ) i
getâ— Î· [ Ïƒ , M ] zero    = refl
getâ— Î· [ Ïƒ , M ] (suc i) = getâ— Î· Ïƒ i

-- (Tm-â‚›âˆ˜â‚‘)
subâ— : âˆ€ {Î“ Î“â€² Î A} â†’ (Î· : Î“â€² âŠ‡ Î“) (Ïƒ : Î“ âŠ¢â‹† Î) (M : Î âŠ¢ A)
                    â†’ sub (Ïƒ â— Î·) M â‰¡ (ren Î· âˆ˜ sub Ïƒ) M
subâ— Î· Ïƒ (` i)   = getâ— Î· Ïƒ i
subâ— Î· Ïƒ (Æ› M)   = Æ› & ( (Î» Ïƒâ€² â†’ sub [ Ïƒâ€² , ` zero ] M)
                         & ( compâ—â—‹ (wkâ‚‘ idâ‚‘) Î· Ïƒ
                           â¦™ (Ïƒ â—_) & (wkâ‚‘ & (idâ‚‚â—‹ Î· â¦™ idâ‚â—‹ Î· â»Â¹))
                           â¦™ compâ—â—‹ (liftâ‚‘ Î·) (wkâ‚‘ idâ‚‘) Ïƒ â»Â¹
                           )
                       â¦™ subâ— (liftâ‚‘ Î·) (liftâ‚› Ïƒ) M
                       )
subâ— Î· Ïƒ (M âˆ™ N) = _âˆ™_ & subâ— Î· Ïƒ M âŠ— subâ— Î· Ïƒ N


--------------------------------------------------------------------------------


-- (assâ‚›â‚‘â‚›)
compâ—â—‘ : âˆ€ {Î“ Î Îâ€² Î¦} â†’ (Ïƒâ‚ : Î“ âŠ¢â‹† Îâ€²) (Î· : Îâ€² âŠ‡ Î) (Ïƒâ‚‚ : Î âŠ¢â‹† Î¦)
                      â†’ (Ïƒâ‚‚ â— Î·) â— Ïƒâ‚ â‰¡ Ïƒâ‚‚ â— (Î· â—‘ Ïƒâ‚)
compâ—â—‘ Ïƒâ‚ Î· []         = refl
compâ—â—‘ Ïƒâ‚ Î· [ Ïƒâ‚‚ , M ] = [_,_] & compâ—â—‘ Ïƒâ‚ Î· Ïƒâ‚‚ âŠ— (subâ—‘ Ïƒâ‚ Î· M â»Â¹)

-- (assâ‚›â‚›â‚‘)
compâ—â— : âˆ€ {Î“ Î“â€² Î Î¦} â†’ (Î· : Î“â€² âŠ‡ Î“) (Ïƒâ‚ : Î“ âŠ¢â‹† Î) (Ïƒâ‚‚ : Î âŠ¢â‹† Î¦)
                      â†’ (Ïƒâ‚‚ â— Ïƒâ‚) â— Î· â‰¡ Ïƒâ‚‚ â— (Ïƒâ‚ â— Î·)
compâ—â— Î· Ïƒâ‚ []         = refl
compâ—â— Î· Ïƒâ‚ [ Ïƒâ‚‚ , M ] = [_,_] & compâ—â— Î· Ïƒâ‚ Ïƒâ‚‚ âŠ— (subâ— Î· Ïƒâ‚ M â»Â¹)


--------------------------------------------------------------------------------


-- (âˆˆ-âˆ˜â‚›)
getâ— : âˆ€ {Î“ Î Î¦ A} â†’ (Ïƒâ‚ : Î“ âŠ¢â‹† Î) (Ïƒâ‚‚ : Î âŠ¢â‹† Î¦) (i : Î¦ âˆ‹ A)
                   â†’ getâ‚› (Ïƒâ‚‚ â— Ïƒâ‚) i â‰¡ (sub Ïƒâ‚ âˆ˜ getâ‚› Ïƒâ‚‚) i
getâ— Ïƒâ‚ [ Ïƒâ‚‚ , M ] zero    = refl
getâ— Ïƒâ‚ [ Ïƒâ‚‚ , M ] (suc i) = getâ— Ïƒâ‚ Ïƒâ‚‚ i

-- (Tm-âˆ˜â‚›)
subâ— : âˆ€ {Î“ Î Î¦ A} â†’ (Ïƒâ‚ : Î“ âŠ¢â‹† Î) (Ïƒâ‚‚ : Î âŠ¢â‹† Î¦) (M : Î¦ âŠ¢ A)
                   â†’ sub (Ïƒâ‚‚ â— Ïƒâ‚) M â‰¡ (sub Ïƒâ‚ âˆ˜ sub Ïƒâ‚‚) M
subâ— Ïƒâ‚ Ïƒâ‚‚ (` i)   = getâ— Ïƒâ‚ Ïƒâ‚‚ i
subâ— Ïƒâ‚ Ïƒâ‚‚ (Æ› M)   = Æ› & ( (Î» Ïƒâ€² â†’ sub [ Ïƒâ€² , ` zero ] M)
                           & ( compâ—â— (wkâ‚‘ idâ‚‘) Ïƒâ‚ Ïƒâ‚‚
                             â¦™ (Ïƒâ‚‚ â—_) & (idâ‚â—‘ (wkâ‚› Ïƒâ‚) â»Â¹)
                                       â¦™ compâ—â—‘ (liftâ‚› Ïƒâ‚) (wkâ‚‘ idâ‚‘) Ïƒâ‚‚ â»Â¹
                             )
                         â¦™ subâ— (liftâ‚› Ïƒâ‚) (liftâ‚› Ïƒâ‚‚) M
                         )
subâ— Ïƒâ‚ Ïƒâ‚‚ (M âˆ™ N) = _âˆ™_ & subâ— Ïƒâ‚ Ïƒâ‚‚ M âŠ— subâ— Ïƒâ‚ Ïƒâ‚‚ N


--------------------------------------------------------------------------------


-- (âˆˆ-idâ‚›)
idgetâ‚› : âˆ€ {Î“ A} â†’ (i : Î“ âˆ‹ A)
                 â†’ getâ‚› idâ‚› i â‰¡ ` i
idgetâ‚› zero    = refl
idgetâ‚› (suc i) = getâ— (wkâ‚‘ idâ‚‘) idâ‚› i
               â¦™ ren (wkâ‚‘ idâ‚‘) & idgetâ‚› i
               â¦™ (_âŠ¢_.` âˆ˜ suc) & idgetâ‚‘ i

-- (Tm-idâ‚›)
idsub : âˆ€ {Î“ A} â†’ (M : Î“ âŠ¢ A)
                â†’ sub idâ‚› M â‰¡ M
idsub (` i)   = idgetâ‚› i
idsub (Æ› M)   = Æ› & idsub M
idsub (M âˆ™ N) = _âˆ™_ & idsub M âŠ— idsub N


--------------------------------------------------------------------------------


-- (idrâ‚›)
idâ‚‚â— : âˆ€ {Î“ Î} â†’ (Ïƒ : Î“ âŠ¢â‹† Î)
               â†’ Ïƒ â— idâ‚› â‰¡ Ïƒ
idâ‚‚â— []        = refl
idâ‚‚â— [ Ïƒ , M ] = [_,_] & idâ‚‚â— Ïƒ âŠ— idsub M

-- (idlâ‚›)
idâ‚â— : âˆ€ {Î“ Î} â†’ (Ïƒ : Î“ âŠ¢â‹† Î)
               â†’ idâ‚› â— Ïƒ â‰¡ Ïƒ
idâ‚â— []        = refl
idâ‚â— [ Ïƒ , M ] = [_, M ] & ( compâ—â—‘ [ Ïƒ , M ] (wkâ‚‘ idâ‚‘) idâ‚›
                           â¦™ idâ‚â— (idâ‚‘ â—‘ Ïƒ)
                           â¦™ idâ‚â—‘ Ïƒ
                           )

-- (assâ‚›)
assocâ— : âˆ€ {Î“ Î Î¦ Î¨} â†’ (Ïƒâ‚ : Î“ âŠ¢â‹† Î) (Ïƒâ‚‚ : Î âŠ¢â‹† Î¦) (Ïƒâ‚ƒ : Î¦ âŠ¢â‹† Î¨)
                     â†’ (Ïƒâ‚ƒ â— Ïƒâ‚‚) â— Ïƒâ‚ â‰¡ Ïƒâ‚ƒ â— (Ïƒâ‚‚ â— Ïƒâ‚)
assocâ— Ïƒâ‚ Ïƒâ‚‚ []         = refl
assocâ— Ïƒâ‚ Ïƒâ‚‚ [ Ïƒâ‚ƒ , M ] = [_,_] & assocâ— Ïƒâ‚ Ïƒâ‚‚ Ïƒâ‚ƒ âŠ— (subâ— Ïƒâ‚ Ïƒâ‚‚ M â»Â¹)


--------------------------------------------------------------------------------


ğ—¦ğ—§ğ—Ÿğ—– : Category ğ’ _âŠ¢â‹†_
ğ—¦ğ—§ğ—Ÿğ—– =
  record
    { idâ‚“    = idâ‚›
    ; _â‹„_    = _â—_
    ; idâ‚â‹„   = idâ‚â—
    ; idâ‚‚â‹„   = idâ‚‚â—
    ; assocâ‹„ = assocâ—
    }


subPsh : ğ’¯ â†’ Presheafâ‚€ ğ—¦ğ—§ğ—Ÿğ—–
subPsh A =
  record
    { Ï†â‚“   = _âŠ¢ A
    ; Ï†â‚˜   = sub
    ; idÏ†â‚˜ = fext! idsub
    ; Ï†â‚˜â‹„  = Î» Ïƒâ‚ Ïƒâ‚‚ â†’ fext! (subâ— Ïƒâ‚‚ Ïƒâ‚)
    }
