module STLC.Kovacs.Substitution where

open import STLC.Kovacs.Embedding public
open import Category


--------------------------------------------------------------------------------


-- Substitutions (Sub ; âˆ™ ; _,_)
infix 3 _âŠ¢â‹†_
data _âŠ¢â‹†_ : ğ’ â†’ ğ’ â†’ Set
  where
    âˆ…   : âˆ€ {Î“} â†’ Î“ âŠ¢â‹† âˆ…

    _,_ : âˆ€ {Î“ Î A} â†’ (Ïƒ : Î“ âŠ¢â‹† Î) (M : Î“ âŠ¢ A)
                    â†’ Î“ âŠ¢â‹† Î , A


-- (_â‚›âˆ˜â‚‘_)
-- NOTE: _â—_ = renâ‹†
_â—_ : âˆ€ {Î“ Î“â€² Î} â†’ Î“ âŠ¢â‹† Î â†’ Î“â€² âŠ‡ Î“ â†’ Î“â€² âŠ¢â‹† Î
âˆ…       â— Î· = âˆ…
(Ïƒ , M) â— Î· = Ïƒ â— Î· , ren Î· M

-- (_â‚‘âˆ˜â‚›_)
_â—‘_ : âˆ€ {Î“ Î Îâ€²} â†’ Îâ€² âŠ‡ Î â†’ Î“ âŠ¢â‹† Îâ€² â†’ Î“ âŠ¢â‹† Î
done    â—‘ Ïƒ       = Ïƒ
wkâ‚‘ Î·   â—‘ (Ïƒ , M) = Î· â—‘ Ïƒ
liftâ‚‘ Î· â—‘ (Ïƒ , M) = Î· â—‘ Ïƒ , M


--------------------------------------------------------------------------------


-- (dropâ‚›)
wkâ‚› : âˆ€ {A Î“ Î} â†’ Î“ âŠ¢â‹† Î â†’ Î“ , A âŠ¢â‹† Î
wkâ‚› Ïƒ = Ïƒ â— wkâ‚‘ idâ‚‘

-- (keepâ‚›)
liftâ‚› : âˆ€ {A Î“ Î} â†’ Î“ âŠ¢â‹† Î â†’ Î“ , A âŠ¢â‹† Î , A
liftâ‚› Ïƒ = wkâ‚› Ïƒ , 0

-- (âŒœ_âŒáµ’áµ–áµ‰)
âŒŠ_âŒ‹ : âˆ€ {Î“ Î“â€²} â†’ Î“â€² âŠ‡ Î“ â†’ Î“â€² âŠ¢â‹† Î“
âŒŠ done âŒ‹    = âˆ…
âŒŠ wkâ‚‘ Î· âŒ‹   = wkâ‚› âŒŠ Î· âŒ‹
âŒŠ liftâ‚‘ Î· âŒ‹ = liftâ‚› âŒŠ Î· âŒ‹

-- (âˆˆâ‚›)
getâ‚› : âˆ€ {Î“ Î A} â†’ Î“ âŠ¢â‹† Î â†’ Î âˆ‹ A â†’ Î“ âŠ¢ A
getâ‚› (Ïƒ , M) zero    = M
getâ‚› (Ïƒ , M) (suc i) = getâ‚› Ïƒ i

-- (Tmâ‚›)
sub : âˆ€ {Î“ Î A} â†’ Î“ âŠ¢â‹† Î â†’ Î âŠ¢ A â†’ Î“ âŠ¢ A
sub Ïƒ (ğ“‹ i)   = getâ‚› Ïƒ i
sub Ïƒ (Æ› M)   = Æ› (sub (liftâ‚› Ïƒ) M)
sub Ïƒ (M âˆ™ N) = sub Ïƒ M âˆ™ sub Ïƒ N

-- (idâ‚›)
idâ‚› : âˆ€ {Î“} â†’ Î“ âŠ¢â‹† Î“
idâ‚› {âˆ…}     = âˆ…
idâ‚› {Î“ , A} = liftâ‚› idâ‚›

cut : âˆ€ {Î“ A B} â†’ Î“ âŠ¢ A â†’ Î“ , A âŠ¢ B â†’ Î“ âŠ¢ B
cut M N = sub (idâ‚› , M) N

-- (_âˆ˜â‚›_)
-- NOTE: _â—_ = subâ‹†
_â—_ : âˆ€ {Î“ Î Î¦} â†’ Î âŠ¢â‹† Î¦ â†’ Î“ âŠ¢â‹† Î â†’ Î“ âŠ¢â‹† Î¦
âˆ…        â— Ïƒâ‚ = âˆ…
(Ïƒâ‚‚ , M) â— Ïƒâ‚ = Ïƒâ‚‚ â— Ïƒâ‚ , sub Ïƒâ‚ M


--------------------------------------------------------------------------------


-- (assâ‚›â‚‘â‚‘)
compâ—â—‹ : âˆ€ {Î“ Î“â€² Î“â€³ Î} â†’ (Î·â‚ : Î“â€³ âŠ‡ Î“â€²) (Î·â‚‚ : Î“â€² âŠ‡ Î“) (Ïƒ : Î“ âŠ¢â‹† Î)
                       â†’ (Ïƒ â— Î·â‚‚) â— Î·â‚ â‰¡ Ïƒ â— (Î·â‚‚ â—‹ Î·â‚)
compâ—â—‹ Î·â‚ Î·â‚‚ âˆ…       = refl
compâ—â—‹ Î·â‚ Î·â‚‚ (Ïƒ , M) = _,_ & compâ—â—‹ Î·â‚ Î·â‚‚ Ïƒ
                           âŠ— (renâ—‹ Î·â‚ Î·â‚‚ M â»Â¹)

-- (assâ‚‘â‚›â‚‘)
compâ—‘â— : âˆ€ {Î“ Î“â€² Î Îâ€²} â†’ (Î·â‚ : Î“â€² âŠ‡ Î“) (Ïƒ : Î“ âŠ¢â‹† Îâ€²) (Î·â‚‚ : Îâ€² âŠ‡ Î)
                       â†’ (Î·â‚‚ â—‘ Ïƒ) â— Î·â‚ â‰¡ Î·â‚‚ â—‘ (Ïƒ â— Î·â‚)
compâ—‘â— Î·â‚ âˆ…       done       = refl
compâ—‘â— Î·â‚ (Ïƒ , M) (wkâ‚‘ Î·â‚‚)   = compâ—‘â— Î·â‚ Ïƒ Î·â‚‚
compâ—‘â— Î·â‚ (Ïƒ , M) (liftâ‚‘ Î·â‚‚) = (_, ren Î·â‚ M) & compâ—‘â— Î·â‚ Ïƒ Î·â‚‚


--------------------------------------------------------------------------------


-- (idlâ‚‘â‚›)
lidâ—‘ : âˆ€ {Î“ Î} â†’ (Ïƒ : Î“ âŠ¢â‹† Î)
               â†’ idâ‚‘ â—‘ Ïƒ â‰¡ Ïƒ
lidâ—‘ âˆ…       = refl
lidâ—‘ (Ïƒ , M) = (_, M) & lidâ—‘ Ïƒ

-- (idlâ‚›â‚‘)
lidâ— : âˆ€ {Î“ Î“â€²} â†’ (Î· : Î“â€² âŠ‡ Î“)
                â†’ idâ‚› â— Î· â‰¡ âŒŠ Î· âŒ‹
lidâ— done      = refl
lidâ— (wkâ‚‘ Î·)   = ((idâ‚› â—_) âˆ˜ wkâ‚‘) & ridâ—‹ Î· â»Â¹
               â¦™ compâ—â—‹ (wkâ‚‘ idâ‚‘) Î· idâ‚› â»Â¹
               â¦™ wkâ‚› & lidâ— Î·
lidâ— (liftâ‚‘ Î·) = (_, 0) & ( compâ—â—‹ (liftâ‚‘ Î·) (wkâ‚‘ idâ‚‘) idâ‚›
                          â¦™ ((idâ‚› â—_) âˆ˜ wkâ‚‘) & ( lidâ—‹ Î·
                                               â¦™ ridâ—‹ Î· â»Â¹
                                               )
                          â¦™ compâ—â—‹ (wkâ‚‘ idâ‚‘) Î· idâ‚› â»Â¹
                          â¦™ (_â— wkâ‚‘ idâ‚‘) & lidâ— Î·
                          )

-- (idrâ‚‘â‚›)
ridâ—‘ : âˆ€ {Î“ Î“â€²} â†’ (Î· : Î“â€² âŠ‡ Î“)
                â†’ Î· â—‘ idâ‚› â‰¡ âŒŠ Î· âŒ‹
ridâ—‘ done      = refl
ridâ—‘ (wkâ‚‘ Î·)   = compâ—‘â— (wkâ‚‘ idâ‚‘) idâ‚› Î· â»Â¹
               â¦™ wkâ‚› & ridâ—‘ Î·
ridâ—‘ (liftâ‚‘ Î·) = (_, 0) & ( compâ—‘â— (wkâ‚‘ idâ‚‘) idâ‚› Î· â»Â¹
                          â¦™ (_â— wkâ‚‘ idâ‚‘) & ridâ—‘ Î·
                          )


--------------------------------------------------------------------------------


-- (âˆˆ-â‚‘âˆ˜â‚›)
getâ—‘ : âˆ€ {Î“ Î Îâ€² A} â†’ (Ïƒ : Î“ âŠ¢â‹† Îâ€²) (Î· : Îâ€² âŠ‡ Î) (i : Î âˆ‹ A)
                    â†’ getâ‚› (Î· â—‘ Ïƒ) i â‰¡ (getâ‚› Ïƒ âˆ˜ getâ‚‘ Î·) i
getâ—‘ Ïƒ       done      i       = refl
getâ—‘ (Ïƒ , M) (wkâ‚‘ Î·)   i       = getâ—‘ Ïƒ Î· i
getâ—‘ (Ïƒ , M) (liftâ‚‘ Î·) zero    = refl
getâ—‘ (Ïƒ , M) (liftâ‚‘ Î·) (suc i) = getâ—‘ Ïƒ Î· i

-- (Tm-â‚‘âˆ˜â‚›)
mutual
  subâ—‘ : âˆ€ {Î“ Î Îâ€² A} â†’ (Ïƒ : Î“ âŠ¢â‹† Îâ€²) (Î· : Îâ€² âŠ‡ Î) (M : Î âŠ¢ A)
                      â†’ sub (Î· â—‘ Ïƒ) M â‰¡ (sub Ïƒ âˆ˜ ren Î·) M
  subâ—‘ Ïƒ Î· (ğ“‹ i)   = getâ—‘ Ïƒ Î· i
  subâ—‘ Ïƒ Î· (Æ› M)   = Æ› & subliftâ—‘ Ïƒ Î· M
  subâ—‘ Ïƒ Î· (M âˆ™ N) = _âˆ™_ & subâ—‘ Ïƒ Î· M
                         âŠ— subâ—‘ Ïƒ Î· N

  subliftâ—‘ : âˆ€ {Î“ Î Îâ€² A B} â†’ (Ïƒ : Î“ âŠ¢â‹† Îâ€²) (Î· : Îâ€² âŠ‡ Î) (M : Î , B âŠ¢ A)
                            â†’ sub (liftâ‚› {B} (Î· â—‘ Ïƒ)) M â‰¡
                               (sub (liftâ‚› Ïƒ) âˆ˜ ren (liftâ‚‘ Î·)) M
  subliftâ—‘ Ïƒ Î· M = (Î» Ïƒâ€² â†’ sub (Ïƒâ€² , 0) M)
                   & compâ—‘â— (wkâ‚‘ idâ‚‘) Ïƒ Î·
                 â¦™ subâ—‘ (liftâ‚› Ïƒ) (liftâ‚‘ Î·) M


--------------------------------------------------------------------------------


-- (âˆˆ-â‚›âˆ˜â‚‘)
getâ— : âˆ€ {Î“ Î“â€² Î A} â†’ (Î· : Î“â€² âŠ‡ Î“) (Ïƒ : Î“ âŠ¢â‹† Î) (i : Î âˆ‹ A)
                    â†’ getâ‚› (Ïƒ â— Î·) i â‰¡ (ren Î· âˆ˜ getâ‚› Ïƒ) i
getâ— Î· (Ïƒ , M) zero    = refl
getâ— Î· (Ïƒ , M) (suc i) = getâ— Î· Ïƒ i

-- (Tm-â‚›âˆ˜â‚‘)
mutual
  subâ— : âˆ€ {Î“ Î“â€² Î A} â†’ (Î· : Î“â€² âŠ‡ Î“) (Ïƒ : Î“ âŠ¢â‹† Î) (M : Î âŠ¢ A)
                      â†’ sub (Ïƒ â— Î·) M â‰¡ (ren Î· âˆ˜ sub Ïƒ) M
  subâ— Î· Ïƒ (ğ“‹ i)   = getâ— Î· Ïƒ i
  subâ— Î· Ïƒ (Æ› M)   = Æ› & subliftâ— Î· Ïƒ M
  subâ— Î· Ïƒ (M âˆ™ N) = _âˆ™_ & subâ— Î· Ïƒ M
                         âŠ— subâ— Î· Ïƒ N

  subliftâ— : âˆ€ {Î“ Î“â€² Î A B} â†’ (Î· : Î“â€² âŠ‡ Î“) (Ïƒ : Î“ âŠ¢â‹† Î) (M : Î , B âŠ¢ A)
                            â†’ sub (liftâ‚› {B} (Ïƒ â— Î·)) M â‰¡
                               (ren (liftâ‚‘ Î·) âˆ˜ sub (liftâ‚› Ïƒ)) M
  subliftâ— Î· Ïƒ M = (Î» Ïƒâ€² â†’ sub (Ïƒâ€² , 0) M)
                   & ( compâ—â—‹ (wkâ‚‘ idâ‚‘) Î· Ïƒ
                     â¦™ (Ïƒ â—_) & (wkâ‚‘ & ( ridâ—‹ Î·
                                       â¦™ lidâ—‹ Î· â»Â¹
                                       ))
                     â¦™ compâ—â—‹ (liftâ‚‘ Î·) (wkâ‚‘ idâ‚‘) Ïƒ â»Â¹
                     )
                 â¦™ subâ— (liftâ‚‘ Î·) (liftâ‚› Ïƒ) M


--------------------------------------------------------------------------------


-- (assâ‚›â‚‘â‚›)
compâ—â—‘ : âˆ€ {Î“ Î Îâ€² Î¦} â†’ (Ïƒâ‚ : Î“ âŠ¢â‹† Îâ€²) (Î· : Îâ€² âŠ‡ Î) (Ïƒâ‚‚ : Î âŠ¢â‹† Î¦)
                      â†’ (Ïƒâ‚‚ â— Î·) â— Ïƒâ‚ â‰¡ Ïƒâ‚‚ â— (Î· â—‘ Ïƒâ‚)
compâ—â—‘ Ïƒâ‚ Î· âˆ…        = refl
compâ—â—‘ Ïƒâ‚ Î· (Ïƒâ‚‚ , M) = _,_ & compâ—â—‘ Ïƒâ‚ Î· Ïƒâ‚‚
                           âŠ— (subâ—‘ Ïƒâ‚ Î· M â»Â¹)

-- (assâ‚›â‚›â‚‘)
compâ—â— : âˆ€ {Î“ Î“â€² Î Î¦} â†’ (Î· : Î“â€² âŠ‡ Î“) (Ïƒâ‚ : Î“ âŠ¢â‹† Î) (Ïƒâ‚‚ : Î âŠ¢â‹† Î¦)
                      â†’ (Ïƒâ‚‚ â— Ïƒâ‚) â— Î· â‰¡ Ïƒâ‚‚ â— (Ïƒâ‚ â— Î·)
compâ—â— Î· Ïƒâ‚ âˆ…        = refl
compâ—â— Î· Ïƒâ‚ (Ïƒâ‚‚ , M) = _,_ & compâ—â— Î· Ïƒâ‚ Ïƒâ‚‚
                           âŠ— (subâ— Î· Ïƒâ‚ M â»Â¹)


--------------------------------------------------------------------------------


-- (âˆˆ-âˆ˜â‚›)
getâ— : âˆ€ {Î“ Î Î¦ A} â†’ (Ïƒâ‚ : Î“ âŠ¢â‹† Î) (Ïƒâ‚‚ : Î âŠ¢â‹† Î¦) (i : Î¦ âˆ‹ A)
                   â†’ getâ‚› (Ïƒâ‚‚ â— Ïƒâ‚) i â‰¡ (sub Ïƒâ‚ âˆ˜ getâ‚› Ïƒâ‚‚) i
getâ— Ïƒâ‚ (Ïƒâ‚‚ , M) zero    = refl
getâ— Ïƒâ‚ (Ïƒâ‚‚ , M) (suc i) = getâ— Ïƒâ‚ Ïƒâ‚‚ i

-- (Tm-âˆ˜â‚›)
mutual
  subâ— : âˆ€ {Î“ Î Î¦ A} â†’ (Ïƒâ‚ : Î“ âŠ¢â‹† Î) (Ïƒâ‚‚ : Î âŠ¢â‹† Î¦) (M : Î¦ âŠ¢ A)
                     â†’ sub (Ïƒâ‚‚ â— Ïƒâ‚) M â‰¡ (sub Ïƒâ‚ âˆ˜ sub Ïƒâ‚‚) M
  subâ— Ïƒâ‚ Ïƒâ‚‚ (ğ“‹ i)   = getâ— Ïƒâ‚ Ïƒâ‚‚ i
  subâ— Ïƒâ‚ Ïƒâ‚‚ (Æ› M)   = Æ› & subliftâ— Ïƒâ‚ Ïƒâ‚‚ M
  subâ— Ïƒâ‚ Ïƒâ‚‚ (M âˆ™ N) = _âˆ™_ & subâ— Ïƒâ‚ Ïƒâ‚‚ M
                           âŠ— subâ— Ïƒâ‚ Ïƒâ‚‚ N

  subliftâ— : âˆ€ {Î“ Î Î¦ A B} â†’ (Ïƒâ‚ : Î“ âŠ¢â‹† Î) (Ïƒâ‚‚ : Î âŠ¢â‹† Î¦) (M : Î¦ , B âŠ¢ A)
                           â†’ sub (liftâ‚› {B} (Ïƒâ‚‚ â— Ïƒâ‚)) M â‰¡
                              (sub (liftâ‚› Ïƒâ‚) âˆ˜ sub (liftâ‚› Ïƒâ‚‚)) M
  subliftâ— Ïƒâ‚ Ïƒâ‚‚ M = (Î» Ïƒâ€² â†’ sub (Ïƒâ€² , 0) M)
                     & ( compâ—â— (wkâ‚‘ idâ‚‘) Ïƒâ‚ Ïƒâ‚‚
                       â¦™ (Ïƒâ‚‚ â—_) & (lidâ—‘ (wkâ‚› Ïƒâ‚) â»Â¹)
                       â¦™ compâ—â—‘ (liftâ‚› Ïƒâ‚) (wkâ‚‘ idâ‚‘) Ïƒâ‚‚ â»Â¹
                       )
                   â¦™ subâ— (liftâ‚› Ïƒâ‚) (liftâ‚› Ïƒâ‚‚) M


--------------------------------------------------------------------------------


-- (âˆˆ-idâ‚›)
idgetâ‚› : âˆ€ {Î“ A} â†’ (i : Î“ âˆ‹ A)
                 â†’ getâ‚› idâ‚› i â‰¡ ğ“‹ i
idgetâ‚› zero    = refl
idgetâ‚› (suc i) = getâ— (wkâ‚‘ idâ‚‘) idâ‚› i
               â¦™ wk & idgetâ‚› i
               â¦™ ğ“‹ âˆ˜ suc & idgetâ‚‘ i

-- (Tm-idâ‚›)
idsub : âˆ€ {Î“ A} â†’ (M : Î“ âŠ¢ A)
                â†’ sub idâ‚› M â‰¡ M
idsub (ğ“‹ i)   = idgetâ‚› i
idsub (Æ› M)   = Æ› & idsub M
idsub (M âˆ™ N) = _âˆ™_ & idsub M
                    âŠ— idsub N


--------------------------------------------------------------------------------


-- (idrâ‚›)
ridâ— : âˆ€ {Î“ Î} â†’ (Ïƒ : Î“ âŠ¢â‹† Î)
               â†’ Ïƒ â— idâ‚› â‰¡ Ïƒ
ridâ— âˆ…       = refl
ridâ— (Ïƒ , M) = _,_ & ridâ— Ïƒ
                   âŠ— idsub M

-- (idlâ‚›)
lidâ— : âˆ€ {Î“ Î} â†’ (Ïƒ : Î“ âŠ¢â‹† Î)
               â†’ idâ‚› â— Ïƒ â‰¡ Ïƒ
lidâ— âˆ…       = refl
lidâ— (Ïƒ , M) = (_, M) & ( compâ—â—‘ (Ïƒ , M) (wkâ‚‘ idâ‚‘) idâ‚›
                        â¦™ lidâ— (idâ‚‘ â—‘ Ïƒ)
                        â¦™ lidâ—‘ Ïƒ
                        )

-- (assâ‚›)
assocâ— : âˆ€ {Î“ Î Î¦ Î¨} â†’ (Ïƒâ‚ : Î“ âŠ¢â‹† Î) (Ïƒâ‚‚ : Î âŠ¢â‹† Î¦) (Ïƒâ‚ƒ : Î¦ âŠ¢â‹† Î¨)
                     â†’ (Ïƒâ‚ƒ â— Ïƒâ‚‚) â— Ïƒâ‚ â‰¡ Ïƒâ‚ƒ â— (Ïƒâ‚‚ â— Ïƒâ‚)
assocâ— Ïƒâ‚ Ïƒâ‚‚ âˆ…        = refl
assocâ— Ïƒâ‚ Ïƒâ‚‚ (Ïƒâ‚ƒ , M) = _,_ & assocâ— Ïƒâ‚ Ïƒâ‚‚ Ïƒâ‚ƒ
                            âŠ— (subâ— Ïƒâ‚ Ïƒâ‚‚ M â»Â¹)


--------------------------------------------------------------------------------


ğ—¦ğ—§ğ—Ÿğ—– : Category ğ’ _âŠ¢â‹†_
ğ—¦ğ—§ğ—Ÿğ—– =
  record
    { idâ‚“    = idâ‚›
    ; _â‹„_    = _â—_
    ; lidâ‹„   = lidâ—
    ; ridâ‹„   = ridâ—
    ; assocâ‹„ = assocâ—
    }


subPsh : ğ’¯ â†’ Presheafâ‚€ ğ—¦ğ—§ğ—Ÿğ—–
subPsh A =
  record
    { Fâ‚“  = _âŠ¢ A
    ; F   = sub
    ; idF = fext! idsub
    ; Fâ‹„  = Î» Ïƒâ‚ Ïƒâ‚‚ â†’ fext! (subâ— Ïƒâ‚‚ Ïƒâ‚)
    }


--------------------------------------------------------------------------------
