module STLC.Kovacs.PresheafRefinement where

open import STLC.Kovacs.Substitution public
open import STLC.Kovacs.Normalisation public
open import Category


--------------------------------------------------------------------------------


-- (Tyá´º-idâ‚‘)
idacc : âˆ€ {A Î“} â†’ (a : Î“ âŠ© A)
                â†’ acc idâ‚‘ a â‰¡ a
idacc {âµ}      M = idrenâ¿á¶  M
idacc {A â‡’ B} f = fextÂ¡ (fext! (Î» Î· â†’ f & lidâ—‹ Î·))

-- (Tyá´º-âˆ˜â‚‘)
accâ—‹ : âˆ€ {A Î“ Î“â€² Î“â€³} â†’ (Î·â‚ : Î“â€³ âŠ‡ Î“â€²) (Î·â‚‚ : Î“â€² âŠ‡ Î“) (a : Î“ âŠ© A)
                     â†’ acc (Î·â‚‚ â—‹ Î·â‚) a â‰¡ (acc Î·â‚ âˆ˜ acc Î·â‚‚) a
accâ—‹ {âµ}      Î·â‚ Î·â‚‚ M = renâ¿á¶ â—‹ Î·â‚ Î·â‚‚ M
accâ—‹ {A â‡’ B} Î·â‚ Î·â‚‚ f = fextÂ¡ (fext! (Î» Î·â€² â†’ f & assocâ—‹ Î·â€² Î·â‚ Î·â‚‚))

-- (Coná´º-idâ‚‘)
lidâ¬– : âˆ€ {Î“ Î} â†’ (Ï : Î“ âŠ©â‹† Î)
               â†’ Ï â¬– idâ‚‘ â‰¡ Ï
lidâ¬– âˆ…       = refl
lidâ¬– (Ï , a) = _,_ & lidâ¬– Ï
                   âŠ— idacc a

-- (Coná´º-âˆ˜â‚‘)
compâ¬–â—‹ : âˆ€ {Î“ Î“â€² Î“â€³ Î} â†’ (Î·â‚ : Î“â€³ âŠ‡ Î“â€²) (Î·â‚‚ : Î“â€² âŠ‡ Î“) (Ï : Î“ âŠ©â‹† Î)
                       â†’ (Ï â¬– Î·â‚‚) â¬– Î·â‚ â‰¡ Ï â¬– (Î·â‚‚ â—‹ Î·â‚)
compâ¬–â—‹ Î·â‚ Î·â‚‚ âˆ…       = refl
compâ¬–â—‹ Î·â‚ Î·â‚‚ (Ï , a) = _,_ & compâ¬–â—‹ Î·â‚ Î·â‚‚ Ï
                           âŠ— (accâ—‹ Î·â‚ Î·â‚‚ a â»Â¹)

-- (âˆˆá´º-nat)
getâ¬– : âˆ€ {Î“ Î“â€² Î A} â†’ (Î· : Î“â€² âŠ‡ Î“) (Ï : Î“ âŠ©â‹† Î) (i : Î âˆ‹ A)
                    â†’ getáµ¥ (Ï â¬– Î·) i â‰¡ (acc Î· âˆ˜ getáµ¥ Ï) i
getâ¬– Î· (Ï , a) zero    = refl
getâ¬– Î· (Ï , a) (suc i) = getâ¬– Î· Ï i


--------------------------------------------------------------------------------


-- (Tyá´¾)
ğ’° : âˆ€ {A Î“} â†’ Î“ âŠ© A â†’ Set

ğ’° {âµ}      {Î“} M = âŠ¤

ğ’° {A â‡’ B} {Î“} f = âˆ€ {Î“â€²} â†’ (Î· : Î“â€² âŠ‡ Î“) {a : Î“â€² âŠ© A} (u : ğ’° a)
                          â†’ (âˆ€ {Î“â€³} â†’ (Î·â€² : Î“â€³ âŠ‡ Î“â€²)
                                     â†’ (f (Î· â—‹ Î·â€²) âˆ˜ acc Î·â€²) a â‰¡
                                        (acc Î·â€² âˆ˜ f Î·) a)
                           Ã— ğ’° (f Î· a)


-- (Tyá´¾â‚‘)
accğ’° : âˆ€ {A Î“ Î“â€²} â†’ {a : Î“ âŠ© A}
                  â†’ (Î· : Î“â€² âŠ‡ Î“) â†’ ğ’° a
                  â†’ ğ’° (acc Î· a)
accğ’° {âµ}      {a = M} Î· tt = tt
accğ’° {A â‡’ B} {a = f} Î· u  = Î» Î·â€² {a} uâ€² â†’
                               let
                                 natf , uâ€³ = u (Î· â—‹ Î·â€²) uâ€²
                               in
                                 (Î» Î·â€³ â†’ (Î» Î·â€´ â†’ (f Î·â€´ âˆ˜ acc Î·â€³) a)
                                          & (assocâ—‹ Î·â€³ Î·â€² Î· â»Â¹)
                                        â¦™ natf Î·â€³)
                               , uâ€³

-- (Coná´¾ ; âˆ™ ; _,_)
data ğ’°â‹† : âˆ€ {Î“ Î} â†’ Î“ âŠ©â‹† Î â†’ Set where
  âˆ…   : âˆ€ {Î“} â†’ ğ’°â‹† (âˆ… {Î“})

  _,_ : âˆ€ {Î“ Î A} â†’ {Ï : Î“ âŠ©â‹† Î} {a : Î“ âŠ© A}
                  â†’ (Ï… : ğ’°â‹† Ï) (u : ğ’° a)
                  â†’ ğ’°â‹† (Ï , a)

-- (Coná´¾â‚‘)
-- NOTE _â¬–ğ’°_ = accğ’°â‹†
_â¬–ğ’°_ : âˆ€ {Î“ Î“â€² Î} â†’ {Ï : Î“ âŠ©â‹† Î}
                  â†’ ğ’°â‹† Ï â†’ (Î· : Î“â€² âŠ‡ Î“)
                  â†’ ğ’°â‹† (Ï â¬– Î·)
âˆ…       â¬–ğ’° Î· = âˆ…
(Ï… , u) â¬–ğ’° Î· = Ï… â¬–ğ’° Î· , accğ’° Î· u


--------------------------------------------------------------------------------

-- (âˆˆá´¾)
getğ’° : âˆ€ {Î“ Î A} â†’ {Ï : Î“ âŠ©â‹† Î}
                 â†’ ğ’°â‹† Ï â†’ (i : Î âˆ‹ A)
                 â†’ ğ’° (getáµ¥ Ï i)
getğ’° (Ï… , u) zero    = u
getğ’° (Ï… , u) (suc i) = getğ’° Ï… i


mutual
  -- (Tmá´¾)
  evalğ’° : âˆ€ {Î“ Î A} â†’ {Ï : Î“ âŠ©â‹† Î}
                    â†’ ğ’°â‹† Ï â†’ (M : Î âŠ¢ A)
                    â†’ ğ’° (eval Ï M)
  evalğ’° {Ï = Ï} Ï… (` i)   = getğ’° Ï… i
  evalğ’° {Ï = Ï} Ï… (Æ› M)   = Î» Î· {a} u â†’
                              (Î» Î·â€² â†’ (Î» Ïâ€² â†’ eval (Ïâ€² , acc Î·â€² a) M)
                                       & (compâ¬–â—‹ Î·â€² Î· Ï â»Â¹)
                                     â¦™ evalâ¬– Î·â€² (Ï… â¬–ğ’° Î· , u) M)
                            , evalğ’° (Ï… â¬–ğ’° Î· , u) M
  evalğ’° {Ï = Ï} Ï… (M âˆ™ N) = projâ‚‚ (evalğ’° Ï… M idâ‚‘ (evalğ’° Ï… N))

  -- (Tmá´º-nat)
  evalâ¬– : âˆ€ {Î“ Î“â€² Î A} â†’ {Ï : Î“ âŠ©â‹† Î}
                       â†’ (Î· : Î“â€² âŠ‡ Î“) â†’ ğ’°â‹† Ï â†’ (M : Î âŠ¢ A)
                       â†’ eval (Ï â¬– Î·) M â‰¡ (acc Î· âˆ˜ eval Ï) M
  evalâ¬– {Ï = Ï} Î· Ï… (` i)   = getâ¬– Î· Ï i
  evalâ¬– {Ï = Ï} Î· Ï… (Æ› M)   = fextÂ¡ (fext! (Î» Î·â€² â†’ fext! (Î» a â†’
                                (Î» Ïâ€² â†’ eval Ïâ€² M)
                                & ((_, a) & compâ¬–â—‹ Î·â€² Î· Ï))))
  evalâ¬– {Ï = Ï} Î· Ï… (M âˆ™ N) rewrite evalâ¬– Î· Ï… M | evalâ¬– Î· Ï… N
                            = (Î» Î·â€² â†’ eval Ï M Î·â€² (acc Î· (eval Ï N)))
                              & (ridâ—‹ Î· â¦™ lidâ—‹ Î· â»Â¹)
                            â¦™ projâ‚ (evalğ’° Ï… M idâ‚‘ (evalğ’° Ï… N)) Î·


mutual
  -- (uá´¾)
  reflectğ’° : âˆ€ {A Î“} â†’ (M : Î“ âŠ¢â¿áµ‰ A)
                     â†’ ğ’° (reflect M)
  reflectğ’° {âµ}      M = tt
  reflectğ’° {A â‡’ B} M = Î» Î· {a} u â†’
                          (Î» Î·â€² â†’ (Î» Mâ€² Nâ€² â†’ reflect (Mâ€² âˆ™ Nâ€²))
                                   & renâ¿áµ‰â—‹ Î·â€² Î· M
                                   âŠ— (natreify Î·â€² a u)
                                 â¦™ natreflect Î·â€² (renâ¿áµ‰ Î· M âˆ™ reify a))
                        , reflectğ’° (renâ¿áµ‰ Î· M âˆ™ reify a)

  -- (qá´º-nat)
  natreify : âˆ€ {A Î“ Î“â€²} â†’ (Î· : Î“â€² âŠ‡ Î“) (a : Î“ âŠ© A) â†’ ğ’° a
                        â†’ (reify âˆ˜ acc Î·) a â‰¡ (renâ¿á¶  Î· âˆ˜ reify) a
  natreify {âµ}      Î· M u = refl
  natreify {A â‡’ B} Î· f u =
    let
      natf , uâ€² = u (wkâ‚‘ idâ‚‘) (reflectğ’° 0)
    in
      Æ› & ( reify & ( f & (wkâ‚‘ & ( ridâ—‹ Î·
                                 â¦™ lidâ—‹ Î· â»Â¹
                                 ))
                        âŠ— natreflect (liftâ‚‘ Î·) 0
                    â¦™ natf (liftâ‚‘ Î·)
                    )
          â¦™ natreify (liftâ‚‘ Î·) (f (wkâ‚‘ idâ‚‘) (reflect 0)) uâ€²
          )

  -- (uá´º-nat)
  natreflect : âˆ€ {A Î“ Î“â€²} â†’ (Î· : Î“â€² âŠ‡ Î“) (M : Î“ âŠ¢â¿áµ‰ A)
                          â†’ (reflect âˆ˜ renâ¿áµ‰ Î·) M â‰¡ (acc Î· âˆ˜ reflect) M
  natreflect {âµ}      Î· M = refl
  natreflect {A â‡’ B} Î· M = fextÂ¡ (fext! (Î» Î·â€² â†’ fext! (Î» a â†’
                              (Î» Mâ€² â†’ reflect (Mâ€² âˆ™ reify a))
                              & (renâ¿áµ‰â—‹ Î·â€² Î· M â»Â¹))))

-- (uá¶œá´¾)
idğ’° : âˆ€ {Î“} â†’ ğ’°â‹† (idáµ¥ {Î“})
idğ’° {âˆ…}     = âˆ…
idğ’° {Î“ , A} = idğ’° â¬–ğ’° wkâ‚‘ idâ‚‘ , reflectğ’° 0


--------------------------------------------------------------------------------


-- (OPEá´º)
_â¬—_ : âˆ€ {Î“ Î Îâ€²} â†’ Îâ€² âŠ‡ Î â†’ Î“ âŠ©â‹† Îâ€² â†’ Î“ âŠ©â‹† Î
done    â¬— Ï       = Ï
wkâ‚‘ Î·   â¬— (Ï , a) = Î· â¬— Ï
liftâ‚‘ Î· â¬— (Ï , a) = Î· â¬— Ï , a

-- (OPEá´º-nat)
natâ¬— : âˆ€ {Î“ Î“â€² Î Îâ€²} â†’ (Î·â‚ : Î“â€² âŠ‡ Î“) (Ï : Î“ âŠ©â‹† Îâ€²) (Î·â‚‚ : Îâ€² âŠ‡ Î)
                     â†’ Î·â‚‚ â¬— (Ï â¬– Î·â‚) â‰¡ (Î·â‚‚ â¬— Ï) â¬– Î·â‚
natâ¬— Î·â‚ Ï       done       = refl
natâ¬— Î·â‚ (Ï , a) (wkâ‚‘ Î·â‚‚)   = natâ¬— Î·â‚ Ï Î·â‚‚
natâ¬— Î·â‚ (Ï , a) (liftâ‚‘ Î·â‚‚) = (_, acc Î·â‚ a) & natâ¬— Î·â‚ Ï Î·â‚‚

-- (OPEá´º-idâ‚‘)
lidâ¬— : âˆ€ {Î“ Î} â†’ (Ï : Î“ âŠ©â‹† Î)
               â†’ idâ‚‘ â¬— Ï â‰¡ Ï
lidâ¬— âˆ…       = refl
lidâ¬— (Ï , a) = (_, a) & lidâ¬— Ï


--------------------------------------------------------------------------------


-- (âˆˆâ‚‘á´º)
getâ¬— : âˆ€ {Î“ Î Îâ€² A} â†’ (Ï : Î“ âŠ©â‹† Îâ€²) (Î· : Îâ€² âŠ‡ Î) (i : Î âˆ‹ A)
                    â†’ getáµ¥ (Î· â¬— Ï) i â‰¡ (getáµ¥ Ï âˆ˜ getâ‚‘ Î·) i
getâ¬— Ï       done      i       = refl
getâ¬— (Ï , a) (wkâ‚‘ Î·)   i       = getâ¬— Ï Î· i
getâ¬— (Ï , a) (liftâ‚‘ Î·) zero    = refl
getâ¬— (Ï , a) (liftâ‚‘ Î·) (suc i) = getâ¬— Ï Î· i

-- (Tmâ‚‘á´º)
evalâ¬— : âˆ€ {Î“ Î Îâ€² A} â†’ (Ï : Î“ âŠ©â‹† Îâ€²) (Î· : Îâ€² âŠ‡ Î) (M : Î âŠ¢ A)
                     â†’ eval (Î· â¬— Ï) M â‰¡ (eval Ï âˆ˜ ren Î·) M
evalâ¬— Ï Î· (` i)   = getâ¬— Ï Î· i
evalâ¬— Ï Î· (Æ› M)   = fextÂ¡ (fext! (Î» Î·â€² â†’ fext! (Î» a â†’
                      (Î» Ïâ€² â†’ eval (Ïâ€² , a) M) & natâ¬— Î·â€² Ï Î· â»Â¹
                    â¦™ evalâ¬— (Ï â¬– Î·â€² , a) (liftâ‚‘ Î·) M)))
evalâ¬— Ï Î· (M âˆ™ N) rewrite evalâ¬— Ï Î· M | evalâ¬— Ï Î· N
                  = refl


--------------------------------------------------------------------------------


-- (Subá´º)
-- NOTE: _â—†_ = evalâ‹†
_â—†_ : âˆ€ {Î“ Î Î¦} â†’ Î âŠ¢â‹† Î¦ â†’ Î“ âŠ©â‹† Î â†’ Î“ âŠ©â‹† Î¦
âˆ…       â—† Ï = âˆ…
(Ïƒ , M) â—† Ï = Ïƒ â—† Ï , eval Ï M

-- (Subá´º-nat)
compâ—†â¬– : âˆ€ {Î“ Î“â€² Î Î¦} â†’ {Ï : Î“ âŠ©â‹† Î}
                      â†’ (Î· : Î“â€² âŠ‡ Î“) â†’ ğ’°â‹† Ï â†’ (Ïƒ : Î âŠ¢â‹† Î¦)
                      â†’ (Ïƒ â—† Ï) â¬– Î· â‰¡ Ïƒ â—† (Ï â¬– Î·)
compâ—†â¬– Î· Ï… âˆ…       = refl
compâ—†â¬– Î· Ï… (Ïƒ , M) = _,_ & compâ—†â¬– Î· Ï… Ïƒ
                         âŠ— (evalâ¬– Î· Ï… M â»Â¹)

-- (Subá´º-â‚›âˆ˜â‚‘)
compâ—†â¬— : âˆ€ {Î“ Î Îâ€² Î¦} â†’ (Ï : Î“ âŠ©â‹† Îâ€²) (Î· : Îâ€² âŠ‡ Î) (Ïƒ : Î âŠ¢â‹† Î¦)
                      â†’ (Ïƒ â— Î·) â—† Ï â‰¡ Ïƒ â—† (Î· â¬— Ï)
compâ—†â¬— Ï Î· âˆ…       = refl
compâ—†â¬— Ï Î· (Ïƒ , M) = _,_ & compâ—†â¬— Ï Î· Ïƒ
                         âŠ— (evalâ¬— Ï Î· M â»Â¹)

-- (âˆˆâ‚›á´º)
getâ—† : âˆ€ {Î“ Î Î¦ A} â†’ (Ï : Î“ âŠ©â‹† Î) (Ïƒ : Î âŠ¢â‹† Î¦) (i : Î¦ âˆ‹ A)
                   â†’ getáµ¥ (Ïƒ â—† Ï) i â‰¡ (eval Ï âˆ˜ getâ‚› Ïƒ) i
getâ—† Ï (Ïƒ , M) zero    = refl
getâ—† Ï (Ïƒ , M) (suc i) = getâ—† Ï Ïƒ i

-- (Subá´º-idâ‚›)
lidâ—† : âˆ€ {Î“ Î} â†’ (Ï : Î“ âŠ©â‹† Î)
               â†’ idâ‚› â—† Ï â‰¡ Ï
lidâ—† âˆ…       = refl
lidâ—† (Ï , a) = (_, a) & ( compâ—†â¬— (Ï , a) (wkâ‚‘ idâ‚‘) idâ‚›
                        â¦™ lidâ—† (idâ‚‘ â¬— Ï)
                        â¦™ lidâ¬— Ï
                        )


--------------------------------------------------------------------------------


accPsh : ğ’¯ â†’ Presheafâ‚€ ğ—¢ğ—£ğ—˜
accPsh A =
  record
    { Fâ‚“  = _âŠ© A
    ; F   = acc
    ; idF = fext! idacc
    ; Fâ‹„  = Î» Î·â‚ Î·â‚‚ â†’ fext! (accâ—‹ Î·â‚‚ Î·â‚)
    }

flipâ¬–Psh : ğ’ â†’ Presheafâ‚€ ğ—¢ğ—£ğ—˜
flipâ¬–Psh Î =
  record
    { Fâ‚“  = _âŠ©â‹† Î
    ; F   = flip _â¬–_
    ; idF = fext! lidâ¬–
    ; Fâ‹„  = Î» Î·â‚ Î·â‚‚ â†’ fext! (Î» Ï â†’ compâ¬–â—‹ Î·â‚‚ Î·â‚ Ï â»Â¹)
    }


getáµ¥NT : âˆ€ {Î A} â†’ (i : Î âˆ‹ A)
                 â†’ NaturalTransformation (flipâ¬–Psh Î) (accPsh A)
getáµ¥NT i =
  record
    { N    = flip getáµ¥ i
    ; natN = Î» Î· â†’ fext! (Î» Ï â†’ getâ¬– Î· Ï i)
    }

-- TODO
-- evalNT : âˆ€ {Î A} â†’ (M : Î âŠ¢ A)
--                  â†’ NaturalTransformation (flipâ¬–Psh Î) (accPsh A)
-- evalNT M =
--   record
--     { N    = flip eval M
--     ; natN = Î» Î· â†’ fext! (Î» Ï â†’ evalâ¬– {Ï = Ï} Î· {!!} M)
--     }

-- TODO
-- reifyNT : âˆ€ {A} â†’ NaturalTransformation (accPsh A) (renâ¿á¶ Psh A)
-- reifyNT =
--   record
--     { N    = reify
--     ; natN = Î» Î· â†’ fext! (Î» a â†’ natreify Î· a {!!})
--     }

reflectNT : âˆ€ {A} â†’ NaturalTransformation (renâ¿áµ‰Psh A) (accPsh A)
reflectNT =
  record
    { N    = reflect
    ; natN = Î» Î· â†’ fext! (Î» M â†’ natreflect Î· M)
    }


--------------------------------------------------------------------------------
