module STLC.Coquand.Convertibility where

open import STLC.Coquand.Substitution public


--------------------------------------------------------------------------------


-- Convertibility
infix  3 _âˆ¼_
data _âˆ¼_ : âˆ€ {Î“ A} â†’ Î“ âŠ¢ A â†’ Î“ âŠ¢ A â†’ Set
  where
    reflâˆ¼ : âˆ€ {Î“ A} â†’ {M : Î“ âŠ¢ A}
                    â†’ M âˆ¼ M

    _â»Â¹âˆ¼  : âˆ€ {Î“ A} â†’ {Mâ‚ Mâ‚‚ : Î“ âŠ¢ A}
                    â†’ (p : Mâ‚ âˆ¼ Mâ‚‚)
                    â†’ Mâ‚‚ âˆ¼ Mâ‚

    _â¦™âˆ¼_  : âˆ€ {Î“ A} â†’ {Mâ‚ Mâ‚‚ Mâ‚ƒ : Î“ âŠ¢ A}
                    â†’ (p : Mâ‚ âˆ¼ Mâ‚‚) (q : Mâ‚‚ âˆ¼ Mâ‚ƒ)
                    â†’ Mâ‚ âˆ¼ Mâ‚ƒ

    Æ›âˆ¼    : âˆ€ {Î“ A B} â†’ {Mâ‚ Mâ‚‚ : Î“ , A âŠ¢ B}
                      â†’ (p : Mâ‚ âˆ¼ Mâ‚‚)
                      â†’ Æ› Mâ‚ âˆ¼ Æ› Mâ‚‚

    _âˆ™âˆ¼_  : âˆ€ {Î“ A B} â†’ {Mâ‚ Mâ‚‚ : Î“ âŠ¢ A â‡’ B} {Nâ‚ Nâ‚‚ : Î“ âŠ¢ A}
                      â†’ (p : Mâ‚ âˆ¼ Mâ‚‚) (q : Nâ‚ âˆ¼ Nâ‚‚)
                      â†’ Mâ‚ âˆ™ Nâ‚ âˆ¼ Mâ‚‚ âˆ™ Nâ‚‚

    redâ‡’ : âˆ€ {Î“ Î A B} â†’ (Ïƒ : Î“ âŠ¢â‹† Î) (M : Î , A âŠ¢ B) (N : Î“ âŠ¢ A)
                        â†’ sub Ïƒ (Æ› M) âˆ™ N âˆ¼ sub (Ïƒ , N) M

    expâ‡’ : âˆ€ {Î“ A B} â†’ (M : Î“ âŠ¢ A â‡’ B)
                      â†’ M âˆ¼ Æ› (wk M âˆ™ 0)


â‰¡â†’âˆ¼ : âˆ€ {Î“ A} â†’ {Mâ‚ Mâ‚‚ : Î“ âŠ¢ A}
               â†’ Mâ‚ â‰¡ Mâ‚‚
               â†’ Mâ‚ âˆ¼ Mâ‚‚
â‰¡â†’âˆ¼ refl = reflâˆ¼

instance
  perâˆ¼ : âˆ€ {Î“ A} â†’ PER (Î“ âŠ¢ A) _âˆ¼_
  perâˆ¼ =
    record
      { _â»Â¹ = _â»Â¹âˆ¼
      ; _â¦™_ = _â¦™âˆ¼_
      }


--------------------------------------------------------------------------------


renredâ‡’ : âˆ€ {Î“ Î“â€² Î A B} â†’ {Î· : Î“â€² âˆ‹â‹† Î“}
                          â†’ (Ïƒ : Î“ âŠ¢â‹† Î) (M : Î , A âŠ¢ B) (N : Î“ âŠ¢ A)
                          â†’ ren Î· (sub Ïƒ (Æ› M) âˆ™ N) âˆ¼ ren Î· (sub (Ïƒ , N) M)
renredâ‡’ {Î· = Î·} Ïƒ M N = Æ›âˆ¼ (â‰¡â†’âˆ¼ (subliftâ—‘ Î· Ïƒ M â»Â¹)) âˆ™âˆ¼ reflâˆ¼
                       â¦™ redâ‡’ (Î· â—‘ Ïƒ) M (ren Î· N)
                       â¦™ â‰¡â†’âˆ¼ ( (Î» Ïƒâ€² â†’ sub Ïƒâ€² M)
                                & ((âŒŠ Î· âŒ‹ â— Ïƒ ,_) & âŒŠsubâŒ‹ Î· N â»Â¹)
                              â¦™ subâ—‘ Î· (Ïƒ , N) M
                              )

renexpâ‡’ğ“‹ : âˆ€ {Î“ Î“â€² A B} â†’ {Î· : Î“â€² âˆ‹â‹† Î“}
                         â†’ (i : Î“ âˆ‹ A â‡’ B)
                         â†’ ren Î· (ğ“‹ i) âˆ¼ ren Î· (Æ› (wk (ğ“‹ i) âˆ™ 0))
renexpâ‡’ğ“‹ {Î· = Î·} i = expâ‡’ (ğ“‹ (getáµ£ Î· i))
                    â¦™ Æ›âˆ¼ (â‰¡â†’âˆ¼ (ğ“‹ & ( getâ—‹ (wkáµ£ idáµ£) Î· i â»Â¹
                                    â¦™ (Î» Î·â€² â†’ getáµ£ Î·â€² i)
                                      & ( wklidâ—‹ Î·
                                        â¦™ liftwkridâ—‹ Î· â»Â¹
                                        )
                                    â¦™ getâ—‹ (liftáµ£ Î·) (wkáµ£ idáµ£) i
                                    )) âˆ™âˆ¼ reflâˆ¼)

renexpâ‡’Æ› : âˆ€ {Î“ Î“â€² A B} â†’ {Î· : Î“â€² âˆ‹â‹† Î“}
                         â†’ (M : Î“ , A âŠ¢ B)
                         â†’ ren Î· (Æ› M) âˆ¼ ren Î· (Æ› (wk (Æ› M) âˆ™ 0))
renexpâ‡’Æ› {Î· = Î·} M = expâ‡’ (Æ› (ren (liftáµ£ Î·) M))
                    â¦™ Æ›âˆ¼ (Æ›âˆ¼ (â‰¡â†’âˆ¼ ( renliftâ—‹ (wkáµ£ idáµ£) Î· M â»Â¹
                                   â¦™ (Î» Î·â€² â†’ ren Î·â€² M)
                                     & (liftáµ£ & ( wklidâ—‹ Î·
                                                â¦™ wkridâ—‹ Î· â»Â¹
                                                â¦™ zapâ—‹ (wkáµ£ Î·) idáµ£ 0 â»Â¹
                                                ))
                                   â¦™ renliftâ—‹ (liftáµ£ Î·) (wkáµ£ idáµ£) M
                                   )) âˆ™âˆ¼ reflâˆ¼)

renexpâ‡’âˆ™ : âˆ€ {Î“ Î“â€² A B C} â†’ {Î· : Î“â€² âˆ‹â‹† Î“}
                           â†’ (M : Î“ âŠ¢ A â‡’ B â‡’ C) (N : Î“ âŠ¢ A)
                           â†’ ren Î· (M âˆ™ N) âˆ¼ ren Î· (Æ› (wk (M âˆ™ N) âˆ™ 0))
renexpâ‡’âˆ™ {Î· = Î·} M N = expâ‡’ (ren Î· M âˆ™ ren Î· N)
                      â¦™ Æ›âˆ¼ ((â‰¡â†’âˆ¼ ( renâ—‹ (wkáµ£ idáµ£) Î· M â»Â¹
                                  â¦™ (Î» Î·â€² â†’ ren Î·â€² M)
                                    & ( wklidâ—‹ Î·
                                      â¦™ wkridâ—‹ Î· â»Â¹
                                      â¦™ wkâ—‹ Î· idáµ£ â»Â¹
                                      )
                                  â¦™ renliftwkâ—‹ Î· idáµ£ M
                                  )
                             âˆ™âˆ¼
                             â‰¡â†’âˆ¼ ( renâ—‹ (wkáµ£ idáµ£) Î· N â»Â¹
                                  â¦™ (Î» Î·â€² â†’ ren Î·â€² N)
                                    & ( wklidâ—‹ Î·
                                      â¦™ wkridâ—‹ Î· â»Â¹
                                      â¦™ wkâ—‹ Î· idáµ£ â»Â¹
                                      )
                                  â¦™ renliftwkâ—‹ Î· idáµ£ N
                                  )) âˆ™âˆ¼ reflâˆ¼)


renâˆ¼ : âˆ€ {Î“ Î“â€² A} â†’ {Î· : Î“â€² âˆ‹â‹† Î“} {Mâ‚ Mâ‚‚ : Î“ âŠ¢ A}
                  â†’ Mâ‚ âˆ¼ Mâ‚‚
                  â†’ ren Î· Mâ‚ âˆ¼ ren Î· Mâ‚‚
renâˆ¼ reflâˆ¼           = reflâˆ¼
renâˆ¼ (p â»Â¹âˆ¼)         = renâˆ¼ p â»Â¹
renâˆ¼ (p â¦™âˆ¼ q)        = renâˆ¼ p â¦™ renâˆ¼ q
renâˆ¼ (Æ›âˆ¼ p)          = Æ›âˆ¼ (renâˆ¼ p)
renâˆ¼ (p âˆ™âˆ¼ q)        = renâˆ¼ p âˆ™âˆ¼ renâˆ¼ q
renâˆ¼ (redâ‡’ Ïƒ M N)   = renredâ‡’ Ïƒ M N
renâˆ¼ (expâ‡’ (ğ“‹ i))   = renexpâ‡’ğ“‹ i
renâˆ¼ (expâ‡’ (Æ› M))   = renexpâ‡’Æ› M
renâˆ¼ (expâ‡’ (M âˆ™ N)) = renexpâ‡’âˆ™ M N


--------------------------------------------------------------------------------


subredâ‡’ : âˆ€ {Î“ Î Î¦ A B} â†’ {Ïƒâ‚ : Î“ âŠ¢â‹† Î}
                         â†’ (Ïƒâ‚‚ : Î âŠ¢â‹† Î¦) (M : Î¦ , A âŠ¢ B) (N : Î âŠ¢ A)
                         â†’ sub Ïƒâ‚ (sub Ïƒâ‚‚ (Æ› M) âˆ™ N) âˆ¼ sub Ïƒâ‚ (sub (Ïƒâ‚‚ , N) M)
subredâ‡’ {Ïƒâ‚ = Ïƒâ‚} Ïƒâ‚‚ M N = Æ›âˆ¼ (â‰¡â†’âˆ¼ (subliftâ— Ïƒâ‚ Ïƒâ‚‚ M â»Â¹)) âˆ™âˆ¼ reflâˆ¼
                          â¦™ redâ‡’ (Ïƒâ‚ â— Ïƒâ‚‚) M (sub Ïƒâ‚ N)
                          â¦™ â‰¡â†’âˆ¼ (subâ— Ïƒâ‚ (Ïƒâ‚‚ , N) M)

subexpâ‡’ğ“‹ : âˆ€ {Î“ Î A B} â†’ {Ïƒ : Î“ âŠ¢â‹† Î}
                        â†’ (i : Î âˆ‹ A â‡’ B)
                        â†’ sub Ïƒ (ğ“‹ i) âˆ¼ sub Ïƒ (Æ› (wk (ğ“‹ i) âˆ™ 0))
subexpâ‡’ğ“‹ {Ïƒ = Ïƒ} i = expâ‡’ (getâ‚› Ïƒ i)
                    â¦™ Æ›âˆ¼ (â‰¡â†’âˆ¼ ( natgetâ‚› Ïƒ i â»Â¹
                               â¦™ (Î» Ïƒâ€² â†’ getâ‚› Ïƒâ€² i) & liftwkridâ— Ïƒ â»Â¹
                               â¦™ getâ— (liftâ‚› Ïƒ) (wkáµ£ idáµ£) i
                               ) âˆ™âˆ¼ reflâˆ¼)

subexpâ‡’Æ› : âˆ€ {Î“ Î A B} â†’ {Ïƒ : Î“ âŠ¢â‹† Î}
                        â†’ (M : Î , A âŠ¢ B)
                        â†’ sub Ïƒ (Æ› M) âˆ¼ sub Ïƒ (Æ› (wk (Æ› M) âˆ™ 0))
subexpâ‡’Æ› {Ïƒ = Ïƒ} M = Æ›âˆ¼ ( â‰¡â†’âˆ¼ ( (Î» Ïƒâ€² â†’ sub Ïƒâ€² M)
                                  & ((_, 0)
                                     & ( ridâ— (wkâ‚› Ïƒ) â»Â¹
                                       â¦™ zapâ— (wkâ‚› Ïƒ) idáµ£ 0 â»Â¹
                                       â¦™ zapâ— (liftâ‚› Ïƒ) (wkáµ£ idáµ£) 0 â»Â¹
                                       ))
                                â¦™ subâ— (liftâ‚› Ïƒ , 0) (liftáµ£ (wkáµ£ idáµ£)) M
                                )
                         â¦™ redâ‡’ (liftâ‚› Ïƒ) (ren (liftáµ£ (wkáµ£ idáµ£)) M) 0 â»Â¹
                         )

subexpâ‡’âˆ™ : âˆ€ {Î“ Î A B C} â†’ {Ïƒ : Î“ âŠ¢â‹† Î}
                          â†’ (M : Î âŠ¢ A â‡’ B â‡’ C) (N : Î âŠ¢ A)
                          â†’ sub Ïƒ (M âˆ™ N) âˆ¼ sub Ïƒ (Æ› (wk (M âˆ™ N) âˆ™ 0))
subexpâ‡’âˆ™ {Ïƒ = Ïƒ} M N = expâ‡’ (sub Ïƒ M âˆ™ sub Ïƒ N)
                      â¦™ Æ›âˆ¼ ((â‰¡â†’âˆ¼ ( subâ—‘ (wkáµ£ idáµ£) Ïƒ M â»Â¹
                                  â¦™ (Î» Ïƒâ€² â†’ sub Ïƒâ€² M)
                                    & ( wklidâ—‘ Ïƒ
                                      â¦™ wkridâ— Ïƒ â»Â¹
                                      â¦™ wkâ— Ïƒ idáµ£ â»Â¹
                                      )
                                  â¦™ subliftwkâ— Ïƒ idáµ£ M
                                  )
                             âˆ™âˆ¼
                             â‰¡â†’âˆ¼ ( subâ—‘ (wkáµ£ idáµ£) Ïƒ N â»Â¹
                                  â¦™ (Î» Ïƒâ€² â†’ sub Ïƒâ€² N)
                                    & ( wklidâ—‘ Ïƒ
                                      â¦™ wkridâ— Ïƒ â»Â¹
                                      â¦™ wkâ— Ïƒ idáµ£ â»Â¹
                                      )
                                  â¦™ subliftwkâ— Ïƒ idáµ£ N
                                  )) âˆ™âˆ¼ reflâˆ¼)


subâˆ¼ : âˆ€ {Î“ Î A} â†’ {Ïƒ : Î“ âŠ¢â‹† Î} {Mâ‚ Mâ‚‚ : Î âŠ¢ A}
                 â†’ Mâ‚ âˆ¼ Mâ‚‚
                 â†’ sub Ïƒ Mâ‚ âˆ¼ sub Ïƒ Mâ‚‚
subâˆ¼ reflâˆ¼           = reflâˆ¼
subâˆ¼ (p â»Â¹âˆ¼)         = subâˆ¼ p â»Â¹
subâˆ¼ (p â¦™âˆ¼ q)        = subâˆ¼ p â¦™ subâˆ¼ q
subâˆ¼ (Æ›âˆ¼ p)          = Æ›âˆ¼ (subâˆ¼ p)
subâˆ¼ (p âˆ™âˆ¼ q)        = subâˆ¼ p âˆ™âˆ¼ subâˆ¼ q
subâˆ¼ (redâ‡’ Ïƒ M N)   = subredâ‡’ Ïƒ M N
subâˆ¼ (expâ‡’ (ğ“‹ i))   = subexpâ‡’ğ“‹ i
subâˆ¼ (expâ‡’ (Æ› M))   = subexpâ‡’Æ› M
subâˆ¼ (expâ‡’ (M âˆ™ N)) = subexpâ‡’âˆ™ M N



--------------------------------------------------------------------------------


-- Convertibility of substitutions
infix 3 _âˆ¼â‹†_
data _âˆ¼â‹†_ : âˆ€ {Î“ Î} â†’ Î“ âŠ¢â‹† Î â†’ Î“ âŠ¢â‹† Î â†’ Set
  where
    âˆ…   : âˆ€ {Î“} â†’ âˆ… {Î“} âˆ¼â‹† âˆ…

    _,_ : âˆ€ {Î“ Î A} â†’ {Ïƒâ‚ Ïƒâ‚‚ : Î“ âŠ¢â‹† Î} {Mâ‚ Mâ‚‚ : Î“ âŠ¢ A}
                    â†’ (Ï‡ : Ïƒâ‚ âˆ¼â‹† Ïƒâ‚‚) (p : Mâ‚ âˆ¼ Mâ‚‚)
                    â†’ Ïƒâ‚ , Mâ‚ âˆ¼â‹† Ïƒâ‚‚ , Mâ‚‚


reflâˆ¼â‹† : âˆ€ {Î“ Î} â†’ {Ïƒ : Î“ âŠ¢â‹† Î}
                 â†’ Ïƒ âˆ¼â‹† Ïƒ
reflâˆ¼â‹† {Ïƒ = âˆ…}     = âˆ…
reflâˆ¼â‹† {Ïƒ = Ïƒ , M} = reflâˆ¼â‹† , reflâˆ¼

_â»Â¹âˆ¼â‹† : âˆ€ {Î“ Î} â†’ {Ïƒâ‚ Ïƒâ‚‚ : Î“ âŠ¢â‹† Î}
                â†’ Ïƒâ‚ âˆ¼â‹† Ïƒâ‚‚
                â†’ Ïƒâ‚‚ âˆ¼â‹† Ïƒâ‚
âˆ…       â»Â¹âˆ¼â‹† = âˆ…
(Ï‡ , p) â»Â¹âˆ¼â‹† = Ï‡ â»Â¹âˆ¼â‹† , p â»Â¹

_â¦™âˆ¼â‹†_ : âˆ€ {Î“ Î} â†’ {Ïƒâ‚ Ïƒâ‚‚ Ïƒâ‚ƒ : Î“ âŠ¢â‹† Î}
                â†’ Ïƒâ‚ âˆ¼â‹† Ïƒâ‚‚ â†’ Ïƒâ‚‚ âˆ¼â‹† Ïƒâ‚ƒ
                â†’ Ïƒâ‚ âˆ¼â‹† Ïƒâ‚ƒ
âˆ…        â¦™âˆ¼â‹† âˆ…        = âˆ…
(Ï‡â‚ , p) â¦™âˆ¼â‹† (Ï‡â‚‚ , q) = (Ï‡â‚ â¦™âˆ¼â‹† Ï‡â‚‚) , (p â¦™ q)


â‰¡â†’âˆ¼â‹† : âˆ€ {Î“ Î} â†’ {Ïƒâ‚ Ïƒâ‚‚ : Î“ âŠ¢â‹† Î}
                â†’ Ïƒâ‚ â‰¡ Ïƒâ‚‚
                â†’ Ïƒâ‚ âˆ¼â‹† Ïƒâ‚‚
â‰¡â†’âˆ¼â‹† refl = reflâˆ¼â‹†

instance
  perâˆ¼â‹† : âˆ€ {Î“ Î} â†’ PER (Î“ âŠ¢â‹† Î) _âˆ¼â‹†_
  perâˆ¼â‹† =
    record
      { _â»Â¹ = _â»Â¹âˆ¼â‹†
      ; _â¦™_ = _â¦™âˆ¼â‹†_
      }


wkâˆ¼â‹† : âˆ€ {A Î“ Î} â†’ {Ïƒâ‚ Ïƒâ‚‚ : Î“ âŠ¢â‹† Î}
                 â†’ Ïƒâ‚ âˆ¼â‹† Ïƒâ‚‚
                 â†’ wkâ‚› {A} Ïƒâ‚ âˆ¼â‹† wkâ‚› Ïƒâ‚‚
wkâˆ¼â‹† âˆ…       = âˆ…
wkâˆ¼â‹† (Ï‡ , p) = wkâˆ¼â‹† Ï‡ , renâˆ¼ p

liftâˆ¼â‹† : âˆ€ {A Î“ Î} â†’ {Ïƒâ‚ Ïƒâ‚‚ : Î“ âŠ¢â‹† Î}
                   â†’ Ïƒâ‚ âˆ¼â‹† Ïƒâ‚‚
                   â†’ liftâ‚› {A} Ïƒâ‚ âˆ¼â‹† liftâ‚› Ïƒâ‚‚
liftâˆ¼â‹† âˆ…       = âˆ… , reflâˆ¼
liftâˆ¼â‹† (Ï‡ , p) = wkâˆ¼â‹† Ï‡ , renâˆ¼ p , reflâˆ¼


-- NOTE: Needs getâ‚› Ïƒâ‚ i âˆ¼ getâ‚› Ïƒâ‚‚ i
-- â—âˆ¼â‹† : âˆ€ {Î“ Î Îâ€²} â†’ {Ïƒâ‚ Ïƒâ‚‚ : Î“ âŠ¢â‹† Îâ€²} {Î· : Îâ€² âˆ‹â‹† Î}
--                  â†’ Ïƒâ‚ âˆ¼â‹† Ïƒâ‚‚ â†’ Ïƒâ‚ â— Î· âˆ¼â‹† Ïƒâ‚‚ â— Î·
-- â—âˆ¼â‹† {Î· = âˆ…}        Ï‡ = âˆ…
-- â—âˆ¼â‹† {Î· = [ Î· , i ]} Ï‡ = [ â—âˆ¼â‹† Ï‡ , {!!} ]

â—‘âˆ¼â‹† : âˆ€ {Î“ Î“â€² Î} â†’ {Î· : Î“â€² âˆ‹â‹† Î“} {Ïƒâ‚ Ïƒâ‚‚ : Î“ âŠ¢â‹† Î}
                 â†’ Ïƒâ‚ âˆ¼â‹† Ïƒâ‚‚
                 â†’ Î· â—‘ Ïƒâ‚ âˆ¼â‹† Î· â—‘ Ïƒâ‚‚
â—‘âˆ¼â‹† âˆ…       = âˆ…
â—‘âˆ¼â‹† (Ï‡ , p) = â—‘âˆ¼â‹† Ï‡ , subâˆ¼ p

-- NOTE: Needs a more general subâˆ¼
-- â—âˆ¼â‹† : âˆ€ {Î“ Î Î¦} â†’ {Ïƒâ‚ Ïƒâ‚‚ : Î“ âŠ¢â‹† Î} {Ï„â‚ Ï„â‚‚ : Î âŠ¢â‹† Î¦}
--                 â†’ Ïƒâ‚ âˆ¼â‹† Ïƒâ‚‚ â†’ Ï„â‚ âˆ¼â‹† Ï„â‚‚
--                 â†’ Ïƒâ‚ â— Ï„â‚ âˆ¼â‹† Ïƒâ‚‚ â— Ï„â‚‚
-- â—âˆ¼â‹† Ï‡â‚ âˆ…         = âˆ…
-- â—âˆ¼â‹† Ï‡â‚ [ Ï‡â‚‚ , p ] = [ â—âˆ¼â‹† Ï‡â‚ Ï‡â‚‚ , {!!} ]


--------------------------------------------------------------------------------
