{-# OPTIONS --no-positivity-check #-}

module STLC.Coquand.Normalisation where

open import STLC.Coquand.Substitution public


--------------------------------------------------------------------------------


record ğ” : Setâ‚ where
  field
    ğ’²      : Set

    ğ’¢      : ğ’² â†’ Set

    _âŠ’_    : ğ’² â†’ ğ’² â†’ Set

    idâ‚    : âˆ€ {w} â†’ w âŠ’ w

    _â—‡_    : âˆ€ {w wâ€² wâ€³} â†’ wâ€³ âŠ’ wâ€² â†’ wâ€² âŠ’ w â†’ wâ€³ âŠ’ w

    lidâ—‡   : âˆ€ {w wâ€²} â†’ (Î¾ : wâ€² âŠ’ w)
                      â†’ idâ‚ â—‡ Î¾ â‰¡ Î¾

    ridâ—‡   : âˆ€ {w wâ€²} â†’ (Î¾ : wâ€² âŠ’ w)
                      â†’ Î¾ â—‡ idâ‚ â‰¡ Î¾

    assocâ—‡ : âˆ€ {w wâ€² wâ€³ wâ€´} â†’ (Î¾â‚ : wâ€´ âŠ’ wâ€³) (Î¾â‚‚ : wâ€³ âŠ’ wâ€²) (Î¾â‚ƒ : wâ€² âŠ’ w)
                            â†’ Î¾â‚ â—‡ (Î¾â‚‚ â—‡ Î¾â‚ƒ) â‰¡ (Î¾â‚ â—‡ Î¾â‚‚) â—‡ Î¾â‚ƒ


module _ {{ğ”ª : ğ”}} where
  open ğ” ğ”ª


  infix 3 _âŠ©_
  data _âŠ©_ : ğ’² â†’ ğ’¯ â†’ Set
    where
      âŸ¦GâŸ§ : âˆ€ {w} â†’ (h : âˆ€ {wâ€²} â†’ (Î¾ : wâ€² âŠ’ w)
                                 â†’ ğ’¢ wâ€²)
                  â†’ w âŠ© âµ

      âŸ¦Æ›âŸ§ : âˆ€ {A B w} â†’ (h : âˆ€ {wâ€²} â†’ (Î¾ : wâ€² âŠ’ w) (a : wâ€² âŠ© A)
                                     â†’ wâ€² âŠ© B)
                      â†’ w âŠ© A â‡’ B


  âŸ¦gâŸ§âŸ¨_âŸ© : âˆ€ {w wâ€²} â†’ wâ€² âŠ’ w â†’ w âŠ© âµ â†’ ğ’¢ wâ€²
  âŸ¦gâŸ§âŸ¨ Î¾ âŸ© (âŸ¦GâŸ§ f) = f Î¾

  _âŸ¦âˆ™âŸ§âŸ¨_âŸ©_ : âˆ€ {A B w wâ€²} â†’ w âŠ© A â‡’ B â†’ wâ€² âŠ’ w â†’ wâ€² âŠ© A â†’ wâ€² âŠ© B
  (âŸ¦Æ›âŸ§ f) âŸ¦âˆ™âŸ§âŸ¨ Î¾ âŸ© a = f Î¾ a

  -- âŸ¦putáµ£âŸ§ canâ€™t be stated here
  -- âŸ¦getáµ£âŸ§ canâ€™t be stated here
  -- âŸ¦wkáµ£âŸ§ canâ€™t be stated here
  -- âŸ¦liftáµ£âŸ§ canâ€™t be stated here
  -- idâ‚ = âŸ¦idáµ£âŸ§

  -- acc = âŸ¦renâŸ§
  acc : âˆ€ {A w wâ€²} â†’ wâ€² âŠ’ w â†’ w âŠ© A â†’ wâ€² âŠ© A
  acc {âµ}      Î¾ f = âŸ¦GâŸ§ (Î» Î¾â€²   â†’ âŸ¦gâŸ§âŸ¨ Î¾â€² â—‡ Î¾ âŸ© f)
  acc {A â‡’ B} Î¾ f = âŸ¦Æ›âŸ§ (Î» Î¾â€² a â†’ f âŸ¦âˆ™âŸ§âŸ¨ Î¾â€² â—‡ Î¾ âŸ© a)

  -- âŸ¦wkâŸ§ canâ€™t be stated here
  -- _â—‡_ = _âŸ¦â—‹âŸ§_


--------------------------------------------------------------------------------


module _ {{ğ”ª : ğ”}} where
  open ğ” ğ”ª


  mutual
    data Eq : âˆ€ {A w} â†’ w âŠ© A â†’ w âŠ© A â†’ Set
      where
        eqâµ : âˆ€ {w} â†’ {fâ‚ fâ‚‚ : w âŠ© âµ}
                    â†’ (h : âˆ€ {wâ€²} â†’ (Î¾ : wâ€² âŠ’ w)
                                   â†’ âŸ¦gâŸ§âŸ¨ Î¾ âŸ© fâ‚ â‰¡ âŸ¦gâŸ§âŸ¨ Î¾ âŸ© fâ‚‚)
                    â†’ Eq fâ‚ fâ‚‚

        eqâŠƒ : âˆ€ {A B w} â†’ {fâ‚ fâ‚‚ : w âŠ© A â‡’ B}
                        â†’ (h : âˆ€ {wâ€²} â†’ (Î¾ : wâ€² âŠ’ w) {a : wâ€² âŠ© A} (u : Un a)
                                       â†’ Eq (fâ‚ âŸ¦âˆ™âŸ§âŸ¨ Î¾ âŸ© a) (fâ‚‚ âŸ¦âˆ™âŸ§âŸ¨ Î¾ âŸ© a))
                        â†’ Eq fâ‚ fâ‚‚

    data Un : âˆ€ {A w} â†’ w âŠ© A â†’ Set
      where
        unâµ : âˆ€ {w} â†’ {f : w âŠ© âµ}
                    â†’ Un f

        unâŠƒ : âˆ€ {A B w} â†’ {f : w âŠ© A â‡’ B}
                        â†’ (hâ‚ : âˆ€ {wâ€²} â†’ (Î¾ : wâ€² âŠ’ w)
                                           {a : wâ€² âŠ© A}
                                           (u : Un a)
                                        â†’ Un (f âŸ¦âˆ™âŸ§âŸ¨ Î¾ âŸ© a))
                        â†’ (hâ‚‚ : âˆ€ {wâ€²} â†’ (Î¾ : wâ€² âŠ’ w)
                                           {aâ‚ aâ‚‚ : wâ€² âŠ© A}
                                           (p : Eq aâ‚ aâ‚‚)
                                           (uâ‚ : Un aâ‚)
                                           (uâ‚‚ : Un aâ‚‚)
                                        â†’ Eq (f âŸ¦âˆ™âŸ§âŸ¨ Î¾ âŸ© aâ‚) (f âŸ¦âˆ™âŸ§âŸ¨ Î¾ âŸ© aâ‚‚))
                        â†’ (hâ‚ƒ : âˆ€ {wâ€² wâ€³} â†’ (Î¾â‚ : wâ€³ âŠ’ wâ€²)
                                              (Î¾â‚‚ : wâ€² âŠ’ w)
                                              {a : wâ€² âŠ© A}
                                              (u : Un a)
                                           â†’ Eq (acc Î¾â‚ (f âŸ¦âˆ™âŸ§âŸ¨ Î¾â‚‚ âŸ© a))
                                                 (f âŸ¦âˆ™âŸ§âŸ¨ Î¾â‚ â—‡ Î¾â‚‚ âŸ© (acc Î¾â‚ a)))
                        â†’ Un f


  reflEq : âˆ€ {A w} â†’ {a : w âŠ© A}
                   â†’ Un a
                   â†’ Eq a a
  reflEq unâµ            = eqâµ (Î» Î¾ â†’ refl)
  reflEq (unâŠƒ hâ‚ hâ‚‚ hâ‚ƒ) = eqâŠƒ (Î» Î¾ u â†’ reflEq (hâ‚ Î¾ u))

  _â»Â¹Eq : âˆ€ {A w} â†’ {aâ‚ aâ‚‚ : w âŠ© A}
                  â†’ Eq aâ‚ aâ‚‚
                  â†’ Eq aâ‚‚ aâ‚
  _â»Â¹Eq {âµ}      (eqâµ h) = eqâµ (Î» Î¾ â†’ h Î¾ â»Â¹)
  _â»Â¹Eq {A â‡’ B} (eqâŠƒ h) = eqâŠƒ (Î» Î¾ u â†’ h Î¾ u â»Â¹Eq)

  _â¦™Eq_ : âˆ€ {A w} â†’ {aâ‚ aâ‚‚ aâ‚ƒ : w âŠ© A}
                  â†’ Eq aâ‚ aâ‚‚ â†’ Eq aâ‚‚ aâ‚ƒ
                  â†’ Eq aâ‚ aâ‚ƒ
  _â¦™Eq_ {âµ}      (eqâµ hâ‚) (eqâµ hâ‚‚) = eqâµ (Î» Î¾ â†’ hâ‚ Î¾ â¦™ hâ‚‚ Î¾)
  _â¦™Eq_ {A â‡’ B} (eqâŠƒ hâ‚) (eqâŠƒ hâ‚‚) = eqâŠƒ (Î» Î¾ u â†’ hâ‚ Î¾ u â¦™Eq hâ‚‚ Î¾ u)


  instance
    perEq : âˆ€ {A w} â†’ PER (w âŠ© A) Eq
    perEq =
      record
        { _â»Â¹ = _â»Â¹Eq
        ; _â¦™_ = _â¦™Eq_
        }


  â‰¡â†’Eq : âˆ€ {A w} â†’ {aâ‚ aâ‚‚ : w âŠ© A} â†’ aâ‚ â‰¡ aâ‚‚ â†’ Un aâ‚ â†’ Eq aâ‚ aâ‚‚
  â‰¡â†’Eq refl u = reflEq u


--------------------------------------------------------------------------------


module _ {{ğ”ª : ğ”}} where
  open ğ” ğ”ª

  -- (congâŸ¦âˆ™âŸ§âŸ¨_âŸ©Eq)
  postulate
    congâŸ¦âˆ™âŸ§Eq : âˆ€ {A B w wâ€²} â†’ {fâ‚ fâ‚‚ : w âŠ© A â‡’ B} {aâ‚ aâ‚‚ : wâ€² âŠ© A}
                             â†’ (Î¾ : wâ€² âŠ’ w)
                             â†’ Eq fâ‚ fâ‚‚ â†’ Un fâ‚ â†’ Un fâ‚‚
                             â†’ Eq aâ‚ aâ‚‚ â†’ Un aâ‚ â†’ Un aâ‚‚
                             â†’ Eq (fâ‚ âŸ¦âˆ™âŸ§âŸ¨ Î¾ âŸ© aâ‚)
                                   (fâ‚‚ âŸ¦âˆ™âŸ§âŸ¨ Î¾ âŸ© aâ‚‚)

  congâŸ¦âˆ™âŸ§Un : âˆ€ {A B w wâ€²} â†’ {f : w âŠ© A â‡’ B} {a : wâ€² âŠ© A}
                           â†’ (Î¾ : wâ€² âŠ’ w) â†’ Un f â†’ Un a
                           â†’ Un (f âŸ¦âˆ™âŸ§âŸ¨ Î¾ âŸ© a)
  congâŸ¦âˆ™âŸ§Un Î¾ (unâŠƒ hâ‚ hâ‚‚ hâ‚ƒ) u = hâ‚ Î¾ u

  -- (congâ†‘âŸ¨_âŸ©Eq)
  postulate
    congaccEq : âˆ€ {A w wâ€²} â†’ {aâ‚ aâ‚‚ : w âŠ© A}
                           â†’ (Î¾ : wâ€² âŠ’ w) â†’ Eq aâ‚ aâ‚‚
                           â†’ Eq (acc Î¾ aâ‚) (acc Î¾ aâ‚‚)

  -- (congâ†‘âŸ¨_âŸ©ğ’°)
  postulate
    congaccUn : âˆ€ {A w wâ€²} â†’ {a : w âŠ© A}
                           â†’ (Î¾ : wâ€² âŠ’ w) â†’ Un a
                           â†’ Un (acc Î¾ a)

  -- (auxâ‚„â‚â‚)
  postulate
    lidaccEq : âˆ€ {A w} â†’ {a : w âŠ© A}
                       â†’ Un a
                       â†’ Eq (acc idâ‚ a) a

  -- (auxâ‚„â‚â‚‚)
  postulate
    accâ—‡Eq : âˆ€ {A w wâ€² wâ€³} â†’ {a : w âŠ© A}
                           â†’ (Î¾â‚ : wâ€³ âŠ’ wâ€²) (Î¾â‚‚ : wâ€² âŠ’ w) â†’ Un a
                           â†’ Eq (acc (Î¾â‚ â—‡ Î¾â‚‚) a)
                                 ((acc Î¾â‚ âˆ˜ acc Î¾â‚‚) a)

  -- (auxâ‚„â‚â‚ƒ)
  postulate
    accâŸ¦âˆ™âŸ§idEq : âˆ€ {A B w wâ€²} â†’ {f : w âŠ© A â‡’ B} {a : wâ€² âŠ© A}
                              â†’ (Î¾ : wâ€² âŠ’ w) â†’ Un f â†’ Un a
                              â†’ Eq (acc Î¾ f âŸ¦âˆ™âŸ§âŸ¨ idâ‚ âŸ© a)
                                    (f âŸ¦âˆ™âŸ§âŸ¨ Î¾ âŸ© a)

  accâŸ¦âˆ™âŸ§Eq : âˆ€ {A B w wâ€² wâ€³} â†’ {f : w âŠ© A â‡’ B} {a : wâ€² âŠ© A}
                             â†’ (Î¾â‚ : wâ€² âŠ’ w) (Î¾â‚‚ : wâ€³ âŠ’ wâ€²) â†’ Un f â†’ Un a
                             â†’ Eq (acc Î¾â‚ f âŸ¦âˆ™âŸ§âŸ¨ Î¾â‚‚ âŸ© acc Î¾â‚‚ a)
                                   (acc Î¾â‚‚ (f âŸ¦âˆ™âŸ§âŸ¨ Î¾â‚ âŸ© a))
  accâŸ¦âˆ™âŸ§Eq Î¾â‚ Î¾â‚‚ (unâŠƒ hâ‚ hâ‚‚ hâ‚ƒ) u = hâ‚ƒ Î¾â‚‚ Î¾â‚ u â»Â¹


--------------------------------------------------------------------------------


module _ {{ğ”ª : ğ”}} where
  open ğ” ğ”ª


  infix 3 _âŠ©â‹†_
  data _âŠ©â‹†_ : ğ’² â†’ ğ’ â†’ Set
    where
      âˆ…   : âˆ€ {w} â†’ w âŠ©â‹† âˆ…

      _,_ : âˆ€ {Î A w} â†’ (Ï : w âŠ©â‹† Î) (a : w âŠ© A) â†’
                         w âŠ©â‹† Î , A


  -- âŸ¦putâ‚›âŸ§ canâ€™t be stated here

  -- getáµ¥ = âŸ¦getâ‚›âŸ§ (lookup)
  getáµ¥ : âˆ€ {Î A w} â†’ w âŠ©â‹† Î â†’ Î âˆ‹ A â†’ w âŠ© A
  getáµ¥ (Ï , a) zero    = a
  getáµ¥ (Ï , a) (suc i) = getáµ¥ Ï i

  -- unwkáµ¥ â‰¡ âŸ¦unwkâ‚›âŸ§
  unwkáµ¥ : âˆ€ {Î A w} â†’ w âŠ©â‹† Î , A â†’ w âŠ©â‹† Î
  unwkáµ¥ (Ï , a) = Ï

  -- âŸ¦wkâ‚›âŸ§ canâ€™t be stated here
  -- âŸ¦liftâ‚›âŸ§ canâ€™t be stated here
  -- âŸ¦idâ‚›âŸ§ canâ€™t be stated here
  -- âŸ¦subâŸ§ canâ€™t be stated here
  -- âŸ¦cutâŸ§ canâ€™t be stated here
  -- _â—†_ canâ€™t be stated here


--------------------------------------------------------------------------------


module _ {{ğ”ª : ğ”}} where
  open ğ” ğ”ª

  -- (âŸ¦_â—‘_âŸ§ / â†‘âŸ¨_âŸ©âŠ©â‹†)
  _â¬—_ : âˆ€ {Î w wâ€²} â†’ wâ€² âŠ’ w â†’ w âŠ©â‹† Î â†’ wâ€² âŠ©â‹† Î
  Î¾ â¬— âˆ…       = âˆ…
  Î¾ â¬— (Ï , a) = Î¾ â¬— Ï , acc Î¾ a

  -- (âŸ¦_â—_âŸ§ / â†“âŸ¨_âŸ©âŠ©â‹†)
  _â¬–_ : âˆ€ {Î Îâ€² w} â†’ w âŠ©â‹† Îâ€² â†’ Îâ€² âˆ‹â‹† Î â†’ w âŠ©â‹† Î
  Ï â¬– âˆ…       = âˆ…
  Ï â¬– (Î· , i) = Ï â¬– Î· , getáµ¥ Ï i


--------------------------------------------------------------------------------


module _ {{ğ”ª : ğ”}} where
  open ğ” ğ”ª

  zapâ¬– : âˆ€ {Î Îâ€² A w} â†’ (Ï : w âŠ©â‹† Îâ€²) (Î· : Îâ€² âˆ‹â‹† Î) (a : w âŠ© A)
                      â†’ (Ï , a) â¬– wkáµ£ Î· â‰¡ Ï â¬– Î·
  zapâ¬– Ï âˆ…       a = refl
  zapâ¬– Ï (Î· , i) a = (_, getáµ¥ Ï i) & zapâ¬– Ï Î· a

  ridâ¬– : âˆ€ {Î w} â†’ (Ï : w âŠ©â‹† Î)
                 â†’ Ï â¬– idáµ£ â‰¡ Ï
  ridâ¬– âˆ…       = refl
  ridâ¬– (Ï , a) = (_, a) & ( zapâ¬– Ï idáµ£ a
                          â¦™ ridâ¬– Ï
                          )


--------------------------------------------------------------------------------


module _ {{ğ”ª : ğ”}} where
  open ğ” ğ”ª

  getâ¬– : âˆ€ {Î Îâ€² A w} â†’ (Ï : w âŠ©â‹† Îâ€²) (Î· : Îâ€² âˆ‹â‹† Î) (i : Î âˆ‹ A)
                      â†’ getáµ¥ (Ï â¬– Î·) i â‰¡ (getáµ¥ Ï âˆ˜ getáµ£ Î·) i
  getâ¬– Ï (Î· , j) zero    = refl
  getâ¬– Ï (Î· , j) (suc i) = getâ¬– Ï Î· i

  compâ¬–â—‹ : âˆ€ {Î Îâ€² Îâ€³ w} â†’ (Ï : w âŠ©â‹† Îâ€³) (Î·â‚ : Îâ€³ âˆ‹â‹† Îâ€²) (Î·â‚‚ : Îâ€² âˆ‹â‹† Î)
                         â†’ Ï â¬– (Î·â‚ â—‹ Î·â‚‚) â‰¡ (Ï â¬– Î·â‚) â¬– Î·â‚‚
  compâ¬–â—‹ Ïƒ Î·â‚ âˆ…        = refl
  compâ¬–â—‹ Ïƒ Î·â‚ (Î·â‚‚ , i) = _,_ & compâ¬–â—‹ Ïƒ Î·â‚ Î·â‚‚
                             âŠ— (getâ¬– Ïƒ Î·â‚ i â»Â¹)

  -- wkâ¬– canâ€™t be stated here
  -- liftâ¬– canâ€™t be stated here
  -- wkridâ¬– canâ€™t be stated here
  -- liftwkridâ¬– canâ€™t be stated here
  -- subâ¬– canâ€™t be stated here
  -- subwkâ¬– canâ€™t be stated here
  -- subliftâ¬– canâ€™t be stated here
  -- subliftwkâ¬– canâ€™t be stated here


--------------------------------------------------------------------------------


module _ {{ğ”ª : ğ”}} where
  open ğ” ğ”ª


  data Eqâ‹† : âˆ€ {Î w} â†’ w âŠ©â‹† Î â†’ w âŠ©â‹† Î â†’ Set
    where
      âˆ…   : âˆ€ {w} â†’ Eqâ‹† (âˆ… {w}) âˆ…

      _,_ : âˆ€ {Î A w} â†’ {Ïâ‚ Ïâ‚‚ : w âŠ©â‹† Î} {aâ‚ aâ‚‚ : w âŠ© A}
                      â†’ (Ï‡ : Eqâ‹† Ïâ‚ Ïâ‚‚) (p : Eq aâ‚ aâ‚‚)
                      â†’ Eqâ‹† (Ïâ‚ , aâ‚) (Ïâ‚‚ , aâ‚‚)

  data Unâ‹† : âˆ€ {Î w} â†’ w âŠ©â‹† Î â†’ Set
    where
      âˆ…   : âˆ€ {w} â†’ Unâ‹† (âˆ… {w})

      _,_ : âˆ€ {Î A w} â†’ {Ï : w âŠ©â‹† Î} {a : w âŠ© A}
                      â†’ (Ï… : Unâ‹† Ï) (u : Un a)
                      â†’ Unâ‹† (Ï , a)


  reflEqâ‹† : âˆ€ {Î w} â†’ {Ï : w âŠ©â‹† Î}
                    â†’ Unâ‹† Ï
                    â†’ Eqâ‹† Ï Ï
  reflEqâ‹† âˆ…       = âˆ…
  reflEqâ‹† (Ï… , u) = reflEqâ‹† Ï… , reflEq u

  _â»Â¹Eqâ‹† : âˆ€ {Î w} â†’ {Ïâ‚ Ïâ‚‚ : w âŠ©â‹† Î}
                   â†’ Eqâ‹† Ïâ‚ Ïâ‚‚
                   â†’ Eqâ‹† Ïâ‚‚ Ïâ‚
  âˆ…       â»Â¹Eqâ‹† = âˆ…
  (Ï‡ , p) â»Â¹Eqâ‹† = Ï‡ â»Â¹Eqâ‹† , p â»Â¹Eq

  _â¦™Eqâ‹†_ : âˆ€ {Î w} â†’ {Ïâ‚ Ïâ‚‚ Ïâ‚ƒ : w âŠ©â‹† Î}
                   â†’ Eqâ‹† Ïâ‚ Ïâ‚‚ â†’ Eqâ‹† Ïâ‚‚ Ïâ‚ƒ
                   â†’ Eqâ‹† Ïâ‚ Ïâ‚ƒ
  âˆ…        â¦™Eqâ‹† âˆ…        = âˆ…
  (Ï‡â‚ , p) â¦™Eqâ‹† (Ï‡â‚‚ , q) = Ï‡â‚ â¦™Eqâ‹† Ï‡â‚‚ , p â¦™Eq q


  instance
    perEqâ‹† : âˆ€ {Î w} â†’ PER (w âŠ©â‹† Î) Eqâ‹†
    perEqâ‹† =
      record
        { _â»Â¹ = _â»Â¹Eqâ‹†
        ; _â¦™_ = _â¦™Eqâ‹†_
        }


  â‰¡â†’Eqâ‹† : âˆ€ {Î w} â†’ {Ïâ‚ Ïâ‚‚ : w âŠ©â‹† Î} â†’ Ïâ‚ â‰¡ Ïâ‚‚ â†’ Unâ‹† Ïâ‚ â†’ Eqâ‹† Ïâ‚ Ïâ‚‚
  â‰¡â†’Eqâ‹† refl Ï… = reflEqâ‹† Ï…


--------------------------------------------------------------------------------


module _ {{ğ”ª : ğ”}} where
  open ğ” ğ”ª

  -- (conglookupEq)
  postulate
    conggetEq : âˆ€ {Î A w} â†’ {Ïâ‚ Ïâ‚‚ : w âŠ©â‹† Î}
                          â†’ (i : Î âˆ‹ A) â†’ Eqâ‹† Ïâ‚ Ïâ‚‚
                          â†’ Eq (getáµ¥ Ïâ‚ i) (getáµ¥ Ïâ‚‚ i)

  -- (congâ†‘âŸ¨_âŸ©Eqâ‹†)
  postulate
    congâ¬—Eqâ‹† : âˆ€ {Î w wâ€²} â†’ {Ïâ‚ Ïâ‚‚ : w âŠ©â‹† Î}
                          â†’ (Î¾ : wâ€² âŠ’ w) â†’ Eqâ‹† Ïâ‚ Ïâ‚‚
                          â†’ Eqâ‹† (Î¾ â¬— Ïâ‚) (Î¾ â¬— Ïâ‚‚)

  -- (congâ†“âŸ¨_âŸ©Eqâ‹†)
  postulate
    congâ¬–Eqâ‹† : âˆ€ {Î Îâ€² w} â†’ {Ïâ‚ Ïâ‚‚ : w âŠ©â‹† Îâ€²}
                          â†’ Eqâ‹† Ïâ‚ Ïâ‚‚ â†’ (Î· : Îâ€² âˆ‹â‹† Î)
                          â†’ Eqâ‹† (Ïâ‚ â¬– Î·) (Ïâ‚‚ â¬– Î·)

  -- (conglookupğ’°)
  postulate
    conggetUn : âˆ€ {Î A w} â†’ {Ï : w âŠ©â‹† Î}
                          â†’ (i : Î âˆ‹ A) â†’ Unâ‹† Ï
                          â†’ Un (getáµ¥ Ï i)

  -- (congâ†‘âŸ¨_âŸ©ğ’°â‹†)
  postulate
    congâ¬—Unâ‹† : âˆ€ {Î w wâ€²} â†’ {Ï : w âŠ©â‹† Î}
                          â†’ (Î¾ : wâ€² âŠ’ w) â†’ Unâ‹† Ï
                          â†’ Unâ‹† (Î¾ â¬— Ï)

  -- (congâ†“âŸ¨_âŸ©ğ’°â‹†)
  postulate
    congâ¬–Unâ‹† : âˆ€ {Î Îâ€² w} â†’ {Ï : w âŠ©â‹† Îâ€²}
                          â†’ (Î· : Îâ€² âˆ‹â‹† Î) â†’ Unâ‹† Ï
                          â†’ Unâ‹† (Ï â¬– Î·)


--------------------------------------------------------------------------------


module _ {{ğ”ª : ğ”}} where
  open ğ” ğ”ª

  -- (auxâ‚„â‚‚â‚)
  postulate
    getâ¬–Eq : âˆ€ {Î Îâ€² A w} â†’ {Ï : w âŠ©â‹† Îâ€²}
                          â†’ (Î· : Îâ€² âˆ‹â‹† Î) (i : Îâ€² âˆ‹ A) (j : Î âˆ‹ A) â†’ Unâ‹† Ï
                          â†’ Eq (getáµ¥ (Ï â¬– Î·) j)
                                (getáµ¥ Ï i)

  -- (conglookupâ†‘âŸ¨_âŸ©Eq)
  postulate
    getâ¬—Eq : âˆ€ {Î A w wâ€²} â†’ {Ï : w âŠ©â‹† Î}
                          â†’ (Î¾ : wâ€² âŠ’ w) (i : Î âˆ‹ A) â†’ Unâ‹† Ï
                          â†’ Eq (getáµ¥ (Î¾ â¬— Ï) i)
                                (acc Î¾ (getáµ¥ Ï i))

  -- (auxâ‚„â‚‚â‚ƒ)
  postulate
    zapâ¬–Eqâ‹† : âˆ€ {Î Îâ€² A w} â†’ {Ï : w âŠ©â‹† Îâ€²} {a : w âŠ© A}
                           â†’ (Î·â‚ : Îâ€² , A âˆ‹â‹† Î) (Î·â‚‚ : Îâ€² âˆ‹â‹† Î) â†’ Unâ‹† Ï
                           â†’ Eqâ‹† ((Ï , a) â¬– Î·â‚)
                                  (Ï â¬– Î·â‚‚)

  -- (auxâ‚„â‚‚â‚„)
  postulate
    ridâ¬–Eqâ‹† : âˆ€ {Î w} â†’ {Ï : w âŠ©â‹† Î}
                      â†’ Unâ‹† Ï
                      â†’ Eqâ‹† (Ï â¬– idáµ£) Ï

  -- (auxâ‚„â‚‚â‚…)
  postulate
    lidâ¬—Eqâ‹† : âˆ€ {Î w} â†’ {Ï : w âŠ©â‹† Î}
                      â†’ Unâ‹† Ï
                      â†’ Eqâ‹† (idâ‚ â¬— Ï) Ï

  -- (auxâ‚„â‚‚â‚†)
  postulate
    compâ¬–â—‹Eqâ‹† : âˆ€ {Î Îâ€² Îâ€³ w} â†’ {Ï : w âŠ©â‹† Îâ€³}
                              â†’ (Î·â‚ : Îâ€³ âˆ‹â‹† Îâ€²) (Î·â‚‚ : Îâ€² âˆ‹â‹† Î) â†’ Unâ‹† Ï
                              â†’ Eqâ‹† (Ï â¬– (Î·â‚ â—‹ Î·â‚‚))
                                     ((Ï â¬– Î·â‚) â¬– Î·â‚‚)

  -- (auxâ‚„â‚‚â‚‡)
  postulate
    compâ¬—â—‡Eqâ‹† : âˆ€ {Î w wâ€² wâ€³} â†’ {Ï : w âŠ©â‹† Î}
                              â†’ (Î¾â‚ : wâ€³ âŠ’ wâ€²) (Î¾â‚‚ : wâ€² âŠ’ w) â†’ Unâ‹† Ï
                              â†’ Eqâ‹† (Î¾â‚ â¬— (Î¾â‚‚ â¬— Ï))
                                     ((Î¾â‚ â—‡ Î¾â‚‚) â¬— Ï)

  -- (auxâ‚„â‚‚â‚ˆ)
  postulate
    compâ¬—â¬–Eqâ‹† : âˆ€ {Î Îâ€² w wâ€²} â†’ {Ï : w âŠ©â‹† Îâ€²}
                              â†’ (Î¾ : wâ€² âŠ’ w) (Î· : Îâ€² âˆ‹â‹† Î) â†’ Unâ‹† Ï
                              â†’ Eqâ‹† (Î¾ â¬— (Ï â¬– Î·))
                                     ((Î¾ â¬— Ï) â¬– Î·)


--------------------------------------------------------------------------------


module _ {{ğ”ª : ğ”}} where
  open ğ” ğ”ª

  âŸ¦_âŸ§ : âˆ€ {Î A w} â†’ Î âŠ¢ A â†’ w âŠ©â‹† Î â†’ w âŠ© A
  âŸ¦ ` i âŸ§   Ï = getáµ¥ Ï i
  âŸ¦ Æ› M âŸ§   Ï = âŸ¦Æ›âŸ§ (Î» Î¾ a â†’ âŸ¦ M âŸ§ (Î¾ â¬— Ï , a))
  âŸ¦ M âˆ™ N âŸ§ Ï = âŸ¦ M âŸ§ Ï âŸ¦âˆ™âŸ§âŸ¨ idâ‚ âŸ© âŸ¦ N âŸ§ Ï

  âŸ¦_âŸ§â‹† : âˆ€ {Î Î¦ w} â†’ Î âŠ¢â‹† Î¦ â†’ w âŠ©â‹† Î â†’ w âŠ©â‹† Î¦
  âŸ¦ âˆ… âŸ§â‹†     Ï = âˆ…
  âŸ¦ Ïƒ , M âŸ§â‹† Ï = âŸ¦ Ïƒ âŸ§â‹† Ï , âŸ¦ M âŸ§ Ï


--------------------------------------------------------------------------------


instance
  canon : ğ”
  canon = record
    { ğ’²      = ğ’
    ; ğ’¢      = _âŠ¢ âµ
    ; _âŠ’_    = _âˆ‹â‹†_
    ; idâ‚    = idáµ£
    ; _â—‡_    = _â—‹_
    ; lidâ—‡   = lidâ—‹
    ; ridâ—‡   = ridâ—‹
    ; assocâ—‡ = assocâ—‹
    }


mutual
  reify : âˆ€ {A Î“} â†’ Î“ âŠ© A â†’ Î“ âŠ¢ A
  reify {âµ}      f = âŸ¦gâŸ§âŸ¨ idáµ£ âŸ© f
  reify {A â‡’ B} f = Æ› (reify (f âŸ¦âˆ™âŸ§âŸ¨ wkáµ£ idáµ£ âŸ© âŸª` zero âŸ«))

  âŸª_âŸ« : âˆ€ {A Î“} â†’ (âˆ€ {Î“â€²} â†’ Î“â€² âˆ‹â‹† Î“ â†’ Î“â€² âŠ¢ A) â†’ Î“ âŠ© A
  âŸª_âŸ« {âµ}      f = âŸ¦GâŸ§ (Î» Î·   â†’ f Î·)
  âŸª_âŸ« {A â‡’ B} f = âŸ¦Æ›âŸ§ (Î» Î· a â†’ âŸª (Î» Î·â€² â†’ f (Î·â€² â—‹ Î·) âˆ™ reify (acc Î·â€² a)) âŸ«)

  âŸª`_âŸ« : âˆ€ {Î“ A} â†’ Î“ âˆ‹ A â†’ Î“ âŠ© A
  âŸª` i âŸ« = âŸª (Î» Î· â†’ ren Î· (` i)) âŸ«

postulate
  auxâ‚„â‚„â‚ : âˆ€ {A Î“} â†’ (fâ‚ fâ‚‚ : âˆ€ {Î“â€²} â†’ Î“â€² âˆ‹â‹† Î“ â†’ Î“â€² âŠ¢ A)
                   â†’ (âˆ€ {Î“â€²} â†’ (Î· : Î“â€² âˆ‹â‹† Î“) â†’ fâ‚ Î· â‰¡ fâ‚‚ Î·)
                   â†’ Eq (âŸª fâ‚ âŸ«) (âŸª fâ‚‚ âŸ«)

postulate
  auxâ‚„â‚„â‚‚ : âˆ€ {A Î“ Î“â€²} â†’ (Î· : Î“â€² âˆ‹â‹† Î“) (f : (âˆ€ {Î“â€²} â†’ Î“â€² âˆ‹â‹† Î“ â†’ Î“â€² âŠ¢ A))
                      â†’ Eq (acc Î· âŸª f âŸ«) (âŸª (Î» Î·â€² â†’ f (Î·â€² â—‹ Î·)) âŸ«)


--------------------------------------------------------------------------------


-- Theorem 1.
mutual
  postulate
    thmâ‚ : âˆ€ {Î“ A} â†’ {aâ‚ aâ‚‚ : Î“ âŠ© A}
                   â†’ Eq aâ‚ aâ‚‚
                   â†’ reify aâ‚ â‰¡ reify aâ‚‚

  postulate
    âŸª`_âŸ«áµ¤ : âˆ€ {Î“ A} â†’ (i : Î“ âˆ‹ A)
                    â†’ Un (âŸª` i âŸ«)

  postulate
    auxâ‚„â‚„â‚ƒ : âˆ€ {A Î“} â†’ (f : âˆ€ {Î“â€²} â†’ Î“â€² âˆ‹â‹† Î“ â†’ Î“â€² âŠ¢ A)
                     â†’ Un (âŸª f âŸ«)


--------------------------------------------------------------------------------


âŒŠ_âŒ‹áµ¥ : âˆ€ {Î“ Î“â€²} â†’ Î“â€² âˆ‹â‹† Î“ â†’ Î“â€² âŠ©â‹† Î“
âŒŠ âˆ… âŒ‹áµ¥     = âˆ…
âŒŠ Î· , i âŒ‹áµ¥ = âŒŠ Î· âŒ‹áµ¥ , âŸª` i âŸ«

idáµ¥ : âˆ€ {Î“} â†’ Î“ âŠ©â‹† Î“
idáµ¥ = âŒŠ idáµ£ âŒ‹áµ¥


nf : âˆ€ {Î“ A} â†’ Î“ âŠ¢ A â†’ Î“ âŠ¢ A
nf M = reify (âŸ¦ M âŸ§ idáµ¥)


-- Corollary 1.
postulate
  corâ‚ : âˆ€ {Î“ A} â†’ (Mâ‚ Mâ‚‚ : Î“ âŠ¢ A) â†’ Eq (âŸ¦ Mâ‚ âŸ§ idáµ¥) (âŸ¦ Mâ‚‚ âŸ§ idáµ¥)
                 â†’ nf Mâ‚ â‰¡ nf Mâ‚‚


--------------------------------------------------------------------------------
