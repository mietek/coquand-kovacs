module STLC.Coquand.Renaming where

open import STLC.Syntax public
open import Category


--------------------------------------------------------------------------------


-- Renamings
infix 4 _âˆ‹â‹†_
data _âˆ‹â‹†_ : ğ’ â†’ ğ’ â†’ Set
  where
    âˆ…   : âˆ€ {Î“} â†’ Î“ âˆ‹â‹† âˆ…

    _,_ : âˆ€ {Î“ Î“â€² A} â†’ (Î· : Î“â€² âˆ‹â‹† Î“) (i : Î“â€² âˆ‹ A)
                     â†’ Î“â€² âˆ‹â‹† Î“ , A


putáµ£ : âˆ€ {Î“ Î“â€²} â†’ (âˆ€ {A} â†’ Î“ âˆ‹ A â†’ Î“â€² âˆ‹ A) â†’ Î“â€² âˆ‹â‹† Î“
putáµ£ {âˆ…}     f = âˆ…
putáµ£ {Î“ , A} f = putáµ£ (Î» i â†’ f (suc i)) , f 0

getáµ£ : âˆ€ {Î“ Î“â€² A} â†’ Î“â€² âˆ‹â‹† Î“ â†’ Î“ âˆ‹ A â†’ Î“â€² âˆ‹ A
getáµ£ (Î· , i) zero    = i
getáµ£ (Î· , i) (suc j) = getáµ£ Î· j

wkáµ£ : âˆ€ {A Î“ Î“â€²} â†’ Î“â€² âˆ‹â‹† Î“ â†’ Î“â€² , A âˆ‹â‹† Î“
wkáµ£ âˆ…       = âˆ…
wkáµ£ (Î· , i) = wkáµ£ Î· , suc i

liftáµ£ : âˆ€ {A Î“ Î“â€²} â†’ Î“â€² âˆ‹â‹† Î“ â†’ Î“â€² , A âˆ‹â‹† Î“ , A
liftáµ£ Î· = wkáµ£ Î· , 0

idáµ£ : âˆ€ {Î“} â†’ Î“ âˆ‹â‹† Î“
idáµ£ {âˆ…}     = âˆ…
idáµ£ {Î“ , A} = liftáµ£ idáµ£

ren : âˆ€ {Î“ Î“â€² A} â†’ Î“â€² âˆ‹â‹† Î“ â†’ Î“ âŠ¢ A â†’ Î“â€² âŠ¢ A
ren Î· (` i)   = ` (getáµ£ Î· i)
ren Î· (Æ› M)   = Æ› (ren (liftáµ£ Î·) M)
ren Î· (M âˆ™ N) = ren Î· M âˆ™ ren Î· N

wk : âˆ€ {B Î“ A} â†’ Î“ âŠ¢ A â†’ Î“ , B âŠ¢ A
wk M = ren (wkáµ£ idáµ£) M

-- NOTE: _â—‹_ = getáµ£â‹†
_â—‹_ : âˆ€ {Î“ Î“â€² Î“â€³} â†’ Î“â€³ âˆ‹â‹† Î“â€² â†’ Î“â€² âˆ‹â‹† Î“ â†’ Î“â€³ âˆ‹â‹† Î“
Î·â‚ â—‹ âˆ…        = âˆ…
Î·â‚ â—‹ (Î·â‚‚ , i) = Î·â‚ â—‹ Î·â‚‚ , getáµ£ Î·â‚ i


--------------------------------------------------------------------------------


-- (wkgetáµ£)
natgetáµ£ : âˆ€ {Î“ Î“â€² A B} â†’ (Î· : Î“â€² âˆ‹â‹† Î“) (i : Î“ âˆ‹ A)
                       â†’ getáµ£ (wkáµ£ {B} Î·) i â‰¡ (suc âˆ˜ getáµ£ Î·) i
natgetáµ£ (Î· , j) zero    = refl
natgetáµ£ (Î· , j) (suc i) = natgetáµ£ Î· i

idgetáµ£ : âˆ€ {Î“ A} â†’ (i : Î“ âˆ‹ A)
                 â†’ getáµ£ idáµ£ i â‰¡ i
idgetáµ£ zero    = refl
idgetáµ£ (suc i) = natgetáµ£ idáµ£ i
               â¦™ suc & idgetáµ£ i

idren : âˆ€ {Î“ A} â†’ (M : Î“ âŠ¢ A)
                â†’ ren idáµ£ M â‰¡ M
idren (` i)   = ` & idgetáµ£ i
idren (Æ› M)   = Æ› & idren M
idren (M âˆ™ N) = _âˆ™_ & idren M
                    âŠ— idren N


--------------------------------------------------------------------------------


zapâ—‹ : âˆ€ {Î“ Î“â€² Î“â€³ A} â†’ (Î·â‚ : Î“â€³ âˆ‹â‹† Î“â€²) (Î·â‚‚ : Î“â€² âˆ‹â‹† Î“) (i : Î“â€³ âˆ‹ A)
                     â†’ (Î·â‚ , i) â—‹ wkáµ£ Î·â‚‚ â‰¡ Î·â‚ â—‹ Î·â‚‚
zapâ—‹ Î·â‚ âˆ…        i = refl
zapâ—‹ Î·â‚ (Î·â‚‚ , j) i = (_, getáµ£ Î·â‚ j) & zapâ—‹ Î·â‚ Î·â‚‚ i

lidâ—‹ : âˆ€ {Î“ Î“â€²} â†’ (Î· : Î“â€² âˆ‹â‹† Î“)
                â†’ idáµ£ â—‹ Î· â‰¡ Î·
lidâ—‹ âˆ…       = refl
lidâ—‹ (Î· , i) = _,_ & lidâ—‹ Î·
                   âŠ— idgetáµ£ i

ridâ—‹ : âˆ€ {Î“ Î“â€²} â†’ (Î· : Î“â€² âˆ‹â‹† Î“)
                â†’ Î· â—‹ idáµ£ â‰¡ Î·
ridâ—‹ {âˆ…}     âˆ…       = refl
ridâ—‹ {Î“ , A} (Î· , i) = (_, i) & ( zapâ—‹ Î· idáµ£ i
                                â¦™ ridâ—‹ Î·
                                )


--------------------------------------------------------------------------------


getâ—‹ : âˆ€ {Î“ Î“â€² Î“â€³ A} â†’ (Î·â‚ : Î“â€³ âˆ‹â‹† Î“â€²) (Î·â‚‚ : Î“â€² âˆ‹â‹† Î“) (i : Î“ âˆ‹ A)
                     â†’ getáµ£ (Î·â‚ â—‹ Î·â‚‚) i â‰¡ (getáµ£ Î·â‚ âˆ˜ getáµ£ Î·â‚‚) i
getâ—‹ Î·â‚ (Î·â‚‚ , j) zero    = refl
getâ—‹ Î·â‚ (Î·â‚‚ , j) (suc i) = getâ—‹ Î·â‚ Î·â‚‚ i

wkâ—‹ : âˆ€ {Î“ Î“â€² Î“â€³ A} â†’ (Î·â‚ : Î“â€³ âˆ‹â‹† Î“â€²) (Î·â‚‚ : Î“â€² âˆ‹â‹† Î“)
                    â†’ wkáµ£ {A} (Î·â‚ â—‹ Î·â‚‚) â‰¡ wkáµ£ Î·â‚ â—‹ Î·â‚‚
wkâ—‹ Î·â‚ âˆ…        = refl
wkâ—‹ Î·â‚ (Î·â‚‚ , i) = _,_ & wkâ—‹ Î·â‚ Î·â‚‚
                      âŠ— (natgetáµ£ Î·â‚ i â»Â¹)

liftâ—‹ : âˆ€ {Î“ Î“â€² Î“â€³ A} â†’ (Î·â‚ : Î“â€³ âˆ‹â‹† Î“â€²) (Î·â‚‚ : Î“â€² âˆ‹â‹† Î“)
                      â†’ liftáµ£ {A} (Î·â‚ â—‹ Î·â‚‚) â‰¡ liftáµ£ Î·â‚ â—‹ liftáµ£ Î·â‚‚
liftâ—‹ Î·â‚ Î·â‚‚ = (_, 0) & ( wkâ—‹ Î·â‚ Î·â‚‚
                          â¦™ (zapâ—‹ (wkáµ£ Î·â‚) Î·â‚‚ 0 â»Â¹)
                          )

wklidâ—‹ : âˆ€ {Î“ Î“â€² A} â†’ (Î· : Î“â€² âˆ‹â‹† Î“)
                    â†’ wkáµ£ {A} idáµ£ â—‹ Î· â‰¡ wkáµ£ Î·
wklidâ—‹ Î· = wkâ—‹ idáµ£ Î· â»Â¹
         â¦™ wkáµ£ & lidâ—‹ Î·

wkridâ—‹ : âˆ€ {Î“ Î“â€² A} â†’ (Î· : Î“â€² âˆ‹â‹† Î“)
                    â†’ wkáµ£ {A} Î· â—‹ idáµ£ â‰¡ wkáµ£ Î·
wkridâ—‹ Î· = wkâ—‹ Î· idáµ£ â»Â¹
         â¦™ wkáµ£ & ridâ—‹ Î·

liftwkridâ—‹ : âˆ€ {Î“ Î“â€² A} â†’ (Î· : Î“â€² âˆ‹â‹† Î“)
                        â†’ liftáµ£ {A} Î· â—‹ wkáµ£ idáµ£ â‰¡ wkáµ£ Î·
liftwkridâ—‹ Î· = zapâ—‹ (wkáµ£ Î·) idáµ£ 0 â¦™ wkridâ—‹ Î·

mutual
  renâ—‹ : âˆ€ {Î“ Î“â€² Î“â€³ A} â†’ (Î·â‚ : Î“â€³ âˆ‹â‹† Î“â€²) (Î·â‚‚ : Î“â€² âˆ‹â‹† Î“) (M : Î“ âŠ¢ A)
                       â†’ ren (Î·â‚ â—‹ Î·â‚‚) M â‰¡ (ren Î·â‚ âˆ˜ ren Î·â‚‚) M
  renâ—‹ Î·â‚ Î·â‚‚ (` i)   = ` & getâ—‹ Î·â‚ Î·â‚‚ i
  renâ—‹ Î·â‚ Î·â‚‚ (Æ› M)   = Æ› & renliftâ—‹ Î·â‚ Î·â‚‚ M
  renâ—‹ Î·â‚ Î·â‚‚ (M âˆ™ N) = _âˆ™_ & renâ—‹ Î·â‚ Î·â‚‚ M
                           âŠ— renâ—‹ Î·â‚ Î·â‚‚ N

  renliftâ—‹ : âˆ€ {Î“ Î“â€² Î“â€³ A B} â†’ (Î·â‚ : Î“â€³ âˆ‹â‹† Î“â€²) (Î·â‚‚ : Î“â€² âˆ‹â‹† Î“) (M : Î“ , B âŠ¢ A)
                             â†’ ren (liftáµ£ {B} (Î·â‚ â—‹ Î·â‚‚)) M â‰¡
                                (ren (liftáµ£ Î·â‚) âˆ˜ ren (liftáµ£ Î·â‚‚)) M
  renliftâ—‹ Î·â‚ Î·â‚‚ M = (Î» Î·â€² â†’ ren Î·â€² M) & liftâ—‹ Î·â‚ Î·â‚‚
                   â¦™ renâ—‹ (liftáµ£ Î·â‚) (liftáµ£ Î·â‚‚) M

renwkâ—‹ : âˆ€ {Î“ Î“â€² Î“â€³ A B} â†’ (Î·â‚ : Î“â€³ âˆ‹â‹† Î“â€²) (Î·â‚‚ : Î“â€² âˆ‹â‹† Î“) (M : Î“ âŠ¢ A)
                         â†’ ren (wkáµ£ {B} (Î·â‚ â—‹ Î·â‚‚)) M â‰¡
                            (ren (wkáµ£ Î·â‚) âˆ˜ ren Î·â‚‚) M
renwkâ—‹ Î·â‚ Î·â‚‚ M = (Î» Î·â€² â†’ ren Î·â€² M) & wkâ—‹ Î·â‚ Î·â‚‚
               â¦™ renâ—‹ (wkáµ£ Î·â‚) Î·â‚‚ M

renliftwkâ—‹ : âˆ€ {Î“ Î“â€² Î“â€³ A B} â†’ (Î·â‚ : Î“â€³ âˆ‹â‹† Î“â€²) (Î·â‚‚ : Î“â€² âˆ‹â‹† Î“) (M : Î“ âŠ¢ A)
                             â†’ ren (wkáµ£ {B} (Î·â‚ â—‹ Î·â‚‚)) M â‰¡
                                (ren (liftáµ£ Î·â‚) âˆ˜ ren (wkáµ£ Î·â‚‚)) M
renliftwkâ—‹ Î·â‚ Î·â‚‚ M = (Î» Î·â€² â†’ ren Î·â€² M) & ( wkâ—‹ Î·â‚ Î·â‚‚
                                          â¦™ zapâ—‹ (wkáµ£ Î·â‚) Î·â‚‚ 0 â»Â¹
                                          )
                   â¦™ renâ—‹ (liftáµ£ Î·â‚) (wkáµ£ Î·â‚‚) M


--------------------------------------------------------------------------------


assocâ—‹ : âˆ€ {Î“ Î“â€² Î“â€³ Î“â€´} â†’ (Î·â‚ : Î“â€´ âˆ‹â‹† Î“â€³) (Î·â‚‚ : Î“â€³ âˆ‹â‹† Î“â€²) (Î·â‚ƒ : Î“â€² âˆ‹â‹† Î“)
                        â†’ Î·â‚ â—‹ (Î·â‚‚ â—‹ Î·â‚ƒ) â‰¡ (Î·â‚ â—‹ Î·â‚‚) â—‹ Î·â‚ƒ
assocâ—‹ Î·â‚ Î·â‚‚ âˆ…        = refl
assocâ—‹ Î·â‚ Î·â‚‚ (Î·â‚ƒ , i) = _,_ & assocâ—‹ Î·â‚ Î·â‚‚ Î·â‚ƒ
                            âŠ— (getâ—‹ Î·â‚ Î·â‚‚ i â»Â¹)


--------------------------------------------------------------------------------


ğ—¥ğ—²ğ—» : Category ğ’ _âˆ‹â‹†_
ğ—¥ğ—²ğ—» =
  record
    { idâ‚“    = idáµ£
    ; _â‹„_    = flip _â—‹_
    ; lidâ‹„   = ridâ—‹
    ; ridâ‹„   = lidâ—‹
    ; assocâ‹„ = assocâ—‹
    }


getáµ£Psh : ğ’¯ â†’ Presheafâ‚€ ğ—¥ğ—²ğ—»
getáµ£Psh A =
  record
    { Fâ‚“  = _âˆ‹ A
    ; F   = getáµ£
    ; idF = fext! idgetáµ£
    ; Fâ‹„  = Î» Î·â‚‚ Î·â‚ â†’ fext! (getâ—‹ Î·â‚ Î·â‚‚)
    }

renPsh : ğ’¯ â†’ Presheafâ‚€ ğ—¥ğ—²ğ—»
renPsh A =
  record
    { Fâ‚“  = _âŠ¢ A
    ; F   = ren
    ; idF = fext! idren
    ; Fâ‹„  = Î» Î·â‚‚ Î·â‚ â†’ fext! (renâ—‹ Î·â‚ Î·â‚‚)
    }


--------------------------------------------------------------------------------
